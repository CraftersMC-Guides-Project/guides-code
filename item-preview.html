<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Preview - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    .top { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    .login-btn { background-color: #5865F2; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; transition: bottom 0.5s ease-in-out; z-index: 10001; }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
    .private-item-highlight { border: 2px dashed #ff9800; background-color: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px; }

    /* Profile card styles omitted for brevity (same as item.html) */

    /* New styles for update section */
    .update-section {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
    }
    .update-section input {
      padding: 8px;
      width: 80%;
      border-radius: 6px;
      border: 1px solid #bbb;
      margin-bottom: 10px;
    }
    .update-section button {
      display: inline-block;
      padding: 8px 15px;
      background: #2d8831;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    .update-section button:hover {
      background: #256b27;
    }
  </style>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <!-- Profile Card (same as item.html) -->
  <a href="/profile.html" class="profile-card" id="profile-card">
    <img id="user-avatar" src="https://placehold.co/110x110/dddddd/333333?text=...&font=inter" alt="User Avatar" />
    <div id="user-details">
        <div id="user-name">Loading...</div>
        <div id="user-tag"></div>
    </div>
  </a>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="item-material-icons" id="scrollToTopBtn">north</span>

  <div class="item-container" id="itemDetails"><p>Loading item details...</p></div>

  <div class="item-nav-buttons">
    <button id="prevItemBtn" class="btn" type="button">&larr; Previous</button>
    <button id="nextItemBtn" class="btn" type="button">Next &rarr;</button>
  </div>

  <!-- New Update Section (only for devs) -->
  <div id="updateSection" class="update-section" style="display:none;">
    <h3>Update Price</h3>
    <input type="text" id="updateInput" placeholder='Example: diamond_sword: [null, 1500, 2000] or URL'>
    <br>
    <button onclick="sendUpdate()">Send Update</button>
  </div>

  <div id="footer"></div>

  <script>
    let isDevUser = false;
    let allItems = [];
    let currentItem = null;

    function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift()); return ''; }

    async function loadUserInfo() {
      // same as item.html
      // after determining dev role, show update section
      try {
        const storedUserCookie = getCookie('discordUser');
        if (!storedUserCookie) return;
        const loggedInUser = JSON.parse(storedUserCookie);
        const userId = loggedInUser.id;

        let devIds = [];
        try {
          const res = await fetch('/devs.txt');
          if (res.ok) {
            const text = await res.text();
            devIds = text.split('\n').map(id => id.trim()).filter(id => id);
          }
        } catch(e) {}

        if (devIds.includes(userId)) {
          isDevUser = true;
          document.getElementById("updateSection").style.display = "block";
        }
      } catch (err) { console.error(err); }
    }

    async function fetchAllItems() { try { const res = await fetch("market/market.txt"); allItems = await res.json(); } catch (e) { console.error("Could not fetch market.txt", e); } }

    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');
      if (!itemId) return;

      try {
        const [marketRes, pricesRes] = await Promise.all([
          fetch('market/market.txt'),
          fetch('market/mprices.txt')
        ]);
        const items = JSON.parse(await marketRes.text());
        const pricesData = await pricesRes.text();

        currentItem = items.find(i => i.id === itemId);
        if (!currentItem) {
          document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`;
          return;
        }

        const pricesMap = new Map();
        pricesData.split('\n').forEach(line => {
          const [id, arrStr] = line.split(':').map(p => p.trim());
          if (id && arrStr) {
            try {
              const parsed = JSON.parse(arrStr);
              if (Array.isArray(parsed) && parsed.length >= 2) {
                pricesMap.set(id, parsed[1]);
              }
            } catch {}
          }
        });

        const marketPrice = pricesMap.get(currentItem.id) ?? currentItem.price ?? "N/A";
        document.getElementById('itemDetails').innerHTML =
          `<h1>${currentItem.name}</h1>
           <p><strong>ID:</strong> ${currentItem.id}</p>
           <p><strong>Market Price:</strong> ${formatPrice(marketPrice)}</p>`;
      } catch (err) {
        console.error(err);
      }
    }

    async function sendUpdate() {
      const input = document.getElementById("updateInput").value.trim();
      if (!input) {
        showToast("Please enter update details or URL", "error");
        return;
      }

      try {
        const res = await fetch("https://data-manager.roumakdatta.workers.dev/updatePrices", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ source: input })
        });

        const data = await res.json();
        if (res.ok) {
          showToast("Update sent successfully!", "success");
        } else {
          showToast(data.error || "Failed to update", "error");
        }
      } catch (e) {
        console.error(e);
        showToast("Network error while sending update", "error");
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 100);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
    }

    function formatPrice(price) {
      if (price === "N/A" || price === "NAN" || price === null || price === undefined) {
        return `<span>N/A</span>`;
      }
      return `${Number(price).toLocaleString()} <img src="img/coin.png">`;
    }

    document.getElementById("prevItemBtn").addEventListener("click", () => { window.history.back(); });
    document.getElementById("nextItemBtn").addEventListener("click", () => { window.history.forward(); });

    async function initializePage() { 
      await loadUserInfo();
      await fetchAllItems(); 
      await loadItemDetails(); 
    }
    initializePage();
  </script>
</body>
</html>
