<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Category Items</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="css/essential.css">
  <link rel="stylesheet" href="css/categories.css">
  <style>
    img[alt="Sky Canvas"] {
      filter: brightness(90%) saturate(95%);
    }
  </style>
  <script src="js/script.js"></script>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="material-icons" id="scrollToTopBtn">north</span>

  <div id="categoryFilter" style="display: flex; gap: 10px; justify-content: center; margin: 5rem 0; flex-wrap: wrap;">
    <button class="btn cat-filter-btn active" data-nature="all">All</button>
    <button class="btn cat-filter-btn" data-nature="stable">Stable</button>
    <button class="btn cat-filter-btn" data-nature="overpaid">Overpaid</button>
    <button class="btn cat-filter-btn" data-nature="underpaid">Underpaid</button>

    <!-- Demand filter -->
    <select id="demandFilter" style="padding: 0.5rem; font-size: 1rem;">
      <option value="all">All Demands</option>
      <option value="0-2">0 - 2</option>
      <option value="3-5">3 - 5</option>
      <option value="6-8">6 - 8</option>
      <option value="9-10">9 - 10</option>
    </select>
  </div>

  <div id="categoryItems"><p>Loading items...</p></div>
  <div id="footer"></div>

  <script>
    let pricesMap = new Map();
    let currentNatureFilter = 'all';
    let currentDemandRange = 'all';

    async function loadCategoryItems() {
      const urlParams = new URLSearchParams(window.location.search);
      const category = urlParams.get('cat');
      if (!category) {
        document.getElementById('categoryItems').innerHTML = '<p>No category specified.</p>';
        return;
      }

      try {
        const [marketRes, pricesRes] = await Promise.all([
          fetch('market/market.txt'),
          fetch('market/mprices.txt')
        ]);
        const marketData = await marketRes.json();
        const pricesData = await pricesRes.text();

        pricesData.split('\n').forEach(line => {
          const [id, arrayStr] = line.split(':').map(part => part.trim());
          if (id && arrayStr) {
            try {
              const parsedArray = JSON.parse(arrayStr);
              if (Array.isArray(parsedArray) && parsedArray.length === 2) {
                pricesMap.set(id, parsedArray);
              }
            } catch (e) {
              console.warn(`Invalid price format for ID ${id}`, e);
            }
          }
        });

        window._allCategoryItems = marketData.filter(item =>
          item.category && item.category.toLowerCase() === category.toLowerCase()
        );
        renderCategoryItems();
      } catch (error) {
        console.error('Error loading category items:', error);
        document.getElementById('categoryItems').innerHTML = '<p>Failed to load items.</p>';
      }
    }

    function renderCategoryItems() {
      const items = window._allCategoryItems || [];
      let filtered = items;


      if (currentDemandRange !== 'all') {
        const [min, max] = currentDemandRange.split('-').map(Number);
        filtered = filtered.filter(item => {
          const priceData = pricesMap.get(item.id);
          if (!priceData || isNaN(priceData[0])) return false;
          return priceData[0] >= min && priceData[0] <= max;
        });
      }

      const urlParams = new URLSearchParams(window.location.search);
      const currentCategory = urlParams.get('cat');
      const currentNature = currentNatureFilter || 'all';

      if (filtered.length > 0) {
        const itemsHTML = filtered.map(item => {
          const isSkyCanvas = item.name === "Sky Canvas";
          const priceData = pricesMap.get(item.id);
          const demandValue = priceData ? priceData[0] : null;
          const demandDisplay = demandValue != null ? `<p class="demand"><strong>Demand:</strong> ${demandValue}</p>` : '';
          return `
            <div class="item-card" onclick="window.location.href='item.html?item=${item.id}&cat=${encodeURIComponent(currentCategory)}&nature=${encodeURIComponent(currentNature)}'">
              <h2>${item.name}</h2>
              ${item.picture ? `<div class="main-data"><img src="${item.picture}" alt="${item.name}"${isSkyCanvas ? ' class="sky-canvas-img"' : ''}>` : ''}
              <div class="main-data-val">
                <p><strong>ID:</strong> ${item.id}</p>
                ${item.description ? `<p class="description">${item.description}</p>` : ''}
                ${item.rarity ? `<p class="rarity-display" id="rarityDisplay"><img class="rarity" src="img/rarity/${item.rarity}.webp"></p><br><br>` : ''}
                ${item.nature ? `<p class="nature"><strong>Nature:</strong> ${formatNature(item.nature)}</p>` : ''}
                ${demandDisplay}
              </div></div>
            </div>`;
        }).join('');
        document.getElementById('categoryItems').innerHTML = `<div class="item-list">${itemsHTML}</div>`;
      } else {
        document.getElementById('categoryItems').innerHTML = '<p>No items found in this category.</p>';
      }
    }

    function formatNature(nature) {
      return nature.replace('[', '').replace(']', '').replace(/_/g, ' ').toLowerCase().trim();
    }

    document.addEventListener('DOMContentLoaded', function () {
      loadCategoryItems();



      document.getElementById('demandFilter').addEventListener('change', function (e) {
        currentDemandRange = e.target.value;
        renderCategoryItems();
      });
    });
  </script>
</body>
</html>
