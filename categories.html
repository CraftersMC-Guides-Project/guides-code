<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Category Items</title>
  <link rel="stylesheet" href="css/essential.css">
  <link rel="stylesheet" href="css/categories.css">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    #categoryFilter {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 2rem 0 1rem;
    }

    .cat-filter-btn {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }

    .cat-filter-btn.active {
      background: #333;
      color: white;
    }

    #demandSliderBox {
      text-align: center;
      margin-bottom: 2rem;
    }

    .range-slider {
      position: relative;
      width: 220px;
      height: 30px;
      margin: 1rem auto;
    }

    .range-slider input[type="range"] {
      position: absolute;
      width: 100%;
      height: 8px;
      background: none;
      pointer-events: none;
      z-index: 2;
    }

    .range-slider input[type="range"]::-webkit-slider-thumb {
      pointer-events: all;
      appearance: none;
      width: 16px;
      height: 16px;
      background: red;
      border-radius: 50%;
      margin-top: -4px;
      cursor: pointer;
    }

    .slider-track {
      position: absolute;
      height: 4px;
      top: 12px;
      background: teal;
      z-index: 1;
    }

    .item-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      padding: 1rem;
    }

    .item-card {
      background: white;
      border: 1px solid #ccc;
      padding: 1rem;
      width: 200px;
      cursor: pointer;
    }

    .item-card img {
      width: 100%;
      max-height: 100px;
      object-fit: contain;
    }
  </style>
</head>
<body>

  <div id="categoryFilter">
    <button class="cat-filter-btn active" data-nature="all">All</button>
    <button class="cat-filter-btn" data-nature="stable">Stable</button>
    <button class="cat-filter-btn" data-nature="overpaid">Overpaid</button>
    <button class="cat-filter-btn" data-nature="underpaid">Underpaid</button>
  </div>

  <div id="demandSliderBox">
    <div><strong>Demand:</strong> <span id="rangeVal">1 – 10</span></div>
    <div class="range-slider">
      <div class="slider-track" id="sliderTrack"></div>
      <input type="range" id="minRange" min="1" max="10" value="1">
      <input type="range" id="maxRange" min="1" max="10" value="10">
    </div>
  </div>

  <div id="categoryItems"><p>Loading items...</p></div>

  <script>
    let currentNatureFilter = 'all';
    let minDemandVal = 1;
    let maxDemandVal = 10;

    async function loadCategoryItems() {
      const cat = new URLSearchParams(window.location.search).get('cat');
      if (!cat) {
        document.getElementById('categoryItems').innerHTML = '<p>No category selected.</p>';
        return;
      }

      try {
        const res = await fetch('market/market.txt');
        const data = await res.json();

        const filtered = data.filter(item =>
          item.category && item.category.toLowerCase() === cat.toLowerCase()
        );

        if (filtered.length === 0) {
          document.getElementById('categoryItems').innerHTML = '<p>No items found in this category.</p>';
          return;
        }

        window._allCategoryItems = filtered;
        renderCategoryItems();
      } catch (err) {
        document.getElementById('categoryItems').innerHTML = `<p>Failed to load items. ${err.message}</p>`;
        console.error(err);
      }
    }

    function renderCategoryItems() {
      const items = window._allCategoryItems || [];
      let result = items;

      if (currentNatureFilter !== 'all') {
        result = result.filter(i => i.nature?.toUpperCase().includes(currentNatureFilter.toUpperCase()));
      }

      result = result.filter(i => {
        const d = parseDemand(i.demand);
        return d !== null && d >= minDemandVal && d <= maxDemandVal;
      });

      if (result.length === 0) {
        document.getElementById('categoryItems').innerHTML = '<p>No matching items found.</p>';
        return;
      }

      document.getElementById('categoryItems').innerHTML = `<div class="item-list">
        ${result.map(item => `
          <div class="item-card" onclick="location.href='item.html?item=${item.id}'">
            <h4>${item.name}</h4>
            ${item.picture ? `<img src="${item.picture}" alt="${item.name}">` : ''}
            <p><strong>ID:</strong> ${item.id}</p>
            ${item.nature ? `<p><strong>Nature:</strong> ${item.nature}</p>` : ''}
            ${item.demand ? `<p><strong>Demand:</strong> ${item.demand}</p>` : ''}
          </div>
        `).join('')}
      </div>`;
    }

    function parseDemand(str) {
      if (!str) return null;
      const match = str.match(/\[(\d+)\s*\/\s*10\]/);
      return match ? parseInt(match[1]) : null;
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCategoryItems();

      document.getElementById('categoryFilter').addEventListener('click', e => {
        if (e.target.classList.contains('cat-filter-btn')) {
          document.querySelectorAll('.cat-filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentNatureFilter = e.target.dataset.nature;
          renderCategoryItems();
        }
      });

      const minSlider = document.getElementById("minRange");
      const maxSlider = document.getElementById("maxRange");
      const sliderTrack = document.getElementById("sliderTrack");
      const rangeVal = document.getElementById("rangeVal");

      function updateSlider() {
        let min = +minSlider.value;
        let max = +maxSlider.value;

        if (min > max) [min, max] = [max, min];
        minDemandVal = min;
        maxDemandVal = max;
        rangeVal.textContent = `${min} – ${max}`;

        const percent1 = ((min - 1) / 9) * 100;
        const percent2 = ((max - 1) / 9) * 100;
        sliderTrack.style.left = percent1 + "%";
        sliderTrack.style.width = (percent2 - percent1) + "%";

        renderCategoryItems();
      }

      minSlider.addEventListener('input', updateSlider);
      maxSlider.addEventListener('input', updateSlider);
      updateSlider();
    });
  </script>
</body>
</html>
