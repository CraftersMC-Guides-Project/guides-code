<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Developer Management</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111827; color: #fff; margin: 0; padding: 20px; }
    h1 { color: #f9fafb; }
    ul { list-style: none; padding: 0; }
    li { background: #1f2937; margin: 10px 0; padding: 12px; border-radius: 10px; display:flex; align-items:center; justify-content:space-between; }
    .profile { display:flex; align-items:center; gap:12px; }
    .profile img { width:48px; height:48px; border-radius:50%; }
    .profile-info { display:flex; flex-direction:column; }
    .profile-info strong { font-size: 15px; color:#f9fafb; }
    .profile-info small { font-size: 12px; color:#9ca3af; }
    .remove-btn { background:#dc2626; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
    .remove-btn:hover { background:#b91c1c; }
    .add-container { margin-top:20px; display:flex; gap:10px; }
    input { padding:8px; border-radius:6px; border:none; width:200px; }
    button { cursor:pointer; border:none; border-radius:6px; padding:8px 16px; }
    #addIdBtn { background:#2563eb; color:white; }
    #saveChangesBtn { background:#10b981; color:white; margin-top:20px; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #374151; padding: 12px 18px; border-radius: 8px; display:none; }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <h1>Developer Management</h1>
  <ul id="devList"></ul>

  <div class="add-container">
    <input type="text" id="newIdInput" placeholder="Enter Discord User ID" />
    <button id="addIdBtn">Add</button>
  </div>
  <button id="saveChangesBtn">Save Changes</button>

  <div id="toast" class="toast"></div>

  <script>
    const GITHUB_REPO = "CraftersMC-Guides-Project/guides-code";
    const DEVS_FILE_PATH = "devs.txt";
    const GITHUB_BRANCH = "main";
    const ADMIN_USER_ID = "783972385882767400";

    let devIds = [];
    let allUsers = [];
    let added = [];
    let removed = [];

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    window.addEventListener("DOMContentLoaded", () => {
      const storedUser = getCookie("discordUser");
      if (!storedUser) { window.location.href = '/index.html'; return; }
      const user = JSON.parse(storedUser);
      if (user.id !== ADMIN_USER_ID) { window.location.href = '/index.html'; return; }
      loadData();
    });

    async function loadData() {
      try {
        const usersResponse = await fetch("https://discord-auth.roumakdatta.workers.dev/users/", { cache: "no-cache" });
        if (!usersResponse.ok) throw new Error("Could not fetch users list");
        allUsers = await usersResponse.json();

        const response = await fetch(`/${DEVS_FILE_PATH}`, { cache: 'no-cache' });
        if (!response.ok) throw new Error('Could not fetch devs.txt');
        const text = await response.text();
        devIds = text.split('\n').map(id => id.trim()).filter(id => id);

        renderDevList();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function renderDevList() {
      const list = document.getElementById('devList');
      list.innerHTML = '';

      devIds.forEach(id => {
        const user = allUsers.find(u => u.id === id);
        const li = document.createElement('li');
        li.innerHTML = user ? `
          <div class="profile">
            <img src="${user.avatar}" alt="avatar">
            <div class="profile-info">
              <strong>${user.global_name || user.username}</strong> (${user.username})
              <small>ID: ${user.id}</small>
              <small>Role: ${user.role}</small>
            </div>
          </div>
          <button class="remove-btn" onclick="confirmRemove('${id}')">Remove</button>
        ` : `
          <span>${id} (not found in DB)</span>
          <button class="remove-btn" onclick="confirmRemove('${id}')">Remove</button>
        `;
        list.appendChild(li);
      });
    }

    async function confirmRemove(id) {
      const user = allUsers.find(u => u.id === id);
      if (confirm(`Remove this dev?\n\n${user ? `${user.username} (${user.id})` : id}`)) {
        removed.push(id);
        devIds = devIds.filter(x => x !== id);
        renderDevList();
      }
    }

    document.getElementById("addIdBtn").addEventListener("click", async () => {
      const newId = document.getElementById("newIdInput").value.trim();
      if (!newId) return;

      const user = allUsers.find(u => u.id === newId);
      if (!user) {
        showToast("User not found in DB, cannot add.", "error");
        return;
      }

      if (confirm(`Add this user as dev?\n\n${user.username} (${user.id})`)) {
        if (!devIds.includes(newId)) {
          devIds.push(newId);
          added.push(newId);
          renderDevList();
        } else {
          showToast("User already exists in list.", "error");
        }
      }
      document.getElementById("newIdInput").value = "";
    });

    document.getElementById("saveChangesBtn").addEventListener("click", async () => {
      try {
        const token = prompt("Enter GitHub token to commit changes:");
        if (!token) return;

        const newContent = devIds.join("\n");
        const shaResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DEVS_FILE_PATH}?ref=${GITHUB_BRANCH}`);
        const shaData = await shaResponse.json();
        const sha = shaData.sha;

        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DEVS_FILE_PATH}`, {
          method: "PUT",
          headers: {
            "Authorization": `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Update dev list via admin panel",
            content: btoa(newContent),
            sha,
            branch: GITHUB_BRANCH
          })
        });

        if (res.ok) {
          showToast("Dev list updated successfully!", "success");
          // Trigger backend sync
          await fetch("https://discord-auth.roumakdatta.workers.dev/sync-devs");
          added = [];
          removed = [];
        } else {
          const errorData = await res.json();
          showToast("Failed to update: " + (errorData.message || ""), "error");
        }
      } catch (e) {
        showToast("Error: " + e.message, "error");
      }
    });

    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.style.background = type === "error" ? "#dc2626" : "#16a34a";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }
  </script>
</body>
</html>
