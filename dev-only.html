<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Developer Management</title>
  <style>
    :root {
      --bg: #0a0c10;
      --bg-panel: #111827;
      --bg-item: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --primary: #2563eb;
      --danger: #dc2626;
      --success: #10b981;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Inter, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: var(--bg-panel);
      padding: 24px;
      border-radius: 12px;
      width: 100%;
      max-width: 650px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    h1 { margin: 0 0 16px; text-align: center; }
    ul { list-style: none; padding: 0; margin: 0; max-height: 350px; overflow-y: auto; }
    li {
      background: var(--bg-item);
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .profile { display: flex; gap: 12px; align-items: center; }
    .profile img { width: 48px; height: 48px; border-radius: 50%; }
    .profile-info { display: flex; flex-direction: column; }
    .profile-info strong { font-size: 15px; }
    .profile-info small { font-size: 12px; color: var(--muted); }
    button {
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .remove-btn { background: var(--danger); color: white; }
    .remove-btn:hover { background: #b91c1c; }
    .add-section { display: flex; gap: 10px; margin-top: 16px; }
    input { flex: 1; padding: 10px; border-radius: 6px; border: none; }
    .add-btn { background: var(--primary); color: white; }
    .add-btn:hover { background: #1d4ed8; }
    .save-btn { background: var(--success); color: white; width: 100%; margin-top: 16px; padding: 14px; font-size: 16px; }
    .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: #374151; padding: 12px 18px; border-radius: 8px; transition: bottom .3s; color: white; }
    .toast.show { bottom: 20px; }
    .preview { background: var(--bg-item); border-radius: 10px; padding: 16px; margin-top: 16px; }
    .preview-actions { margin-top: 12px; display: flex; gap: 10px; }
    .cancel-btn { background: var(--danger); color: white; flex: 1; }
    .confirm-btn { background: var(--success); color: white; flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Developer Management</h1>
    <ul id="devList"><li>Loading...</li></ul>

    <div class="add-section">
      <input type="text" id="newIdInput" placeholder="Enter Discord User ID">
      <button class="add-btn" id="addIdBtn">Add</button>
    </div>

    <div id="previewArea"></div>

    <button class="save-btn" id="saveChangesBtn">Save Changes</button>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const ADMIN_USER_ID = "783972385882767400";
    const GITHUB_REPO = "CraftersMC-Guides-Project/guides-code";
    const DEVS_FILE_PATH = "devs.txt";
    const GITHUB_BRANCH = "main";
    let devIds = [];
    let allUsers = [];

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    window.addEventListener("DOMContentLoaded", () => {
      const storedUser = getCookie("discordUser");
      if (!storedUser) { window.location.href = '/index.html'; return; }
      const user = JSON.parse(storedUser);
      if (user.id !== ADMIN_USER_ID) { window.location.href = '/index.html'; return; }
      loadData();
    });

    async function loadData() {
      const usersResp = await fetch("https://discord-auth.roumakdatta.workers.dev/users/");
      allUsers = await usersResp.json();
      const devResp = await fetch(`/${DEVS_FILE_PATH}`);
      const text = await devResp.text();
      devIds = text.split("\n").map(id=>id.trim()).filter(Boolean);
      renderList();
    }

    function renderList() {
      const list = document.getElementById("devList");
      list.innerHTML = "";
      devIds.forEach(id => {
        const u = allUsers.find(x=>x.id===id);
        const li = document.createElement("li");
        li.innerHTML = u ? `
          <div class="profile">
            <img src="${u.avatar}" alt="">
            <div class="profile-info">
              <strong>${u.global_name || u.username}</strong>
              <small>ID: ${u.id}</small>
              <small>Role: ${u.role} ${u.xbox ? `| Xbox: ${u.xbox.name}`:""}</small>
            </div>
          </div>
          <button class="remove-btn" onclick="removeId('${id}')">Remove</button>
        ` : `${id} (not in DB)`;
        list.appendChild(li);
      });
    }

    async function removeId(id) {
      devIds = devIds.filter(x=>x!==id);
      renderList();
      showToast("Marked for removal","info");
    }

    document.getElementById("addIdBtn").addEventListener("click", async ()=>{
      const id = document.getElementById("newIdInput").value.trim();
      if (!id) return;
      const u = allUsers.find(x=>x.id===id);
      const area = document.getElementById("previewArea");
      area.innerHTML = "";
      if (!u) {
        area.innerHTML = `<div class="preview">‚ùå User not found in DB</div>`;
        return;
      }
      area.innerHTML = `
        <div class="preview">
          <div class="profile">
            <img src="${u.avatar}" alt="">
            <div class="profile-info">
              <strong>${u.global_name || u.username}</strong>
              <small>ID: ${u.id}</small>
              <small>Role: ${u.role} ${u.xbox ? `| Xbox: ${u.xbox.name}`:""}</small>
            </div>
          </div>
          <div class="preview-actions">
            <button class="cancel-btn" onclick="cancelPreview()">Cancel</button>
            <button class="confirm-btn" onclick="confirmAdd('${id}')">Confirm Add</button>
          </div>
        </div>
      `;
    });

    function cancelPreview() { document.getElementById("previewArea").innerHTML=""; }
    function confirmAdd(id) {
      if (!devIds.includes(id)) {
        devIds.push(id);
        renderList();
        showToast("User added","success");
      }
      cancelPreview();
    }

    document.getElementById("saveChangesBtn").addEventListener("click", async ()=>{
      try {
        const token = getCookie("githubToken");
        if (!token) { showToast("Missing GitHub token","error"); return; }
        const newContent = devIds.join("\n");
        const shaResp = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DEVS_FILE_PATH}?ref=${GITHUB_BRANCH}`);
        const shaData = await shaResp.json();
        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${DEVS_FILE_PATH}`,{
          method:"PUT",
          headers:{Authorization:`token ${token}`,"Content-Type":"application/json"},
          body: JSON.stringify({message:"Update dev list",content:btoa(newContent),sha:shaData.sha,branch:GITHUB_BRANCH})
        });
        if (res.ok) {
          showToast("Dev list updated!","success");
          await fetch("https://discord-auth.roumakdatta.workers.dev/sync-devs");
        } else {
          showToast("Update failed","error");
        }
      } catch(e) { showToast("Error: "+e.message,"error"); }
    });

    function showToast(msg,type) {
      const t=document.getElementById("toast");
      t.innerText=msg;
      t.style.background= type==="success"? "#16a34a" : type==="error"? "#dc2626" : "#2563eb";
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),3000);
    }
  </script>
</body>
</html>
