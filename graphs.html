<!DOCTYPE html>
<html>
<link rel="stylesheet" href="css/essential.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<title>graph?</title>
<body>
  <h1>Market Graphs</h1>
  <p>someone get the worker made soon pls</p>
  <div id="myChart" style="width: 90%; margin: auto;">
    <canvas id="priceChart"></canvas>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const itemId = urlParams.get('id');

  if (!itemId) {
    console.error("No item ID provided in the URL. Use '?id=123'");
    return;
  }

  const apiUrl = `https://chart-bot.roumakdatta.workers.dev/item?id=${itemId}`;

  fetch(apiUrl)
    .then(res => {
      if (!res.ok) return res.json().then(err => { throw new Error(err.error || 'Fetch failed') });
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) throw new Error('No valid data received.');
      displayChart(data);
    })
    .catch(err => {
      console.error('Error loading chart:', err.message);
    });

  function displayChart(data) {
    const labels = data.map(e => e.date);
    const prices = data.map(e => e.price);

    const ctx = document.getElementById('priceChart').getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(74, 222, 128, 0.4)');
    gradient.addColorStop(1, 'rgba(34, 197, 94, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Price',
          data: prices,
          borderColor: 'rgb(74, 222, 128)',
          backgroundColor: gradient,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 6,
          tension: 0.1,
          fill: true,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            ticks: {
              color: 'rgba(255,255,255,0.7)',
              callback: value => value >= 1e6 ? value / 1e6 + 'M' : value >= 1e3 ? value / 1e3 + 'k' : value
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          x: {
            ticks: { color: 'rgba(255,255,255,0.7)', maxTicksLimit: 10 },
            grid: { display: false }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0,0,0,0.8)',
            callbacks: {
              label: context => `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`
            }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false
        }
      }
    });
  }
});
</script>

</body>
</html>
