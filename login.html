<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="assets/cmc-icon.png" type="image/png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="themes/minecraft/style.css">
    <script src="../js/script.js"></script>
    <title>Login - CraftersMC Guides</title>
    <style>
        /* Bigger styled avatar */
        .login-avatar {
            width: 120px !important;
            height: 120px !important;
            border-radius: 50%;
            margin: 15px auto;
            display: block;
            border: 4px solid #7289da;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
        }

        /* Logout popup */
        #logout-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            color: #fff;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 9999;
            text-align: center;
        }

        #logout-popup button {
            margin-top: 10px;
            padding: 6px 16px;
            background: #7289da;
            border: none;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="loader"><div></div><div></div><div></div></div>
    <div class="login-background"></div>
    <div class="top"></div>
    <div class="sidebar" id="sidebar"></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <button id="float">
        <span class="material-icons" id="sweepBtn" style="background:#222;border-radius:50px;">chevron_right</span>
        <span class="material-icons" id="homeBtn" onclick="homeBtn()">home</span>
        <span class="material-icons" id="ai" onclick="aiBtn()">smart_toy</span>
        <span class="material-icons" id="scrollToTopBtn">north</span>
    </button>

    <div class="login-container">
        <h3 class="login-h3">Login</h3>
        <div id="xbox-danger-msg-container"></div>
        <img id="user-avatar" class="login-avatar" src="" alt="User Avatar" style="display:none;">
        <div class="login-button-container">
            <a id="discord-login-button" class="login-discord-login-button">
                Login with Discord
            </a>
        </div>

        <hr class="login-hr" />

        <div class="login-other-options">
            <span>Don't have a Discord account? <a href="https://discord.com/register" target="_blank">Sign up on
                    Discord</a></span>
        </div>
        <div class="login-message" id="message"></div>
        <div id="login-status" style="display:none;"></div>
        <div id="username-display" style="display:none;"></div>
        <button id="logout-button" class="login-logout-button" style="display:none;">Logout</button>
    </div>

    <!-- Logout Popup -->
    <div id="logout-popup">
        <p>You have been logged out.</p>
        <button onclick="document.getElementById('logout-popup').style.display='none'">OK</button>
    </div>

    <!-- Modal -->
    <div id="login-modal" style="display:none;">
        <div class="login-modal-backdrop"></div>
        <div class="login-modal-content">
            <h3 class="login-h3">How to Login</h3>
            <ol>
                <li><b>Have a Discord account:</b><br>
                    If you don't have one, <a href="https://discord.com/register" target="_blank" style="color:#7289da;">sign up here</a>.
                </li>
                <li style="margin-top:1em;"><b>Connect your Xbox account to Discord:</b><br>
                    Go to <a href="https://discord.com/channels/@me" target="_blank" style="color:#7289da;">Discord Connections</a> and connect your Xbox account.<br>
                    <span style="font-size:0.95em;color:#bbb;">(Required for giveaways / rank sellers page.)</span>
                </li>
            </ol>
            <h4 class="login-h4">Details How we collect your Data</h4>
            <img src="assets/proof.png" alt="Discord Data Collection" style="width:90%;border-radius:8px;margin:10px 20px;">
            <button id="proceed-login" class="login-discord-login-button" style="margin:10px 20px;">Proceed to Discord Login</button>
            <button id="close-modal" style="margin:10px 20px;background:#333;color:#fff;border:none;padding:8px 18px;cursor:pointer;">Cancel</button>
        </div>
    </div>
    <div id="footer"></div>

    <script>
        // Cookie helpers
        function setCookie(name, value, days = 7) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }
        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, '');
        }
        function deleteCookie(name) {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const messageDiv = document.getElementById('message');
            const loginStatus = document.getElementById('login-status');
            const usernameDisplay = document.getElementById('username-display');
            const logoutButton = document.getElementById('logout-button');
            const userAvatar = document.getElementById('user-avatar');
            const loginModal = document.getElementById('login-modal');
            const proceedLoginButton = document.getElementById('proceed-login');
            const closeModalButton = document.getElementById('close-modal');
            const discordLoginBtn = document.getElementById('discord-login-button');
            const logoutPopup = document.getElementById('logout-popup');

            // Open modal
            discordLoginBtn.addEventListener('click', e => {
                e.preventDefault();
                loginModal.style.display = 'block';
            });
            closeModalButton.addEventListener('click', () => loginModal.style.display = 'none');
            proceedLoginButton.addEventListener('click', () => {
                loginModal.style.display = 'none';
                window.location.href = "https://discord.com/oauth2/authorize?client_id=1359486772366672022&response_type=code&redirect_uri=https%3A%2F%2Fcraftersmc-guides.pages.dev%2Flogin&scope=identify+connections";
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                if (loginModal.style.display === 'block') {
                    if (e.key === "Enter") proceedLoginButton.click();
                    if (e.key === "Escape" || e.key === "Backspace") closeModalButton.click();
                }
            });

            // Logout
            logoutButton.addEventListener('click', () => {
                logout();
                logoutPopup.style.display = 'block';
            });

            function showLoggedInState(userData) {
                loginStatus.textContent = 'Logged in Successfully!';
                loginStatus.style.display = 'block';
                usernameDisplay.textContent = `Welcome, ${userData.username}`;
                usernameDisplay.style.display = 'block';

                if (userData.avatar) {
                    userAvatar.src = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.webp`;
                    userAvatar.style.display = 'block';
                }

                document.querySelector('.login-button-container').style.display = 'none';
                document.querySelector('.login-other-options').style.display = 'none';
                document.querySelector('hr').style.display = 'none';
                logoutButton.style.display = 'block';

                // Giveaway button
                let giveawayBtn = document.getElementById('giveaway-button');
                if (!giveawayBtn) {
                    giveawayBtn = document.createElement('button');
                    giveawayBtn.id = 'giveaway-button';
                    giveawayBtn.textContent = 'Go to Giveaway Page';
                    giveawayBtn.style.marginTop = '10px';
                    giveawayBtn.style.backgroundColor = '#007bff';
                    giveawayBtn.style.color = '#fff';
                    giveawayBtn.style.padding = '10px 20px';
                    giveawayBtn.style.border = 'none';
                    giveawayBtn.style.borderRadius = '5px';
                    giveawayBtn.style.cursor = 'pointer';
                    logoutButton.parentNode.insertBefore(giveawayBtn, logoutButton);
                    giveawayBtn.onclick = () => window.location.href = 'giveaway.html';
                }

                // Home button
                let homeBtn = document.getElementById('home-button');
                if (!homeBtn) {
                    homeBtn = document.createElement('button');
                    homeBtn.id = 'home-button';
                    homeBtn.textContent = 'Return to Home';
                    homeBtn.style.marginTop = '10px';
                    homeBtn.style.backgroundColor = '#28a745';
                    homeBtn.style.color = '#fff';
                    homeBtn.style.padding = '10px 20px';
                    homeBtn.style.border = 'none';
                    homeBtn.style.borderRadius = '5px';
                    homeBtn.style.cursor = 'pointer';
                    logoutButton.parentNode.insertBefore(homeBtn, logoutButton);
                    homeBtn.onclick = () => window.location.href = 'index.html';
                }
            }

            function logout() {
                deleteCookie('discordUser');
                loginStatus.style.display = 'none';
                usernameDisplay.style.display = 'none';
                userAvatar.style.display = 'none';
                document.querySelector('.login-button-container').style.display = 'flex';
                document.querySelector('.login-other-options').style.display = 'block';
                document.querySelector('hr').style.display = 'block';
                logoutButton.style.display = 'none';

                let giveawayBtn = document.getElementById('giveaway-button');
                if (giveawayBtn) giveawayBtn.style.display = 'none';
                let homeBtn = document.getElementById('home-button');
                if (homeBtn) homeBtn.style.display = 'none';

                if (messageDiv) messageDiv.textContent = 'Please log in to continue.';
            }

            // Auto login state from cookie
            const storedUser = getCookie('discordUser');
            if (storedUser) {
                try {
                    const userObj = JSON.parse(storedUser);
                    if (userObj && userObj.id && userObj.username) {
                        showLoggedInState(userObj);
                    }
                } catch {}
            }
        });
    </script>
</body>
</html>
