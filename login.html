<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Login - CraftersMC Guides</title>
    <style>
        body {
            background: url("../Backgrounds/IMG_4500.jpeg");
            background-size: cover;
            background-position-x: center;
            background-repeat: no-repeat;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #1c1c1c99;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px #000;
            width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .button-container {
            display: flex;
            flex-direction: column;
            width: 80%;
        }
        .discord-login-button {
            background-color: #5865f2;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            text-decoration: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .discord-login-button svg {
            height: 24px;
            margin-right: 10px;
        }
        .message {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
            color: #bbb;
        }
        hr {
            border: 0;
            height: 1px;
            background: #333;
            margin: 20px 0;
            width: 80%;
        }
        .other-options {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #bbb;
        }
        .other-options a {
            color: #007bff;
        }
        #login-status {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #66bb6a;
            display: none;
        }
        #username-display {
            margin-top: 10px;
            font-size: 16px;
            color: white;
            display: none;
        }
        .logout-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
            text-decoration: none;
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        .logout-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Login</h2>
    <div class="button-container">
        <a href="https://discord.com/oauth2/authorize?client_id=1359486772366672022&redirect_uri=https%3A%2F%2Fcraftersmc-guides.pages.dev%2Flogin&response_type=code&scope=identify" class="discord-login-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 67.75 63.85">
                <g>
                    <path fill="#fff" d="M53.7,4.51A48.63,48.63,0,0,0,39.82,0a40.39,40.39,0,0,0-19,0A48.63,48.63,0,0,0,14.05,4.51C6.32,26.54,10.71,47.42,33.63,63.85a1.12,1.12,0,0,0,1.69,0C57.05,47.42,61.44,26.54,53.7,4.51Z"/>
                    <path fill="#fff" d="M43.15,41.13a7.17,7.17,0,0,1-4.27-1.25,5.08,5.08,0,0,1-3.66-4.42v-.07a5.09,5.09,0,0,1,5.1-4.92,5.34,5.34,0,0,1,2.77,.76,13.81,13.81,0,0,0,3.73-8.84,13.11,13.11,0,0,0-11.72-5.48,12.77,12.77,0,0,0-8.58,3.28,13,13,0,0,0-3.14,9.19,5.35,5.35,0,0,1,2.82-.81,5.07,5.07,0,0,1,5.09,4.86v.07a5.08,5.08,0,0,1-3.65,4.35,7.12,7.12,0,0,1-4.23,1.25A19.55,19.55,0,0,0,18.21,32c-3.7,0-6.71-2.65-6.71-5.91a8.21,8.21,0,0,1,.45-2.71,17.41,17.41,0,0,0-1.2-4.74,11.72,11.72,0,0,1,10.37-5.32,11.22,11.22,0,0,1,7.77,2.74,10.77,10.77,0,0,1,4.25,7.72,16.48,16.48,0,0,0,1.17,4.64,7.89,7.89,0,0,1,.41,2.57c0,3.31-3,5.91-6.68,5.91Zm0,0"/>
                </g>
            </svg>
            Login with Discord
        </a>
    </div>

    <hr>

    <div class="other-options">
        <span>Don't have a Discord account? <a href="https://discord.com/register" target="_blank">Sign up on Discord</a></span>
    </div>
    <div class="message" id="message"></div>
    <div id="login-status" style="display: none;"></div>
    <div id="username-display" style="display: none;"></div>
    <button id="logout-button" class="logout-button" style="display: none;">Logout</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const messageDiv = document.getElementById('message');
        const loginStatus = document.getElementById('login-status');
        const usernameDisplay = document.getElementById('username-display');
        const logoutButton = document.getElementById('logout-button');

        if (code) {
            // Clear the code from the URL
            window.history.replaceState({}, document.title, window.location.pathname);

            const workerUrl = 'https://discord-auth.roumakdatta.workers.dev/';

            fetch(workerUrl + `?code=${encodeURIComponent(code)}`)
                .then(response => {
                    if (!response.ok) {
                        console.error('Error from worker:', response.status, response.statusText);
                        return response.text().then(errText => {
                            throw new Error(`Worker responded with ${response.status}: ${errText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('Discord login error:', data.error, data.details);
                        if (messageDiv) {
                            messageDiv.textContent = `Discord Login Failed: ${data.error} ${data.details || ''}`;
                        }
                    } else if (data.username) {
                        console.log('Successfully logged in with Discord:', data);
                        localStorage.setItem('discordUser', JSON.stringify({
                            id: data.id,
                            username: data.username,
                            discriminator: data.discriminator,
                            avatar: data.avatar,
                            email: data.email,
                        }));
                        loginStatus.textContent = 'Logged in Successfully!';
                        loginStatus.style.display = 'block';
                        usernameDisplay.textContent = `Username: ${data.username}`;
                        usernameDisplay.style.display = 'block';
                        document.querySelector('.button-container').style.display = 'none';
                        document.querySelector('.other-options').style.display = 'none';
                        document.querySelector('hr').style.display = 'none';
                        logoutButton.style.display = 'block';

                    } else {
                        console.warn('Discord login successful, but missing expected user data:', data);
                        if (messageDiv) {
                            messageDiv.textContent = 'Login successful, but some user data is missing.';
                        }
                        localStorage.setItem('discordAuth', JSON.stringify(data));
                        loginStatus.textContent = 'Logged in Successfully!';
                        loginStatus.style.display = 'block';
                        usernameDisplay.textContent = `Potentially Missing Username Data`;
                        usernameDisplay.style.display = 'block';
                        document.querySelector('.button-container').style.display = 'none';
                        document.querySelector('.other-options').style.display = 'none';
                        document.querySelector('hr').style.display = 'none';
                        logoutButton.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Network error during Discord login:', error);
                    if (messageDiv) {
                        messageDiv.textContent = `Network error during login: ${error.message}`;
                    }
                });
        }
        // If no 'code' in URL, the user needs to click the Discord login button
        const storedUser = localStorage.getItem('discordUser');
        if (storedUser) {
            const userData = JSON.parse(storedUser);
            loginStatus.textContent = 'Logged in Successfully!';
            loginStatus.style.display = 'block';
            usernameDisplay.textContent = `Username: ${userData.username}`;
            usernameDisplay.style.display = 'block';
            document.querySelector('.button-container').style.display = 'none';
            document.querySelector('.other-options').style.display = 'none';
            document.querySelector('hr').style.display = 'none';
            logoutButton.style.display = 'block';
        } else {
            logoutButton.style.display = 'none';
        }

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('discordUser');
            loginStatus.style.display = 'none';
            usernameDisplay.style.display = 'none';
            document.querySelector('.button-container').style.display = 'flex';
            document.querySelector('.other-options').style.display = 'block';
            document.querySelector('hr').style.display = 'block';
            logoutButton.style.display = 'none';
            messageDiv.textContent = 'Logged out. Please log in again.';
        });

    });

    // Replace 'YOUR_DISCORD_AUTH_URL' with your actual Discord OAuth2 authorization URL.
    // Example: "https://discord.com/oauth2/authorize?client_id=YOUR_CLIENT_ID&redirect_uri=https%3A%2F%2Fcraftersmc-guides.pages.dev%2Flogin&response_type=code&scope=identify%20email"
</script>

</body>
</html>
