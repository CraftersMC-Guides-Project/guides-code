<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<nav class="navbar">
    <span class="menu-icon material-icons" onclick="toggleSidebar()">menu</span>
    <div class="right">
        <div id="authContainer">
            <button id="authButton" class="auth-button">
                <span class="material-icons">help_outline</span> </button>
            <div id="userDropdown" class="dropdown-content">
                <a href="#" id="logoutButton">Logout</a>
                </div>
        </div>
    </div>
</nav>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLoginModal()">&times;</span>
        <h2>Login / Sign Up</h2>
        <div id="authError" class="error-message"></div>
        <form id="emailPasswordForm" onsubmit="return false;">
            <input type="email" id="emailInput" placeholder="Email" required>
            <input type="password" id="passwordInput" placeholder="Password" required>
            <button type="button" id="loginButton">Login</button>
            <button type="button" id="signupButton">Sign Up</button>
        </form>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>

<script>
    if (!window.firebaseInitialized) {
        window.firebaseInitialized = true;

        const firebaseConfig = {
            apiKey: "AIzaSyC9HDieVtkTu_PrSumxoDi1plXduu-J5pg",
            authDomain: "craftersmc-guides.firebaseapp.com",
            projectId: "craftersmc-guides",
            storageBucket: "craftersmc-guides.appspot.com",
            messagingSenderId: "647290515320",
            appId: "1:647290515320:web:44e1be1528c86af00d628d",
            measurementId: "G-K3WGXSF9DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let authContainer, authButton, userDropdown, logoutButton, loginModal, emailInput, passwordInput, loginButton, signupButton, authError, closeButton;

        function initializeAuthDOMElements() {
            authContainer = document.getElementById('authContainer');
            authButton = document.getElementById('authButton');
            userDropdown = document.getElementById('userDropdown');
            logoutButton = document.getElementById('logoutButton');
            loginModal = document.getElementById('loginModal');
            emailInput = document.getElementById('emailInput');
            passwordInput = document.getElementById('passwordInput');
            loginButton = document.getElementById('loginButton');
            signupButton = document.getElementById('signupButton');
            authError = document.getElementById('authError');
            closeButton = loginModal ? loginModal.querySelector('.close-button') : null;
            attachEventListeners();

            // *** Ensure initial states are set correctly ***
            if (loginModal) loginModal.style.display = 'none'; // Ensure modal is hidden initially
            if (userDropdown) userDropdown.style.display = 'none'; // Ensure dropdown is hidden initially
        }

        function openLoginModal() {
            if (loginModal) {
                loginModal.style.display = 'block';
                if (authError) authError.textContent = '';
            } else {
                console.error("Login modal element not found.");
            }
        }

        function closeLoginModal() {
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        auth.onAuthStateChanged(user => {
            if (!authButton) {
                console.warn("Auth button not found, cannot update state.");
                return;
             }

            if (user) {
                // --- USER IS LOGGED IN ---
                closeLoginModal(); // Ensure login modal is closed if it was somehow open
                authButton.innerHTML = ''; // Clear default icon

                // Display PFP or Icon
                if (user.photoURL) { /* ... PFP logic ... */
                    const img = document.createElement('img');
                    img.src = user.photoURL;
                    img.alt = "P";
                    img.classList.add('profile-pic');
                    authButton.appendChild(img);
                } else { /* ... Fallback icon logic ... */
                    const userIcon = document.createElement('span');
                    userIcon.classList.add('material-icons');
                    userIcon.textContent = 'person';
                    authButton.appendChild(userIcon);
                }

                // *** Requirement: Clicking PFP shows Logout ***
                // Assign click handler to TOGGLE the dropdown visibility
                authButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent window click handler closing it
                    if (userDropdown) { // Check if dropdown exists
                       // Toggle display based on current state
                       userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                    }
                };
                // *** Requirement: Logout button hidden initially ***
                // Ensure dropdown (containing logout) is hidden when state changes to logged in
                if (userDropdown) userDropdown.style.display = 'none';

            } else {
                // --- USER IS LOGGED OUT ---
                // Set PFP button to show login icon
                authButton.innerHTML = '<span class="material-icons">help_outline</span>';
                // *** Requirement: Logout button not shown when logged out ***
                // Ensure dropdown (containing logout) is hidden
                 if (userDropdown) userDropdown.style.display = 'none';

                // *** Requirement: Clicking PFP opens Login Modal ***
                // Assign click handler to OPEN the login modal
                authButton.onclick = openLoginModal;
            }
        });

        function attachEventListeners() {
            // Login Button (inside modal)
            loginButton?.addEventListener('click', () => { /* ... login logic ... */
                if (!emailInput || !passwordInput || !authError) return;
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.textContent = '';
                if (!email || !password) { authError.textContent = 'Please enter email and password.'; return; }
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => console.log("Login successful"))
                    .catch(error => { authError.textContent = `Login failed: ${error.message.replace('Firebase: ', '')}`; });
            });

            // Signup Button (inside modal)
            signupButton?.addEventListener('click', () => { /* ... signup logic ... */
                if (!emailInput || !passwordInput || !authError) return;
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.textContent = '';
                if (!email || !password) { authError.textContent = 'Please enter email and password.'; return; }
                if (password.length < 6) { authError.textContent = 'Password must be at least 6 characters.'; return; }
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => console.log("Sign up successful"))
                    .catch(error => { authError.textContent = `Sign up failed: ${error.message.replace('Firebase: ', '')}`; });
            });

            // Logout Button (inside dropdown)
            logoutButton?.addEventListener('click', (e) => { /* ... logout logic ... */
                e.preventDefault();
                auth.signOut()
                    .then(() => console.log("Logout successful"))
                    .catch(error => console.error("Logout Error:", error));
                if(userDropdown) userDropdown.style.display = 'none'; // Hide dropdown after logout
            });

            // Close modal listeners
            closeButton?.addEventListener('click', closeLoginModal);
             window.addEventListener('click', function(event) {
                 if (loginModal && event.target == loginModal) closeLoginModal();
                 if (authContainer && userDropdown && !authContainer.contains(event.target)) userDropdown.style.display = 'none';
             });
            window.addEventListener('keydown', function(event) { /* ... ESC key logic ... */
                 if (event.key === 'Escape' || event.key === 'Esc') {
                     if (loginModal && loginModal.style.display === 'block') closeLoginModal();
                     if (userDropdown && userDropdown.style.display === 'block') userDropdown.style.display = 'none';
                 }
             });
        } // end attachEventListeners

        // Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', initializeAuthDOMElements);

    } // End of window.firebaseInitialized check

    // Define elsewhere
    function toggleSidebar() { console.log("Toggle Sidebar clicked (define this function)"); }
                        </script>
