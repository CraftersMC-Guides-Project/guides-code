<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<nav class="navbar">
    <span class="menu-icon material-icons" onclick="toggleSidebar()">menu</span>

    <div class="right">
        <div id="authContainer">
            <button id="authButton" class="auth-button">
                <span class="material-icons">help_outline</span> </button>
            <div id="userDropdown" class="dropdown-content">
                <a href="#" id="logoutButton">Logout</a>
                </div>
        </div>
    </div>
</nav>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLoginModal()">&times;</span>
        <h2>Login / Sign Up</h2>
        <div id="authError" class="error-message"></div>

        <form id="emailPasswordForm" onsubmit="return false;"> <input type="email" id="emailInput" placeholder="Email" required>
            <input type="password" id="passwordInput" placeholder="Password" required>
            <button type="button" id="loginButton">Login</button>
            <button type="button" id="signupButton">Sign Up</button>
        </form>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>

<script>
    // Ensure this script runs only once, even if navbar is included multiple times improperly
    if (!window.firebaseInitialized) {
        window.firebaseInitialized = true;

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9HDieVtkTu_PrSumxoDi1plXduu-J5pg", // Keep secure via backend rules/App Check
            authDomain: "craftersmc-guides.firebaseapp.com",
            projectId: "craftersmc-guides",
            storageBucket: "craftersmc-guides.appspot.com",
            messagingSenderId: "647290515320",
            appId: "1:647290515320:web:44e1be1528c86af00d628d",
            measurementId: "G-K3WGXSF9DQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // DOM Elements (ensure these IDs are unique on the final page)
        // Use try/catch or check for existence if elements might not be present when script runs
        let authContainer, authButton, userDropdown, logoutButton, loginModal, emailInput, passwordInput, loginButton, signupButton, authError, closeButton;

        function initializeAuthDOMElements() {
            authContainer = document.getElementById('authContainer');
            authButton = document.getElementById('authButton');
            userDropdown = document.getElementById('userDropdown');
            logoutButton = document.getElementById('logoutButton');
            loginModal = document.getElementById('loginModal');
            emailInput = document.getElementById('emailInput');
            passwordInput = document.getElementById('passwordInput');
            loginButton = document.getElementById('loginButton');
            signupButton = document.getElementById('signupButton');
            authError = document.getElementById('authError');
            // Find close button relative to modal only if modal exists
            closeButton = loginModal ? loginModal.querySelector('.close-button') : null;

             // Add event listeners only if elements exist
             attachEventListeners();
        }

        // --- Modal Functions ---
        function openLoginModal() {
            if (loginModal) {
                loginModal.style.display = 'block'; // Assumes CSS handles the appearance
                 if (authError) authError.textContent = ''; // Clear previous errors
            } else {
                console.error("Login modal element not found.");
            }
        }

        function closeLoginModal() {
            if (loginModal) {
                loginModal.style.display = 'none'; // Assumes CSS handles hiding
            }
        }

        // --- Auth State Change Handler ---
        auth.onAuthStateChanged(user => {
            // Ensure elements are available before trying to manipulate them
             if (!authButton || !userDropdown) {
                console.warn("Auth UI elements not found, cannot update state.");
                 return;
             }

            if (user) {
                // --- User is Signed In ---
                closeLoginModal(); // Close modal if it was open
                authButton.innerHTML = ''; // Clear previous content

                // Display PFP or Icon (relies on CSS for '.profile-pic' class)
                if (user.photoURL) {
                    const img = document.createElement('img');
                    img.src = user.photoURL;
                    img.alt = "P"; // Profile Alt
                    img.classList.add('profile-pic'); // CSS class for styling
                    authButton.appendChild(img);
                } else {
                    // Fallback Icon
                    const userIcon = document.createElement('span');
                    userIcon.classList.add('material-icons');
                    userIcon.textContent = 'person';
                    authButton.appendChild(userIcon);
                }

                // Configure auth button for logged-in state (toggle dropdown)
                authButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent window click handler from closing it immediately
                    // Toggle display (relies on CSS for '.dropdown-content' visibility)
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                };
                userDropdown.style.display = 'none'; // Hide dropdown initially

            } else {
                // --- User is Signed Out ---
                authButton.innerHTML = '<span class="material-icons">help_outline</span>'; // Show login icon
                if (userDropdown) userDropdown.style.display = 'none'; // Hide dropdown

                // Configure auth button for logged-out state (open modal)
                authButton.onclick = openLoginModal;
            }
        });

        // --- Event Listeners ---
        function attachEventListeners() {
            // Login
            loginButton?.addEventListener('click', () => {
                if (!emailInput || !passwordInput || !authError) return;
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.textContent = '';

                if (!email || !password) {
                    authError.textContent = 'Please enter email and password.'; return;
                }

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => console.log("Login successful")) // UI updates via onAuthStateChanged
                    .catch(error => {
                        console.error("Login Error:", error);
                        authError.textContent = `Login failed: ${error.message.replace('Firebase: ', '')}`;
                    });
            });

            // Sign Up
            signupButton?.addEventListener('click', () => {
                if (!emailInput || !passwordInput || !authError) return;
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.textContent = '';

                if (!email || !password) {
                    authError.textContent = 'Please enter email and password.'; return;
                }
                if (password.length < 6) {
                    authError.textContent = 'Password must be at least 6 characters.'; return;
                }

                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => console.log("Sign up successful")) // UI updates via onAuthStateChanged
                    .catch(error => {
                        console.error("Sign Up Error:", error);
                        authError.textContent = `Sign up failed: ${error.message.replace('Firebase: ', '')}`;
                    });
            });

            // Logout
            logoutButton?.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                auth.signOut()
                    .then(() => console.log("Logout successful"))
                    .catch(error => console.error("Logout Error:", error));
                if(userDropdown) userDropdown.style.display = 'none'; // Hide immediately
            });

            // Close modal listeners
            closeButton?.addEventListener('click', closeLoginModal);

            // Close modal/dropdown on clicks outside or ESC key
            window.addEventListener('click', function(event) {
                 // Close modal if clicked outside content
                 if (loginModal && event.target == loginModal) {
                     closeLoginModal();
                 }
                 // Close dropdown if clicked outside auth container
                 if (authContainer && userDropdown && !authContainer.contains(event.target)) {
                     userDropdown.style.display = 'none';
                 }
             });

            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    if (loginModal && loginModal.style.display === 'block') { // Check if modal is open
                        closeLoginModal();
                    }
                    if (userDropdown && userDropdown.style.display === 'block') { // Check if dropdown is open
                        userDropdown.style.display = 'none';
                    }
                }
            });
        } // end attachEventListeners

        // Initialize DOM elements and listeners after the DOM is ready
        // Use DOMContentLoaded to ensure elements exist before trying to access them
        document.addEventListener('DOMContentLoaded', initializeAuthDOMElements);
        // Or if this script might be placed *after* the HTML:
        // initializeAuthDOMElements();

    } // End of window.firebaseInitialized check

    // --- Sidebar Function Placeholder ---
    // Define this function in your main site's script
    function toggleSidebar() {
        console.log("Toggle Sidebar clicked (define this function)");
        // Example: document.getElementById('mySidebar').classList.toggle('active');
    }

                    </script>
