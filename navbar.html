<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<nav class="navbar">
    <span class="menu-icon material-icons" onclick="toggleSidebar()">menu</span>
    <div class="right">
        <button id="darkModeToggle" class="dark-mode-button">
            <span class="material-icons">brightness_4</span>
        </button>
        <div id="authContainer">
            <button id="authButton" class="auth-button">
                <span class="material-icons">help_outline</span>
            </button>
            <div id="userDropdown" class="dropdown-content">
                <a href="#" id="logoutButton">Logout</a>
            </div>
        </div>
    </div>
</nav>

<div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" onclick="closeLoginModal()">&times;</span>
        <h2>Login / Sign Up</h2>
        <div id="authError" class="error-message"></div>
        <form id="emailPasswordForm" onsubmit="return false;">
            <input type="email" id="emailInput" placeholder="Email" required>
            <input type="password" id="passwordInput" placeholder="Password" required>
            <button type="button" id="loginButton">Login</button>
            <button type="button" id="signupButton">Sign Up</button>
        </form>
    </div>
</div>

<script>
    if (!window.firebaseInitialized) {
        window.firebaseInitialized = true;

        const firebaseConfig = {
            apiKey: "AIzaSyC9HDieVtkTu_PrSumxoDi1plXduu-J5pg",
            authDomain: "craftersmc-guides.firebaseapp.com",
            projectId: "craftersmc-guides",
            storageBucket: "craftersmc-guides.appspot.com",
            messagingSenderId: "647290515320",
            appId: "1:647290515320:web:44e1be1528c86af00d628d",
            measurementId: "G-K3WGXSF9DQ"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let authContainer, authButton, userDropdown, logoutButton, loginModal, emailInput, passwordInput, loginButton, signupButton, authError, closeButton, darkModeToggle;

        function initializeAuthDOMElements() {
            authContainer = document.getElementById('authContainer');
            authButton = document.getElementById('authButton');
            userDropdown = document.getElementById('userDropdown');
            logoutButton = document.getElementById('logoutButton');
            loginModal = document.getElementById('loginModal');
            emailInput = document.getElementById('emailInput');
            passwordInput = document.getElementById('passwordInput');
            loginButton = document.getElementById('loginButton');
            signupButton = document.getElementById('signupButton');
            authError = document.getElementById('authError');
            closeButton = loginModal ? loginModal.querySelector('.close-button') : null;
            darkModeToggle = document.getElementById('darkModeToggle'); // Get dark mode toggle

            attachEventListeners();

            // Ensure initial dropdown state
            if (userDropdown) userDropdown.style.display = 'none';

            // Initialize dark mode (if you have a saved preference)
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        function openLoginModal() {
            if (loginModal) {
                loginModal.style.display = 'block';
                if (authError) authError.textContent = '';
            } else {
                console.error("Login modal element not found.");
            }
        }

        function closeLoginModal() {
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        function updateAuthButton(user) {
            if (!authButton) {
                console.warn("Auth button not found, cannot update state.");
                return;
            }
            authButton.innerHTML = ''; // Clear previous content
            authButton.onclick = null; // Remove any existing click handler

            if (user) {
                // --- USER IS LOGGED IN ---
                closeLoginModal(); // Ensure login modal is closed

                // Display PFP or Icon
                if (user.photoURL) {
                    const img = document.createElement('img');
                    img.src = user.photoURL;
                    img.alt = "P";
                    img.classList.add('profile-pic');
                    authButton.appendChild(img);
                } else {
                    const userIcon = document.createElement('span');
                    userIcon.classList.add('material-icons');
                    userIcon.textContent = 'person';
                    authButton.appendChild(userIcon);
                }

                // Click to toggle dropdown
                authButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (userDropdown) {
                       userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                    }
                });
                if (userDropdown) userDropdown.style.display = 'none'; // Ensure dropdown is initially hidden
            } else {
                // --- USER IS LOGGED OUT ---
                authButton.innerHTML = '<span class="material-icons">help_outline</span>';

                // Click to open login modal
                authButton.addEventListener('click', openLoginModal);
                if (userDropdown) userDropdown.style.display = 'none'; // Ensure dropdown is hidden
            }
        }

        auth.onAuthStateChanged(updateAuthButton);

        function attachEventListeners() {
            // Login Button
            loginButton?.addEventListener('click', () => {
                if (!emailInput || !passwordInput || !authError) return;
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.textContent = '';
                if (!email || !password) { authError.textContent = 'Please enter email and password.'; return; }
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => console.log("Login successful"))
                    .catch(error => { authError.textContent = `Login failed: ${error.message.replace('Firebase: ', '')}`; });
                });

            // Signup Button
            signupButton?.addEventListener('click', () => {
                if (!emailInput || !passwordInput || !authError) return;
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.textContent = '';
                if (!email || !password) { authError.textContent = 'Please enter email and password.'; return; }
                if (password.length < 6) { authError.textContent = 'Password must be at least 6 characters.'; return; }
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => console.log("Sign up successful"))
                    .catch(error => { authError.textContent = `Sign up failed: ${error.message.replace('Firebase: ', '')}`; });
            });

            // Logout Button
            logoutButton?.addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut()
                    .then(() => console.log("Logout successful"))
                    .catch(error => console.error("Logout Error:", error));
                if(userDropdown) userDropdown.style.display = 'none';
            });

            // Close modal listeners
            closeButton?.addEventListener('click', closeLoginModal);
             window.addEventListener('click', function(event) {
                 if (loginModal && event.target == loginModal) closeLoginModal();
                 if (authContainer && userDropdown && !authContainer.contains(event.target)) userDropdown.style.display = 'none';
             });
            window.addEventListener('keydown', function(event) {
                 if (event.key === 'Escape' || event.key === 'Esc') {
                     if (loginModal && loginModal.style.display === 'block') closeLoginModal();
                     if (userDropdown && userDropdown.style.display === 'block') userDropdown.style.display = 'none';
                 }
             });

            // Dark Mode Toggle Listener
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                });
            }
        } // end attachEventListeners

        document.addEventListener('DOMContentLoaded', initializeAuthDOMElements);

    } // End of window.firebaseInitialized check

    function toggleSidebar() { console.log("Toggle Sidebar clicked (define this function)"); }
</script>
