<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    /* Header Styles to position profile card */
    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px; /* Add some padding */
    }

    /* New container for all top-right UI elements */
    #top-right-ui-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        align-items: flex-end; /* Aligns items to the right */
        gap: 10px; /* Creates space between the card and the button */
    }

    .profile-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 50px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .profile-card:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }

    .profile-card-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }

    .profile-card-name {
      font-weight: 500;
      font-size: 14px;
    }

    .dev-label {
      color: #ff4d4d;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .login-btn {
        background-color: #5865F2;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dev-btn {
        background-color: #313131;
        color: #FFFFFF;
        padding: 10px 15px;
        border: 2px solid #555;
        border-radius: 4px;
        font-weight: normal;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
    }

    .dev-btn:hover {
        background-color: #424242;
    }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9998;
    }
    .modal-content {
        background: #2a2a2a; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px;
        border: 1px solid #444;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content input { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 15px; background: #1a1a1a; border: 1px solid #555; color: white; border-radius: 5px;}
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    .modal-btn-save { background-color: #28a745; color: white; }
    .modal-btn-cancel { background-color: #6c757d; color: white; }

    /* Toggle Switch Styles */
    .toggle-switch-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Toast Notification */
    .toast-notification {
        position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
        padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500;
        transition: bottom 0.5s ease-in-out; z-index: 10001;
    }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
  </style>
</head>

<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>
  
  <!-- New container for top-right elements -->
  <div id="top-right-ui-container">
    <div id="profile-card-container"></div>
    <div id="dev-actions-container"></div>
  </div>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="item-material-icons" id="scrollToTopBtn">north</span>
  <div class="item-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn item-filter-btn" data-nature="reset">Reset Filter</button>
  </div>
  <div class="item-container" id="itemDetails">
    <p>Loading item details...</p>
  </div>
  <div class="item-nav-buttons">
    <button id="prevItemBtn" class="btn" type="button">&larr; Previous</button>
    <button id="nextItemBtn" class="btn" type="button">Next &rarr;</button>
  </div>
  <div id="footer"></div>

  <!-- Update Price Modal -->
  <div id="price-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Update Item Details</h3>
        <label for="marketPriceInput">Market Price:</label>
        <input type="number" id="marketPriceInput" placeholder="Enter new market price">
        <label for="npcPriceInput">NPC Trade Price:</label>
        <input type="number" id="npcPriceInput" placeholder="Enter new NPC price">
        <div class="toggle-switch-container">
            <span>Public Status:</span>
            <label class="switch">
                <input type="checkbox" id="publicStatusToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="modal-actions">
            <button id="cancel-price-update" class="modal-btn modal-btn-cancel">Cancel</button>
            <button id="save-price-update" class="modal-btn modal-btn-save">Save Changes</button>
        </div>
    </div>
  </div>

  <script>
    const GITHUB_REPO = "CraftersMC-Guides-Project/guides-code";
    const MARKET_FILE_PATH = "market/market.txt";
    const PRICES_FILE_PATH = "market/mprices.txt";
    const GITHUB_BRANCH = "main";
    let isDevUser = false; // Global flag for dev status

    // --- Helper Function to Get Cookie ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    // --- Function to load the profile card ---
    async function loadProfileCard() {
        const storedUser = getCookie("discordUser");
        const profileContainer = document.getElementById("profile-card-container");
        
        let devIds = [];
        try {
            const response = await fetch('/devs.txt');
            if (response.ok) {
                const text = await response.text();
                devIds = text.split('\n').map(id => id.trim()).filter(id => id);
            }
        } catch (error) {
            console.error('Could not load or parse devs.txt:', error);
        }

        if (storedUser) {
            const user = JSON.parse(storedUser);
            const displayName = user.global_name || user.username;
            isDevUser = devIds.includes(user.id);

            profileContainer.innerHTML = `
                <a href="/profile" class="profile-card">
                    <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" alt="Avatar" class="profile-card-avatar">
                    <span class="profile-card-name">
                        ${displayName}
                        ${isDevUser ? '<span class="dev-label">[DEV]</span>' : ''}
                    </span>
                </a>
            `;
        } else {
            profileContainer.innerHTML = '';
        }
    }

    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');

      if (itemId) {
        try {
          const [marketRes, pricesRes] = await Promise.all([
            fetch('market/market.txt'),
            fetch('market/mprices.txt')
          ]);

          const marketData = await marketRes.text();
          const pricesData = await pricesRes.text();

          const items = JSON.parse(marketData);
          const item = items.find(item => item.id === itemId);

          if (item) {
            const isPublic = item.hasOwnProperty("public") ? item.public : true;
            if (!isPublic && !isDevUser) {
              document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`;
              document.getElementById("dev-actions-container").innerHTML = "";
              return;
            }

            if (isDevUser) {
                const devActionsContainer = document.getElementById("dev-actions-container");
                devActionsContainer.innerHTML = `
                    <button class="dev-btn" onclick="openUpdateModal()">
                        <span class="material-icons">edit</span>
                        Edit Details
                    </button>
                `;
            }

            const pricesMap = new Map();
            const npcPricesMap = new Map();

            pricesData.split('\n').forEach(line => {
                const [id, arrayStr] = line.split(':').map(part => part.trim());
                if (id && arrayStr) {
                    try {
                        const parsedArray = JSON.parse(arrayStr);
                        if (Array.isArray(parsedArray) && parsedArray.length >= 2) {
                            pricesMap.set(id, parsedArray[1]);
                            if (parsedArray.length >= 3) {
                                npcPricesMap.set(id, parsedArray[2]);
                            }
                        }
                    } catch (e) {}
                }
            });

            const itemDetailsDiv = document.getElementById('itemDetails');
            const marketPrice = pricesMap.get(item.id) || item.price || "N/A";
            const npcPrice = npcPricesMap.get(item.id) || "N/A";

            itemDetailsDiv.innerHTML = `
              <h1>${item.name}</h1>
              ${item.picture ? `<img src="${item.picture}" alt="${item.name}">` : ''}
              ${item.rarity ? `<div class="item-rarity-display" id="rarityDisplay"><img class="item-rarity" src="img/rarity/${item.rarity}.webp"></div>` : ''}
              <p><strong class="item-strong">ID:</strong> ${item.id}</p>
              <div class="item-price-container">
                <p class="item-price"><strong class="item-strong">Market Price:</strong> ${formatPrice(marketPrice)}</p><hr width="150px">
                <p class="item-price"><strong class="item-strong">NPC Trade Price:</strong> ${formatPrice(npcPrice)}</p>
              </div>
            `;
          } else {
            document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`;
          }
        } catch (error) {
          console.error('Error loading item details:', error);
          document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: Could not load item details.</h2>`;
        }
      }
    }

    // --- Update Modal Logic ---
    async function openUpdateModal() {
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('item');
        
        try {
            const [pricesRes, marketRes] = await Promise.all([
                fetch('market/mprices.txt', { cache: 'no-cache' }),
                fetch('market/market.txt', { cache: 'no-cache' })
            ]);

            const pricesData = await pricesRes.text();
            const marketData = await marketRes.json();

            const item = marketData.find(i => i.id === itemId);
            if(item) {
                document.getElementById('publicStatusToggle').checked = item.public;
            }

            const lines = pricesData.split('\n');
            const line = lines.find(l => l.startsWith(itemId + ':'));
            if (line) {
                const arrayStr = line.split(':')[1].trim();
                const parsedArray = JSON.parse(arrayStr);
                document.getElementById('marketPriceInput').value = parsedArray[1] || '';
                document.getElementById('npcPriceInput').value = parsedArray[2] || '';
            }
        } catch (e) {
            showToast('Could not load current item data.', 'error');
        }

        document.getElementById('price-modal').style.display = 'flex';
    }

    document.getElementById('cancel-price-update').addEventListener('click', () => {
        document.getElementById('price-modal').style.display = 'none';
    });

    document.getElementById('save-price-update').addEventListener('click', async () => {
        const token = getCookie('githubToken');
        if (!token) {
            showToast('GitHub token not found. Please add it in your profile.', 'error');
            return;
        }

        showToast('Saving changes to GitHub...', 'info');
        
        // Call the two update functions sequentially
        const pricesUpdated = await updatePrices(token);
        if (pricesUpdated) {
            const statusUpdated = await updatePublicStatus(token);
            if (statusUpdated) {
                showToast('All changes saved successfully!', 'success');
                document.getElementById('price-modal').style.display = 'none';
                setTimeout(() => location.reload(), 1500);
            }
        }
    });

    async function updatePrices(token) {
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('item');
        const newMarketPrice = document.getElementById('marketPriceInput').value;
        const newNpcPrice = document.getElementById('npcPriceInput').value;

        if (newMarketPrice === '' || newNpcPrice === '') {
            showToast('Both price fields are required.', 'error');
            return false;
        }

        try {
            const metaUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${PRICES_FILE_PATH}?ref=${GITHUB_BRANCH}`;
            const metaRes = await fetch(metaUrl, { headers: { Authorization: `token ${token}` }, cache: 'no-cache' });
            if (!metaRes.ok) throw new Error('Failed to fetch price file metadata.');
            const fileData = await metaRes.json();
            const currentContent = atob(fileData.content);
            const fileSha = fileData.sha;

            const lines = currentContent.split('\n');
            const updatedLines = lines.map(line => {
                if (line.startsWith(itemId + ':')) {
                    const parts = line.split(':');
                    const parsedArray = JSON.parse(parts[1].trim());
                    return `${itemId}: ${JSON.stringify([parsedArray[0], parseInt(newMarketPrice), parseInt(newNpcPrice)])}`;
                }
                return line;
            });
            
            const updatedContent = updatedLines.join('\n');

            const updateUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${PRICES_FILE_PATH}`;
            const updateRes = await fetch(updateUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Update price for item ${itemId}`,
                    content: btoa(unescape(encodeURIComponent(updatedContent))),
                    sha: fileSha,
                    branch: GITHUB_BRANCH
                })
            });

            if (!updateRes.ok) {
                 const errorData = await updateRes.json();
                 throw new Error(`Price Update Error: ${errorData.message}`);
            }
            return true; // Success
        } catch (error) {
            console.error('Error updating prices:', error);
            showToast(`Error: ${error.message}`, 'error');
            return false; // Failure
        }
    }

    async function updatePublicStatus(token) {
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('item');
        const newStatus = document.getElementById('publicStatusToggle').checked;

        try {
            const metaUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${MARKET_FILE_PATH}?ref=${GITHUB_BRANCH}`;
            const metaRes = await fetch(metaUrl, { headers: { Authorization: `token ${token}` }, cache: 'no-cache' });
            if (!metaRes.ok) throw new Error('Failed to fetch market file metadata.');
            const fileData = await metaRes.json();
            const currentContent = atob(fileData.content);
            const fileSha = fileData.sha;

            const items = JSON.parse(currentContent);
            const itemIndex = items.findIndex(i => i.id === itemId);
            if (itemIndex === -1) throw new Error('Item not found in market.txt');
            
            items[itemIndex].public = newStatus;

            const updatedContent = JSON.stringify(items, null, 4);

            const updateUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${MARKET_FILE_PATH}`;
            const updateRes = await fetch(updateUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Set item ${itemId} public status to ${newStatus}`,
                    content: btoa(unescape(encodeURIComponent(updatedContent))),
                    sha: fileSha,
                    branch: GITHUB_BRANCH
                })
            });

            if (!updateRes.ok) {
                 const errorData = await updateRes.json();
                 throw new Error(`Public Status Update Error: ${errorData.message}`);
            }
            return true; // Success
        } catch (error) {
            console.error('Error toggling public mode:', error);
            showToast(`Error: ${error.message}`, 'error');
            return false; // Failure
        }
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    // --- Other Functions ---
    function formatPrice(price) {
      if (price === "N/A" || price === "NAN") {
        return `<span class="item-price-img">N/A</span>`;
      }
      return `<span class="item-price-img">${Number(price).toLocaleString()} <img src="img/coin.png" alt="Coin"></span>`;
    }

    document.getElementById("prevItemBtn").addEventListener("click", () => {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (!isNaN(id) && id > 1) {
        window.location.href = `item?item=${id - 1}`;
      }
    });

    document.getElementById("nextItemBtn").addEventListener("click", () => {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (!isNaN(id)) {
        window.location.href = `item?item=${id + 1}`;
      }
    });

    // --- Load page content ---
    async function initializePage() {
        await loadProfileCard(); // Load profile first to set the isDevUser flag
        await loadItemDetails(); // Then load item details which depends on the flag
    }

    initializePage();
  </script>
</body>
</html>
