<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    /* Header Styles to position profile card */
    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px; /* Add some padding */
    }

    /* Profile Card Styles */
    #profile-card-container {
      position: fixed; /* Use fixed positioning */
      top: 80px;      /* Position it lower from the top */
      right: 20px;     /* Position it on the right */
      z-index: 1001;
    }

    .profile-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 50px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .profile-card:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }

    .profile-card-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }

    .profile-card-name {
      font-weight: 500;
      font-size: 14px;
    }

    .dev-label {
      color: #ff4d4d;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .login-btn {
        background-color: #5865F2;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
  </style>
</head>

<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <!-- The profile card container is now outside the header for better positioning control -->
  <div id="profile-card-container"></div>
  <div class="top">
    <!-- Header content goes here -->
  </div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="item-material-icons" id="scrollToTopBtn">north</span>
  <div class="item-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn item-filter-btn" data-nature="reset">Reset Filter</button>
  </div>
  <div class="item-container" id="itemDetails">
    <p>Loading item details...</p>
  </div>
  <div class="item-nav-buttons">
    <button id="prevItemBtn" class="btn" type="button">&larr; Previous</button>
    <button id="nextItemBtn" class="btn" type="button">Next &rarr;</button>
  </div>
  <div id="footer"></div>

  <script>
    // --- Helper Function to Get Cookie ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    // --- Function to load the profile card ---
    function loadProfileCard() {
        const storedUser = getCookie("discordUser");
        const container = document.getElementById("profile-card-container");

        if (storedUser) {
            const user = JSON.parse(storedUser);
            const displayName = user.global_name || user.username;
            const isDev = user.id === '783972385882767400';

            container.innerHTML = `
                <a href="/profile" class="profile-card">
                    <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" alt="Avatar" class="profile-card-avatar">
                    <span class="profile-card-name">
                        ${displayName}
                        ${isDev ? '<span class="dev-label">[DEV]</span>' : ''}
                    </span>
                </a>
            `;
        } else {
            container.innerHTML = `
                <a href="/login" class="login-btn">
                    <span class="material-icons">login</span>
                    Login
                </a>
            `;
        }
    }


    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');

      if (itemId) {
        try {
          const [marketRes, pricesRes] = await Promise.all([
            fetch('market/market.txt'),
            fetch('market/mprices.txt')
          ]);

          const marketData = await marketRes.text();
          const pricesData = await pricesRes.text();

          const items = JSON.parse(marketData);
          const item = items.find(item => item.id === itemId);

          const pricesMap = new Map();
          const npcPricesMap = new Map();

          pricesData.split('\n').forEach(line => {
            const [id, arrayStr] = line.split(':').map(part => part.trim());
            if (id && arrayStr) {
              try {
                const parsedArray = JSON.parse(arrayStr);
                if (Array.isArray(parsedArray) && parsedArray.length >= 2) {
                  pricesMap.set(id, parsedArray[1]);
                  if (parsedArray.length >= 3) {
                    npcPricesMap.set(id, parsedArray[2]);
                  }
                }
              } catch (e) {}
            }
          });

          if (item) {
            const isPublic = item.hasOwnProperty("public") ? item.public : true;
            if (!isPublic) {
              document.getElementById('itemDetails').innerHTML = `
                <h2 style="color:red;">Error: This item doesn't exist.</h2>
              `;
              return;
            }

            const itemDetailsDiv = document.getElementById('itemDetails');
            const marketPrice = pricesMap.get(item.id) || item.price || "N/A";
            const npcPrice = npcPricesMap.get(item.id) || "N/A";

            itemDetailsDiv.innerHTML = `
              <h1>${item.name}</h1>
              ${item.picture ? `<img src="${item.picture}" alt="${item.name}">` : ''}
              ${item.rarity ? `<div class="item-rarity-display" id="rarityDisplay"><img class="item-rarity" src="img/rarity/${item.rarity}.webp"></div>` : ''}
              <p><strong class="item-strong">ID:</strong> ${item.id}</p>
              <div class="item-price-container">
                <p class="item-price"><strong class="item-strong">Market Price:</strong> ${formatPrice(marketPrice)}</p><hr width="150px">
                <p class="item-price"><strong class="item-strong">NPC Trade Price:</strong> ${formatPrice(npcPrice)}</p>
              </div>
            `;
          } else {
            document.getElementById('itemDetails').innerHTML = `
              <h2 style="color:red;">Error: This item doesn't exist.</h2>
            `;
          }
        } catch (error) {
          console.error('Error loading item details:', error);
          document.getElementById('itemDetails').innerHTML = `
            <h2 style="color:red;">Error: Could not load item details.</h2>
          `;
        }
      }
    }

    function formatPrice(price) {
      if (price === "N/A" || price === "NAN") {
        return `<span class="item-price-img">N/A</span>`;
      }
      return `<span class="item-price-img">${Number(price).toLocaleString()} <img src="img/coin.png" alt="Coin"></span>`;
    }

    document.getElementById("prevItemBtn").addEventListener("click", () => {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (!isNaN(id) && id > 1) {
        window.location.href = `item?item=${id - 1}`;
      }
    });

    document.getElementById("nextItemBtn").addEventListener("click", () => {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (!isNaN(id)) {
        window.location.href = `item?item=${id + 1}`;
      }
    });

    // --- Load page content ---
    loadItemDetails();
    loadProfileCard();
  </script>
</body>
</html>
