<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="assets/cmc-icon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - CraftersMC</title>
    <link rel="stylesheet" href="css/essential.css">
    <style>
        /* [Previous CSS styles remain exactly the same] */
        body {
            color: #ffffff;
            font-family: MyFont, sans-serif;
            margin: 0;
            padding: 0;
        }
        .background {
            background: url("Backgrounds/IMG_4502.webp");
            background-blend-mode: multiply;
            background-size: cover;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8);
        }
        /* [Keep all other existing styles] */
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Back to Posts</a>
        <h1>Create New Post</h1>
        
        <form id="postForm">
            <!-- [Keep all existing form elements] -->
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // [Keep all existing authorization code]

            // Updated form submission handler
            document.getElementById('postForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const title = document.getElementById('postTitle').value.trim();
                const image = document.getElementById('postImage').value.trim();
                const content = document.getElementById('postContent').value.trim();
                const submitBtn = document.getElementById('submitBtn');
                const statusMessage = document.getElementById('statusMessage');
                
                if (!title || !image || !content) {
                    showStatus('Please fill in all required fields', 'error');
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Publishing...';
                statusMessage.style.display = 'none';
                
                const postId = Date.now();
                const postDate = new Date().toISOString();
                
                // Generate HTML content
                const htmlContent = `<!DOCTYPE html>
<html lang="en">
<!-- [Keep the same HTML template as before] -->
</html>`;

                try {
                    showStatus('Uploading post to Discord...', 'success');
                    
                    // Create FormData with the file
                    const formData = new FormData();
                    formData.append('file', new Blob([htmlContent], { type: 'text/html' }), `post_${postId}.html`);
                    formData.append('payload_json', JSON.stringify({
                        type: "new_post",
                        username: "CraftersMC Post Bot",
                        content: {
                            title: title,
                            post_id: postId,
                            date: postDate,
                            image: image,
                            content_preview: content.substring(0, 100) + '...'
                        }
                    }));

                    // Updated endpoint to /post
                    const webhookResponse = await fetch('https://webhook-manager.roumakdatta.workers.dev/post', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!webhookResponse.ok) {
                        let errorMsg = `Server error: ${webhookResponse.status}`;
                        try {
                            const errorData = await webhookResponse.json();
                            errorMsg = errorData.message || errorMsg;
                        } catch (e) {}
                        throw new Error(errorMsg);
                    }
                    
                    showStatus('Post created and sent to Discord successfully!', 'success');
                    document.getElementById('postForm').reset();
                    
                } catch (error) {
                    console.error('Post submission error:', error);
                    showStatus(`Failed to submit: ${error.message}`, 'error');
                    
                    // Additional debugging info
                    if (error.message.includes('Failed to fetch')) {
                        console.log('Network error - check:');
                        console.log('1. Internet connection');
                        console.log('2. CORS policies');
                        console.log('3. Worker endpoint availability');
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Publish Post';
                }
            });

            // [Keep helper functions like showStatus() and escapeHtml()]
        });

        // Improved error handling functions
        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        function escapeHtml(unsafe) {
            const div = document.createElement('div');
            div.textContent = unsafe || '';
            return div.innerHTML;
        }
    </script>
</body>
</html>
