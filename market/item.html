<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="js/script.js"></script>
  <style>
    .login-btn { background-color: #5865F2; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; transition: bottom 0.5s ease-in-out; z-index: 10001; white-space: pre-line; }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
    .private-item-highlight { border: 2px dashed #ff9800; background-color: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px; }

    .exp-display{
      display: block;
    }
  </style>
  <link rel="stylesheet" href="css/essential.css">
  <link rel="stylesheet" href="css/item.css">
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <!-- Button will be injected here if allowed -->
  <div id="role-btn-container"></div>

  <!-- Modal for changing price -->
  <div id="price-modal">
    <div class="modal-content">
      <button class="btn-close" onclick="closePriceModal()">Ã—</button>
      <h2 id="modal-item-name">Item Name</h2>

      <label for="modal-market-price">Market Price</label>
      <input type="number" id="modal-market-price" />
      <label for="modal-npc-price">NPC Price</label>
      <input type="number" id="modal-npc-price" />
      <button class="btn-submit" onclick="submitPriceModal()">Submit</button>
    </div>
  </div>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="item-material-icons" id="scrollToTopBtn">north</span>

  <div class="gap"></div>

  <div class="item-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn item-filter-btn" data-nature="reset">Reset Filter</button>
  </div>
  <div class="expected">Expected!</div>
        <input class="expected-input" type="number">
      <div class="expected-btn">DONE!</div>
  <div class="item-container" id="itemDetails"><p>Loading item details...</p></div>
  <div class="item-nav-buttons">
    <button id="prevItemBtn" class="btn" type="button">&larr; Previous</button>
    <button id="nextItemBtn" class="btn" type="button">Next &rarr;</button>
  </div>
  <div id="footer"></div>

  <script>
    let isDevUser = false;
    let allItems = [];
    const expected = document.querySelector(".expected");
const expInput = document.querySelector(".expected-input");

expected.addEventListener("click", () => {
  expInput.classList.toggle("exp-display");
});


    async function fetchAllItems() { try { const res = await fetch("market/market.txt"); allItems = await res.json(); } catch (e) { console.error("Could not fetch market.txt", e); } }

    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');
      if (itemId) {
        try {
          const storedUser = getCookie("discordUser");
          if (storedUser) {
            let devIds = [];
            try {
              const response = await fetch('/devs.txt');
              if (response.ok) {
                const text = await response.text();
                devIds = text.split('\n').map(id => id.trim()).filter(id => id);
              }
            } catch (error) { console.error('Error TwT:', error); }
            const user = JSON.parse(storedUser);
            isDevUser = devIds.includes(user.id);
          }
          const [marketRes, pricesRes] = await Promise.all([fetch('market/market.txt'), fetch('market/mprices.txt')]);
          const marketData = await marketRes.text();
          const pricesData = await pricesRes.text();
          const items = JSON.parse(marketData);
          const item = items.find(item => item.id === itemId);
          

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 100);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
    }

    function formatPrice(price) {
      if (price === "N/A" || price === "NAN" || price === null || price === undefined) { return `N/A`; }
      return `${Number(price).toLocaleString()}c`;
    }

    function goToPrevItem() {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (isNaN(id) || id <= 1) return;
      if (isDevUser) {
        window.location.href = `item.html?item=${id - 1}`;
      } else {
        let prevId = id - 1;
        while (prevId > 0) {
          const prevItem = allItems.find(i => i.id == prevId);
          if (prevItem && (prevItem.public === undefined || prevItem.public)) { window.location.href = `item.html?item=${prevId}`; return; }
          prevId--;
        }
      }
    }

    function goToNextItem() {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (isNaN(id)) return;
      if (isDevUser) {
        window.location.href = `item.html?item=${id + 1}`;
      } else {
        let nextId = id + 1;
        while (nextId <= allItems.length + 1000) {
          const nextItem = allItems.find(i => i.id == nextId);
          if (nextItem && (nextItem.public === undefined || nextItem.public)) { window.location.href = `item.html?item=${nextId}`; return; }
          nextId++;
        }
      }
    }

    function openPriceModal() {
      document.getElementById('price-modal').style.display = 'flex';
    }
    function closePriceModal() {
      document.getElementById('price-modal').style.display = 'none';
    }

    document.getElementById("prevItemBtn").addEventListener("click", goToPrevItem);
    document.getElementById("nextItemBtn").addEventListener("click", goToNextItem);

    async function initializePage() {
      await fetchAllItems();
      await loadItemDetails();
    }
    initializePage();
  </script>
</body>
</html>
