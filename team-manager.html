<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Team Manager</title>
  <style>
    :root {
      --bg:#0a0c10; --panel:#111827; --text:#e6edf3; --muted:#9ca3af;
      --primary:#2563eb; --danger:#dc2626; --success:#10b981; --glass:rgba(255,255,255,.05);
    }
    body {
      margin:0; min-height:100vh; background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,sans-serif; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container { max-width:1100px; width:100%; background:var(--panel); border-radius:16px; padding:24px; }
    h1 { text-align:center; margin-bottom:20px; }
    .grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
    .box { background:var(--glass); padding:14px; border-radius:12px; }
    .dev-list { list-style:none; margin:0; padding:0; max-height:350px; overflow:auto; }
    .dev-list li { display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,.04); border-radius:8px; }
    .profile { display:flex; align-items:center; gap:10px; }
    .profile img { width:40px; height:40px; border-radius:50%; }
    .profile-info { display:flex; flex-direction:column; }
    .profile-info .name { font-weight:600; }
    .profile-info .meta { font-size:12px; color:var(--muted); }
    .remove-btn { background:var(--danger); border:none; padding:6px 10px; border-radius:6px; color:white; cursor:pointer; }
    .add-row { display:flex; gap:10px; margin-top:14px; }
    .add-btn { background:var(--primary); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; }
    .save-btn { margin-top:16px; width:100%; background:var(--success); color:white; border:none; padding:14px; border-radius:10px; font-weight:600; cursor:pointer; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:-100px; background:#111; color:white; padding:10px 16px; border-radius:8px; transition:bottom .3s; }
    .toast.show { bottom:20px; }
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Manage Team Members</h1>
    <div class="grid">
      <div class="box"><h2>Developers</h2><ul id="devsList" class="dev-list"><li>Loading…</li></ul></div>
      <div class="box"><h2>Data Managers</h2><ul id="dmList" class="dev-list"><li>Loading…</li></ul></div>
      <div class="box"><h2>Managers</h2><ul id="mgrList" class="dev-list"><li>Loading…</li></ul></div>
    </div>
    <div class="add-row">
      <input id="newIdInput" placeholder="Discord ID" style="flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:transparent; color:var(--text)" />
      <select id="targetSelect">
        <option value="devs">devs.txt</option>
        <option value="dm">data-manager.txt</option>
        <option value="mgr">manager.txt</option>
      </select>
      <button id="addBtn" class="add-btn">Add</button>
    </div>
    <button id="saveBtn" class="save-btn">Save Changes</button>
  </div>
  <div id="toast" class="toast"></div>

<script>
/* --- Config --- */
const REPO   = "CraftersMC-Guides-Project/guides-code";
const BRANCH = "main";
const PATHS  = {
  devs: "data/team/devs.txt",
  dm:   "data/team/data-manager.txt",
  mgr:  "data/team/manager.txt"
};
const SOURCES = {
  devs: [
    "https://craftersmc-guides.pages.dev/data/team/devs.txt",
    "https://raw.githubusercontent.com/CraftersMC-Guides-Project/guides-code/main/data/team/devs.txt"
  ],
  dm: [
    "https://craftersmc-guides.pages.dev/data/team/data-manager.txt",
    "https://raw.githubusercontent.com/CraftersMC-Guides-Project/guides-code/main/data/team/data-manager.txt"
  ],
  mgr: [
    "https://craftersmc-guides.pages.dev/data/team/manager.txt",
    "https://raw.githubusercontent.com/CraftersMC-Guides-Project/guides-code/main/data/team/manager.txt"
  ]
};

/* --- State --- */
let devIds=[], dmIds=[], mgrIds=[], cache={};

/* --- Helpers --- */
function getCookie(name){
  const value=`; ${document.cookie}`;
  const parts=value.split(`; ${name}=`);
  if(parts.length===2) return decodeURIComponent(parts.pop().split(';').shift());
  return "";
}
function toast(msg,type="info"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.background= type==="error"?"#b91c1c":type==="success"?"#065f46":"#111";
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),3000);
}
function avatar(u){
  if(u&&u.avatar) return `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png`;
  const n=u&&u.id?Number(BigInt(u.id)%5n):0;
  return `https://cdn.discordapp.com/embed/avatars/${n}.png`;
}

/* --- Discord User Info --- */
async function getUser(id){
  if(cache[id]) return cache[id];
  try{
    const r=await fetch(`https://discord-auth.roumakdatta.workers.dev/users/${id}`);
    if(r.ok){ const d=await r.json(); cache[id]=d; return d; }
  }catch{}
  return null;
}

/* --- Rendering --- */
async function renderList(list, ulId){
  const ul=document.getElementById(ulId);
  ul.innerHTML="";
  if(!list.length){ul.innerHTML="<li>No entries</li>";return;}
  for(const id of list){
    const li=document.createElement("li");
    const u=await getUser(id);
    li.innerHTML=u?`
      <div class="profile">
        <img src="${avatar(u)}">
        <div class="profile-info">
          <div class="name">${u.global_name||u.username}</div>
          <div class="meta">ID: ${u.id}</div>
          <div class="meta">Role: ${u.role||"N/A"} | Logins: ${u.login_count||0}</div>
        </div>
      </div>
      <button class="remove-btn" onclick="removeId('${id}')">Remove</button>
    `:`
      <div class="profile"><div class="profile-info"><div class="name">${id}</div><div class="meta">Not found</div></div></div>
      <button class="remove-btn" onclick="removeId('${id}')">Remove</button>`;
    ul.appendChild(li);
  }
}
async function renderAll(){ await renderList(devIds,"devsList"); await renderList(dmIds,"dmList"); await renderList(mgrIds,"mgrList"); }

/* --- Manage IDs --- */
function removeId(id){ devIds=devIds.filter(x=>x!==id); dmIds=dmIds.filter(x=>x!==id); mgrIds=mgrIds.filter(x=>x!==id); renderAll(); }
document.getElementById("addBtn").onclick=()=>{
  const id=document.getElementById("newIdInput").value.trim();
  if(!id) return;
  if([...devIds,...dmIds,...mgrIds].includes(id)){toast("Already exists","error");return;}
  const t=document.getElementById("targetSelect").value;
  if(t==="devs") devIds.push(id); if(t==="dm") dmIds.push(id); if(t==="mgr") mgrIds.push(id);
  document.getElementById("newIdInput").value="";
  renderAll(); toast("Added","success");
};

/* --- File loading --- */
async function fetchFirst(urls){ for(const u of urls){ try{const r=await fetch(u,{cache:"no-cache"}); if(r.ok) return await r.text();}catch{}} return ""; }
async function loadAll(){
  devIds=(await fetchFirst(SOURCES.devs)).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  dmIds =(await fetchFirst(SOURCES.dm)).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  mgrIds=(await fetchFirst(SOURCES.mgr)).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  renderAll();
}

/* --- Save to GitHub --- */
function headers(tok){return {"Authorization":"token "+tok,"Accept":"application/vnd.github+json","Content-Type":"application/json"};}
function b64(s){return btoa(unescape(encodeURIComponent(s)));}
async function getSha(tok,path){
  const r=await fetch(`https://api.github.com/repos/${REPO}/contents/${path}?ref=${BRANCH}`,{headers:headers(tok)});
  if(r.status===404) return null; if(!r.ok) throw new Error("Read fail "+path);
  return (await r.json()).sha;
}
async function putFile(tok,path,content,sha){
  const body={message:`update ${path} via dashboard`,content:b64(content+"\n"),branch:BRANCH};
  if(sha) body.sha=sha;
  const r=await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{method:"PUT",headers:headers(tok),body:JSON.stringify(body)});
  if(!r.ok) throw new Error((await r.json()).message||"Error saving "+path);
}
async function saveAll(){
  const tok=getCookie("githubToken");
  if(!tok){toast("No GitHub token cookie","error");return;}
  try{
    const [devSha,dmSha,mgrSha]=await Promise.all([
      getSha(tok,PATHS.devs), getSha(tok,PATHS.dm), getSha(tok,PATHS.mgr)
    ]);
    await putFile(tok,PATHS.devs,devIds.join("\n"),devSha);
    await putFile(tok,PATHS.dm,dmIds.join("\n"),dmSha);
    await putFile(tok,PATHS.mgr,mgrIds.join("\n"),mgrSha);
    toast("Saved to GitHub","success");
  }catch(e){console.error(e);toast("Save failed: "+e.message,"error");}
}
document.getElementById("saveBtn").onclick=saveAll;

/* --- Init --- */
loadAll();
</script>
</body>
</html>
