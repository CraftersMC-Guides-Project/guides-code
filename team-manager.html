<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Team Management</title>
  <style>
    :root{
      --bg: #0a0c10;
      --panel: #111827;
      --text: #e6edf3;
      --muted: #9ca3af;
      --primary: #2563eb;
      --danger: #dc2626;
      --success: #10b981;
      --glass: rgba(255,255,255,0.05);
    }
    body{
      margin:0;
      height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .container{
      width:100%;max-width:1080px;
      background:var(--panel);
      border-radius:16px;
      padding:28px;
      box-shadow:0 8px 32px rgba(0,0,0,.6);
    }
    h1{text-align:center;margin:0 0 16px;font-size:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
    .box{background:var(--glass);padding:16px;border-radius:12px;min-height:220px}
    .box h2{margin:0 0 10px;font-size:15px}
    .dev-list{list-style:none;padding:0;margin:0;max-height:360px;overflow:auto}
    .dev-list li{background:rgba(255,255,255,.04);padding:10px;margin-bottom:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    .profile{display:flex;align-items:center;gap:12px}
    .profile img{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .profile-info{display:flex;flex-direction:column}
    .profile-info .name{font-weight:600}
    .profile-info .meta{font-size:12px;color:var(--muted)}
    .remove-btn{background:var(--danger);border:0;color:white;padding:6px 10px;border-radius:6px;cursor:pointer}
    .add-row{display:flex;gap:10px;margin-top:16px}
    #newIdInput{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:transparent;color:var(--text)}
    .select-target{padding:10px;border-radius:8px;background:rgba(255,255,255,.05);color:var(--text)}
    .add-btn{background:var(--primary);color:white;border:0;padding:10px 16px;border-radius:8px;cursor:pointer}
    .save-btn{margin-top:20px;width:100%;background:var(--success);color:white;border:0;padding:14px;border-radius:12px;font-weight:600;cursor:pointer}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:-80px;background:#111;color:white;padding:10px 16px;border-radius:8px;transition:bottom .3s ease;z-index:9999}
    .toast.show{bottom:24px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Developer, Data Manager & Manager Management</h1>
    <div class="grid">
      <div class="box"><h2>Developers (devs.txt)</h2><ul id="devsList" class="dev-list"><li>Loading…</li></ul></div>
      <div class="box"><h2>Data Managers (data-manager.txt)</h2><ul id="dmList" class="dev-list"><li>Loading…</li></ul></div>
      <div class="box"><h2>Managers (manager.txt)</h2><ul id="mgrList" class="dev-list"><li>Loading…</li></ul></div>
    </div>
    <div class="add-row">
      <input id="newIdInput" placeholder="Enter Discord User ID" />
      <select id="targetSelect" class="select-target">
        <option value="devs">Add to devs.txt</option>
        <option value="dm">Add to data-manager.txt</option>
        <option value="mgr">Add to manager.txt</option>
      </select>
      <button id="addIdBtn" class="add-btn">Add</button>
    </div>
    <button id="saveChangesBtn" class="save-btn">Save Changes</button>
  </div>
  <div id="toast" class="toast"></div>
<script>
const REPO = "CraftersMC-Guides-Project/guides-code";
const PATHS = {devs:"data/team/devs.txt", dm:"data/team/data-manager.txt", mgr:"data/team/manager.txt"};
const BRANCH = "main";

let devIds=[], dmIds=[], mgrIds=[];
let cache={};

function showToast(msg,type="info"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.background= type==="error"?"#b91c1c": type==="success"?"#065f46":"#111";
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),3000);
}

function getAvatar(user){
  if(user.avatar){
    return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
  }
  const num=BigInt(user.id)%5n;
  return `https://cdn.discordapp.com/embed/avatars/${num}.png`;
}

async function fetchUser(id){
  if(cache[id]) return cache[id];
  try{
    const r=await fetch(`https://discord-auth.roumakdatta.workers.dev/users/${id}`);
    if(r.ok){
      const j=await r.json();
      cache[id]=j;
      return j;
    }
  }catch(e){console.warn("fetch failed",id,e)}
  return null;
}

async function render(list,ulId){
  const ul=document.getElementById(ulId);
  ul.innerHTML="";
  if(list.length===0){ul.innerHTML="<li>No entries.</li>";return;}
  for(const id of list){
    const li=document.createElement("li");
    const u=await fetchUser(id);
    if(u){
      li.innerHTML=`<div class="profile"><img src="${getAvatar(u)}"><div class="profile-info"><div class="name">${u.global_name||u.username}</div><div class="meta">ID:${u.id} ${u.xbox?"| Xbox:"+u.xbox.name:""}</div><div class="meta">Role:${u.role||"N/A"} | Logins:${u.login_count||0}</div></div></div><button class="remove-btn" onclick="removeId('${id}')">Remove</button>`;
    }else{
      li.innerHTML=`<div class="profile"><div style="width:44px;height:44px;border-radius:50%;background:#222;display:flex;align-items:center;justify-content:center">?</div><div class="profile-info"><div class="name">${id}</div><div class="meta">Not found</div></div></div><button class="remove-btn" onclick="removeId('${id}')">Remove</button>`;
    }
    ul.appendChild(li);
  }
}

async function renderAll(){
  await render(devIds,"devsList");
  await render(dmIds,"dmList");
  await render(mgrIds,"mgrList");
  localStorage.setItem("draft",JSON.stringify({devIds,dmIds,mgrIds}));
}

function removeId(id){
  devIds=devIds.filter(x=>x!==id);
  dmIds=dmIds.filter(x=>x!==id);
  mgrIds=mgrIds.filter(x=>x!==id);
  renderAll();
}

document.getElementById("addIdBtn").onclick=()=>{
  const id=document.getElementById("newIdInput").value.trim();
  if(!id) return;
  if([...devIds,...dmIds,...mgrIds].includes(id)){showToast("Already exists","error");return;}
  const target=document.getElementById("targetSelect").value;
  if(target==="devs") devIds.push(id);
  if(target==="dm") dmIds.push(id);
  if(target==="mgr") mgrIds.push(id);
  document.getElementById("newIdInput").value="";
  renderAll();
  showToast("Added locally","success");
};

// GitHub save
document.getElementById("saveChangesBtn").onclick = async () => {
  const token = getCookie("githubToken");
  if (!token) {
    showToast("No GitHub token found in cookies", "error");
    return;
  }

  showToast("Saving changes…");

  try {
    const refRes = await fetch(`https://api.github.com/repos/${REPO}/git/refs/heads/${BRANCH}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (!refRes.ok) throw new Error("Failed to get branch ref");
    const refData = await refRes.json();
    const latestCommitSha = refData.object.sha;

    const commitRes = await fetch(`https://api.github.com/repos/${REPO}/git/commits/${latestCommitSha}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (!commitRes.ok) throw new Error("Failed to get commit");
    const commitData = await commitRes.json();
    const baseTreeSha = commitData.tree.sha;

    async function makeBlob(content) {
      const res = await fetch(`https://api.github.com/repos/${REPO}/git/blobs`, {
        method: "POST",
        headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ content, encoding: "utf-8" })
      });
      if (!res.ok) throw new Error("Blob creation failed");
      return res.json();
    }
    const [devBlob, dmBlob, mgrBlob] = await Promise.all([
      makeBlob(devIds.join("\\n")),
      makeBlob(dmIds.join("\\n")),
      makeBlob(mgrIds.join("\\n"))
    ]);

    const treeRes = await fetch(`https://api.github.com/repos/${REPO}/git/trees`, {
      method: "POST",
      headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        base_tree: baseTreeSha,
        tree: [
          { path: PATHS.devs, mode: "100644", type: "blob", sha: devBlob.sha },
          { path: PATHS.dm,   mode: "100644", type: "blob", sha: dmBlob.sha },
          { path: PATHS.mgr,  mode: "100644", type: "blob", sha: mgrBlob.sha }
        ]
      })
    });
    if (!treeRes.ok) throw new Error("Failed to create tree");
    const treeData = await treeRes.json();

    const commitMessage = "Update team lists via dashboard";
    const newCommitRes = await fetch(`https://api.github.com/repos/${REPO}/git/commits`, {
      method: "POST",
      headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        message: commitMessage,
        tree: treeData.sha,
        parents: [latestCommitSha]
      })
    });
    if (!newCommitRes.ok) throw new Error("Failed to create commit");
    const newCommitData = await newCommitRes.json();

    const updateRes = await fetch(`https://api.github.com/repos/${REPO}/git/refs/heads/${BRANCH}`, {
      method: "PATCH",
      headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ sha: newCommitData.sha })
    });
    if (!updateRes.ok) throw new Error("Failed to update ref");

    localStorage.removeItem("draft");
    showToast("Changes saved successfully!", "success");

  } catch (err) {
    console.error(err);
    showToast("Save failed: " + err.message, "error");
  }
};

// utils
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

// load draft
(function init(){
  const d=localStorage.getItem("draft");
  if(d){
    const o=JSON.parse(d);
    devIds=o.devIds||[];dmIds=o.dmIds||[];mgrIds=o.mgrIds||[];
    renderAll();
    showToast("Loaded draft");
  }else{
    renderAll();
  }
})();
</script>
</body>
</html>
