<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:title" content="Upcoming Farming Contests - CraftersMC Guides">
    <meta property="og:description" content=" See the exact Skyblock day, season & year, the 3 crops, time until start, and always 5 next contests!">
    <meta property="og:image" content="https://cdn.discordapp.com/attachments/1416722412032229457/1416722509201543230/1000024054.jpg?ex=68c7e127&is=68c68fa7&hm=3f60b138e8d5e2c3c8b14453fe3ced7363b10fb11dff8b57d78a66bfc92d8a29">
    <meta property="og:url" content="https://craftersmc-guides.pages.dev/upcoming-farming-contest.html">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#007bff">
    <meta name="twitter:card" content="summary_large_image">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <title>Upcoming Farming Contests</title>
  <script src="js/script.js" defer></script>
  <style>
  </style>
</head>

<body>
  <div id="loader">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div class="-background"></div>
  <!-- Top Navbar -->
  <div class="top"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <button id="float">
    <span class="material-icons" id="sweepBtn" style="background: #222; border-radius: 50px">chevron_right</span>
    <span class="material-icons" id="homeBtn" onclick="homeBtn()">home</span>
    <span class="material-icons" id="ai" onclick="aiBtn()">smart_toy</span>
    <span class="material-icons" id="scrollToTopBtn">north</span>
  </button>

  <div class="gap"></div>
  <div class="mc-container">
    <div class="corner-left"></div>
    <div class="corner-right"></div>
    <div class="corner-bottom"></div>
    <div class="corner-top"></div>
    <div class="tl-tl"></div>
    <div class="tr-tl s-tl"></div>
    <div class="bl-tl s-tl"></div>
    <div class="br-tl"></div>
    <div class="tr-bl s-bl"></div>
    <div class="bl-tr s-tr"></div>
    <div class="tl-br"></div>
    <div class="tr-br s-br"></div>
    <div class="bl-br s-br"></div>
    <div class="br-br"></div>
    <div class="inventory inner-container">
      <h3>Upcoming Farming Contests</h3>
      <div class="extreme-inner-container">
        <form id="timeForm" style="display: none;">
          <input type="datetime-local" id="timeInput" />
          <input type="text" id="cropInput" placeholder="Filter by crop"/>
          <button class="btn" type="submit">Filter</button>
        </form>
        <table class="ufq-table ufq-table-container">
          <thead class="ufq-thead">
            <tr class="ufq-tr">
              <th class="ufq-th">Skyblock Date</th>
              <th class="ufq-th">Crops</th>
              <th class="ufq-th">Time</th>
            </tr>
          </thead>
          <tbody class="ufq-table" id="contestRows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer"></div>

  <script>

    // Format JS date → "DD-MM-YYYY:HH:MM"
    function formatApiDate(d) {
      const pad = n => String(n).padStart(2, "0");
      return `${pad(d.getDate())}-${pad(d.getMonth() + 1)}-${d.getFullYear()}:${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function snapToContestMinute(date) {
      const minutes = date.getMinutes();
      if (minutes < 30) {
        date.setMinutes(30, 0, 0);
      } else if (minutes < 50) {
        date.setMinutes(50, 0, 0);
      } else {
        date.setHours(date.getHours() + 1);
        date.setMinutes(10, 0, 0); // Next contest after :50 is :10 of next hour
      }
      return date;
    }

    async function fetchMultipleEvents(time, crop) {
      try {
        let url;
        if (crop) {
          // For crop filtering: /api/DD-MM-YYYY:HH:MM/cropName
          url = `https://bhai-bhai.roumakdatta.workers.dev/api/${time}/${crop}`;
        } else {
          // For multiple events: /api/DD-MM-YYYY:HH:MM/5
          url = `https://bhai-bhai.roumakdatta.workers.dev/api/${time}/5`;
        }

        const res = await fetch(url);
        if (!res.ok) throw new Error("Bad response " + res.status);
        const data = await res.json();

        // Update table
        const tbody = document.getElementById("contestRows");
        tbody.innerHTML = "";

        // Handle both single event and array of events
        const events = Array.isArray(data) ? data : [data];

        events.slice(0, 5).forEach((ev, index) => {
          const timeText = index === 0 ? "NOW" : `in ${index * 3} SkyBlock days`;
          const row = `<tr class="ufq-tr">
                <td class="ufq-th">${ev.skyblockDate || "-"}</td>
                <td class="ufq-th">${(ev.crops || []).join(", ")}</td>
                <td class="ufq-th">${ev.timeUntil || timeText}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });

      } catch (err) {
        alert("Error fetching data: " + err.message);
      }
    }

    // Handle form submit
    document.getElementById("timeForm").addEventListener("submit", e => {
      e.preventDefault();
      let timeVal = document.getElementById("timeInput").value;
      let date = new Date(timeVal);
      date = snapToContestMinute(date);
      const cropVal = document.getElementById("cropInput").value.trim().toLowerCase();
      const formatted = formatApiDate(date);
      fetchMultipleEvents(formatted, cropVal || null);
    });

    // On load → prefill datetime + fetch immediately
    window.addEventListener("DOMContentLoaded", () => {
      let now = new Date();
      now = snapToContestMinute(now);
      document.getElementById("timeInput").value = now.toISOString().slice(0, 16);
      const formatted = formatApiDate(now);
      fetchMultipleEvents(formatted, null);
    });

    // Helper function to get next 5 events by making multiple API calls
    async function getNextFiveEvents(initialTime) {
      const events = [];
      let currentTime = initialTime;

      for (let i = 0; i < 5; i++) {
        try {
          const url = `https://bhai-bhai.roumakdatta.workers.dev/api/${currentTime}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Bad response " + res.status);
          const data = await res.json();

          const event = Array.isArray(data) ? data[0] : data;
          events.push(event);

          // Calculate next time (3 SkyBlock days later)
          // Parse the current time to get a Date object
          const [datePart, timePart] = currentTime.split(":");
          const [day, month, year] = datePart.split("-").map(Number);
          const [hours, minutes] = timePart.split(":").map(Number);

          const currentDate = new Date(year, month - 1, day, hours, minutes);
          // Add time equivalent to 3 SkyBlock days (3 * 24 * 60 * 60 / 72 real seconds)
          const nextDate = new Date(currentDate.getTime() + (3 * 24 * 60 * 60 * 1000) / 72);

          // Format the next date for the API
          currentTime = formatApiDate(nextDate);

        } catch (err) {
          console.error("Error fetching event:", err);
          events.push({ skyblockDate: "-", crops: ["Error"], timeUntil: "Error" });
        }
      }

      return events;
    }
  </script>
</body>

</html>
