<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Prices - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="css/essential.css" />
  <link rel="stylesheet" href="css/market.css" />
  <script src="js/script.js"></script>
  <style>
    .result {
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .result img {
      width: 30px;
      height: 30px;
      margin-right: 10px;
      align-items: center;
    }

    .info b {
      display: block;
    }

    .info span {
      font-size: 0.9em;
    }

    .info .description {
      font-size: 0.8em;
      margin-top: 5px;
      display: -webkit-box;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #results p {
      padding: 10px;
      text-align: center;
    }

    .info-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .info-head img {
      width: 65px;
      height: 65px;
    }
  </style>
</head>

<body>
  <div id="loader">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div class="navbar"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <button id="scrollToTopBtn"><span class="material-icons">north</span></button>
  <h1 class="title">CraftersMC Market Prices</h1>
  <input type="text" id="searchBox" placeholder="Search Items..." oninput="searchItems()" />
  <div class="boxy-box">
    <div id="results"></div>
  </div>
  <div class="categories">Categories</div>
  <div class="divider"></div>

  <div class="category-section">
    <div class="category-grid">
      <div class="category-item" onclick="goToCategory('farming')">
        <img src="assets/ui-icons/ui_bazaar_category_farming_active.png" alt="farming" class="bz">
        <div class="category-name">
          <p>Farming</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('mining')">
        <img src="assets/ui-icons/ui_bazaar_category_mining_active.png" alt="mining" class="bz">
        <div class="category-name">
          <p>Mining</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('combat')">
        <img src="assets/ui-icons/ui_bazaar_category_combat_active.png" alt="Combat" class="bz">
        <div class="category-name">
          <p>Combat</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('foraging')">
        <img src="assets/ui-icons/ui_bazaar_category_foraging_active.png" alt="foraging" class="bz">
        <div class="category-name">
          <p>Foraging</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('special')">
        <img src="assets/ui-icons/ui_star_active.png" alt="special">
        <div class="category-name">
          <p>Special</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('slayer')">
        <img src="img/Atoned_Heart.webp" alt="special" class="bz">
        <div class="category-name">
          <p>Slayer</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('minion')">
        <img src="img/Slime_Minion.png" alt="minion">
        <div class="category-name">
          <p>Minion</p>
        </div>
      </div>
      <div class="category-item" onclick="window.location.href='pets-cat.html'">
        <img src="img/Phoenix_Pet.webp" alt="Pets">
        <div class="category-name">
          <p>Pets</p>
        </div>
      </div>
    </div>
  </div>
  <div id="footer"></div>

  <script>
    let items = [];
    let prices = {};
    let isDataLoaded = false;

    function parsePrices(text) {
      const priceMap = {};
      const lines = text.trim().split('\n');
      for (const line of lines) {
        const match = line.match(/^(\d+):\s*\[(.*)\]$/);
        if (match) {
          const id = match[1];
          const parts = match[2].split(',');
          const price = parseInt(parts[1].trim());
          priceMap[id] = price;
        }
      }
      return priceMap;
    }

    async function loadItems() {
      try {
        const [marketRes, priceRes] = await Promise.all([
          fetch('../market/market.txt'),
          fetch('../market/mprices.txt')
        ]);

        const marketText = await marketRes.text();
        const priceText = await priceRes.text();

        items = JSON.parse(marketText);
        prices = parsePrices(priceText);
        

        isDataLoaded = true;
        searchItems();
      } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('results').innerHTML = '<p>Failed to load item data.</p>';
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    function searchItems() {
      const query = document.getElementById('searchBox').value.toLowerCase();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!isDataLoaded) {
        resultsDiv.innerHTML = '<p>Loading items...</p>';
        return;
      }

      const filteredItems = items.filter(item => item.name.toLowerCase().includes(query));

      if (filteredItems.length === 0 && query.trim() !== '') {
        resultsDiv.innerHTML = '<p>No results found.</p>';
        return;
      }

      if (query.trim() === '') return;

      filteredItems.slice(0, 10).forEach(item => {
        const price = prices[item.id] || 'N/A';
        console.log(prices);

        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="info">
          <div class="info-head">
            <b>${item.name}</b>
            <img src="${item.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : item.picture}" alt="${item.name}">
            </div>
            <div class="result-div-info">ID: ${item.id}</div>
            <div class="result-div-info">Market price: ${price} <img class="coin" src="img/coin.png" alt="Coin"></div>
            ${item.description ? `<div class="description">${item.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `item.html?item=${item.id}`;
        };
        resultsDiv.appendChild(div);
      });
    }

    function goToCategory(category) {
      window.location.href = `categories.html?cat=${category}`;
    }

    loadItems();
  </script>
</body>
</html>
