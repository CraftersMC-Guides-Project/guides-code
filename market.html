<!DOCTYPE html>
<html lang="en">

<head>
<link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Prices - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="css/essential.css" />
  <link rel="stylesheet" href="css/market.css" />
  <script src="js/script.js"></script>
  <style>
    .result {
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .result img {
      width: 30px;
      height: 30px;
      margin-right: 10px;
      align-items: center;
    }

    .info b {
      display: block;
    }

    .info span {
      font-size: 0.9em;
    }

    .info .description {
      font-size: 0.8em;
      margin-top: 5px;
      display: -webkit-box;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #results p {
      padding: 10px;
      text-align: center;
    }

    .info-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .info-head img {
      width: 65px;
      height: 65px;
    }
  </style>
</head>

<body>
  <div id="loader">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div class="background"></div>
  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
<span class="material-icons" id="scrollToTopBtn">north</span>
    <!--  -->
  <h1 class="title">CraftersMC Market Prices</h1>
  <input type="text" id="searchBox" placeholder="Search Items..." oninput="searchItems()" />
  <div class="boxy-box">
    <div id="results"></div>
  </div>
  <div class="categories">Discover the prices</div>
  <div class="divider"></div>

  <div class="category-section">
    <div class="category-grid">
      <div class="category-item" onclick="goToCategory('farming')">
        <img src="assets/ui-icons/ui_bazaar_category_farming_active.png" alt="farming" class="bz">
        <div class="category-name">
          <p>Farming</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('mining')">
        <img src="assets/ui-icons/ui_bazaar_category_mining_active.png" alt="mining" class="bz">
        <div class="category-name">
          <p>Mining</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('combat')">
        <img src="assets/ui-icons/ui_bazaar_category_combat_active.png" alt="Combat" class="bz">
        <div class="category-name">
          <p>Combat</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('foraging')">
        <img src="assets/ui-icons/ui_bazaar_category_foraging_active.png" alt="foraging" class="bz">
        <div class="category-name">
          <p>Foraging</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('special')">
        <img src="assets/ui-icons/ui_star_active.png" alt="special" class="bz">
        <div class="category-name">
          <p>Special</p>
        </div>
      </div>
      <div class="category-item" onclick="goToCategory('slayer')">
        <img src="img/Atoned_Heart.webp" alt="special" class="bz">
        <div class="category-name">
          <p>Slayer</p>
        </div>
      </div>
      <!-- <div class="category-item" onclick="window.location.href='minion-cat.html'">
        <img src="img/slime-minion/Slime_Minion.png" alt="minion">
        <div class="category-name">
          <p>Minion</p>
        </div>
      </div> -->
      <div class="category-item" onclick="window.location.href='pets-cat.html'">
        <img src="img/pets/Phoenix_Pet.webp" alt="Pets">
        <div class="category-name">
          <p>Pets</p>
        </div>
      </div>
    </div>
  </div>
  <div id="footer"></div>

  <script>
    let items = [];
    let prices = {};
    let pets = [];
    let petPrices = {};
    let minions = [];
    let minionPrices = {};
    let isDataLoaded = false;

    function parsePrices(text) {
      const priceMap = {};
      const lines = text.trim().split('\n');
      for (const line of lines) {
        const match = line.match(/^(\d+):\s*\[(.*)\]$/);
        if (match) {
          const id = match[1];
          const parts = match[2].split(',');
          const price = parseInt(parts[1].trim());
          priceMap[id] = price;
        }
      }
      return priceMap;
    }

    async function loadItems() {
      try {
        const [marketRes, priceRes, petRes, petPriceRes, minionRes, minionPriceRes] = await Promise.all([
          fetch('market/market.txt'),
          fetch('market/mprices.txt'),
          fetch('market/pets.txt'),
          fetch('market/pet-prices.txt'),
          fetch('market/minions.txt'),
          fetch('market/minion-prices.json')
        ]);

        items = await marketRes.json();
        prices = parsePrices(await priceRes.text());
        pets = await petRes.json();
        petPrices = await petPriceRes.json();
        minions = await minionRes.json();
        minionPrices = await minionPriceRes.json();

        isDataLoaded = true;
        searchItems();
      } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('results').innerHTML = '<p>Failed to load item data.</p>';
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    function searchItems() {
      const query = document.getElementById('searchBox').value.toLowerCase();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!isDataLoaded) {
        resultsDiv.innerHTML = '<p>Loading items...</p>';
        return;
      }

      const filteredItems = items.filter(item => item.name.toLowerCase().includes(query));
      const filteredPets = pets.filter(pet => pet.name.toLowerCase().includes(query));
      const filteredMinions = minions.filter(minion => minion.name.toLowerCase().includes(query));

      if (filteredItems.length === 0 && query.trim() !== '' && filteredPets.length === 0 && filteredMinions.length === 0) {
        resultsDiv.innerHTML = '<p>No results found.</p>';
        return;
      }

      if (query.trim() === '') return;

      // Regular items
      filteredItems.slice(0, 10).forEach(item => {
        const price = prices[item.id] || 'N/A';
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="info">
            <div class="info-head">
              <b>${item.name}</b>
              <img src="${item.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : item.picture}" alt="${item.name}">
            </div>
            <div class="result-div-info">ID: ${item.id}</div>
            <div class="result-div-info">Market price: ${price} <img class="coin" src="img/coin.png" alt="Coin"></div>
            ${item.description ? `<div class="description">${item.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `item.html?item=${item.id}`;
        };
        resultsDiv.appendChild(div);
      });

      // Pets
      filteredPets.slice(0, 10).forEach(pet => {
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="info">
            <div class="info-head">
              <b>${pet.name}</b>
              <img src="${pet.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : pet.picture}" alt="${pet.name}">
            </div>
            <div class="result-div-info">ID: ${pet.id}</div>
            <div class="result-div-info">Market price: Varies by rarity</div>
            ${pet.description ? `<div class="description">${pet.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `pets.html?pet=${pet.id}`;
        };
        resultsDiv.appendChild(div);
      });

      // Minions
      filteredMinions.slice(0, 10).forEach(minion => {
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="info">
            <div class="info-head">
              <b>${minion.name}</b>
              <img src="${minion.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : minion.picture}" alt="${minion.name}">
            </div>
            <div class="result-div-info">ID: ${String(minion.id).padStart(2, '0')}</div>
            <div class="result-div-info">Market price: Varies by tier</div>
            ${minion.description ? `<div class="description">${minion.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `minions.html?minion=${String(minion.id).padStart(2, '0')}`;
        };
        resultsDiv.appendChild(div);
      });
    }

    function goToCategory(category) {
      window.location.href = `categories.html?cat=${category}`;
    }

    loadItems();
  </script>

</body>
</html>
