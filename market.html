<!DOCTYPE html>
<html lang="en">

<head>
<link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Prices - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="themes/minecraft/style.css" />
  <script src="js/script.js"></script>
  <style>
    /* Profile Card Styles */
    #top-right-ui-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
    }

    .profile-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 50px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .profile-card:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }

    .profile-card-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }

    .profile-card-name {
      font-weight: 500;
      font-size: 14px;
    }

    .dev-label {
      color: #ff4d4d;
      font-weight: bold;
      margin-left: 5px;
    }

    .private-item-highlight {
      border: 2px dashed #ff9800;
      background-color: rgba(255, 152, 0, 0.1);
      padding: 5px;
      border-radius: 8px;
      margin-bottom: 8px;
      text-align: center;
      font-weight: bold;
      color: #ff9800;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      justify-items: center;
      margin: 20px;
    }

    .result {
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 10px;
      width: 100%;
      max-width: 350px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .result:hover { transform: scale(1.02); }
    .market-coin { width: 18px; height: 18px; vertical-align: middle; margin-left: 4px; }

    @media (max-width: 768px) {
        #top-right-ui-container {
            top: 65px;
            right: 10px;
            gap: 8px;
        }
        .profile-card {
            padding: 4px 8px;
        }
        .profile-card-avatar {
            width: 28px;
            height: 28px;
        }
        .profile-card-name {
            font-size: 12px;
        }
    }
  </style>
</head>

<body>
  <div id="loader">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div class="market-background"></div>
  
  <div id="top-right-ui-container">
    <div id="profile-card-container"></div>
  </div>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
<span class="material-icons" id="scrollToTopBtn">north</span>

  <h1 class="market-title">CraftersMC Market Prices</h1>
  <input type="text" id="searchBox" placeholder="Search Items..." oninput="searchItems()" />
  <div class="market-boxy-box">
    <div id="results" class="results-grid"></div>
  </div>
  <div class="market-categories">Discover the prices</div>
  <div class="market-divider"></div>

  <div class="market-category-section">
    <div class="market-category-grid">
      <div class="market-category-item" onclick="goToCategory('farming')">
        <img src="assets/ui-icons/ui_bazaar_category_farming_active.png" alt="farming" class="market-bz">
        <div class="market-category-name">
          <p>Farming</p>
        </div>
      </div>
      <div class="market-category-item" onclick="goToCategory('mining')">
        <img src="assets/ui-icons/ui_bazaar_category_mining_active.png" alt="mining" class="market-bz">
        <div class="market-category-name">
          <p>Mining</p>
        </div>
      </div>
      <div class="market-category-item" onclick="goToCategory('combat')">
        <img src="assets/ui-icons/ui_bazaar_category_combat_active.png" alt="Combat" class="market-bz">
        <div class="market-category-name">
          <p>Combat</p>
        </div>
      </div>
      <div class="market-category-item" onclick="goToCategory('foraging')">
        <img src="assets/ui-icons/ui_bazaar_category_foraging_active.png" alt="foraging" class="market-bz">
        <div class="market-category-name">
          <p>Foraging</p>
        </div>
      </div>
      <div class="market-category-item" onclick="goToCategory('special')">
        <img src="assets/ui-icons/ui_star_active.png" alt="special" class="market-bz">
        <div class="market-category-name">
          <p>Special</p>
        </div>
      </div>
      <div class="market-category-item" onclick="goToCategory('slayer')">
        <img src="img/Atoned_Heart.webp" alt="special" class="market-bz">
        <div class="market-category-name">
          <p>Slayer</p>
        </div>
      </div>
      <div class="market-category-item" onclick="window.location.href='pets-cat.html'">
        <img src="img/pets/Phoenix_Pet.webp" alt="Pets">
        <div class="market-category-name">
          <p>Pets</p>
        </div>
      </div>
    </div>
  </div>
  <div id="footer"></div>

  <script>
    let items = [];
    let prices = {};
    let pets = [];
    let petPrices = {};
    let minions = [];
    let minionPrices = {};
    let isDataLoaded = false;
    let isDevUser = false;

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    async function loadProfileCard() {
        const storedUser = getCookie("discordUser");
        const profileContainer = document.getElementById("profile-card-container");
        
        let devIds = [];
        try {
            const response = await fetch('/devs.txt');
            if (response.ok) {
                const text = await response.text();
                devIds = text.split('\n').map(id => id.trim()).filter(id => id);
            }
        } catch (error) {
            console.error('Could not load or parse devs.txt:', error);
        }

        if (storedUser) {
            const user = JSON.parse(storedUser);
            const displayName = user.global_name || user.username;
            isDevUser = devIds.includes(user.id);

            profileContainer.innerHTML = `
                <a href="/profile" class="profile-card">
                    <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" alt="Avatar" class="profile-card-avatar">
                    <span class="profile-card-name">
                        ${displayName}
                        ${isDevUser ? '<span class="dev-label">[DEV]</span>' : ''}
                    </span>
                </a>
            `;
        } else {
            profileContainer.innerHTML = '';
        }
    }

    function parsePrices(text) {
      const priceMap = {};
      const lines = text.trim().split('\n');
      for (const line of lines) {
        const match = line.match(/^(\d+):\s*\[(.*)\]$/);
        if (match) {
          const id = match[1];
          const parts = match[2].split(',');
          const price = parseInt(parts[1].trim());
          priceMap[id] = price;
        }
      }
      return priceMap;
    }

    async function loadItems() {
      try {
        const [marketRes, priceRes, petRes, petPriceRes, minionRes, minionPriceRes] = await Promise.all([
          fetch('market/market.txt'),
          fetch('market/mprices.txt'),
          fetch('market/pets.txt'),
          fetch('market/pet-prices.txt'),
          fetch('market/minions.txt'),
          fetch('market/minion-prices.json')
        ]);

        items = await marketRes.json();
        prices = parsePrices(await priceRes.text());
        pets = await petRes.json();
        petPrices = await petPriceRes.json();
        minions = await minionRes.json();
        minionPrices = await minionPriceRes.json();

        isDataLoaded = true;
        searchItems();
      } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('results').innerHTML = '<p>Failed to load item data.</p>';
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    function searchItems() {
      const query = document.getElementById('searchBox').value.toLowerCase();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!isDataLoaded) {
        resultsDiv.innerHTML = '<p>Loading items...</p>';
        return;
      }

      const filteredItems = items.filter(item => {
        const isPublic = item.hasOwnProperty("public") ? item.public : true;
        return (isPublic || isDevUser) && item.name.toLowerCase().includes(query);
      });
      
      const filteredPets = pets.filter(pet => pet.name.toLowerCase().includes(query));
      const filteredMinions = minions.filter(minion => minion.name.toLowerCase().includes(query));

      if (filteredItems.length === 0 && query.trim() !== '' && filteredPets.length === 0 && filteredMinions.length === 0) {
        resultsDiv.innerHTML = '<p>No results found.</p>';
        return;
      }

      if (query.trim() === '') return;

      // Regular items
      filteredItems.slice(0, 10).forEach(item => {
        const price = prices[item.id] || 'N/A';
        const div = document.createElement('div');
        div.className = 'result';
        const isPublic = item.hasOwnProperty("public") ? item.public : true;
        let privateHighlight = (!isPublic && isDevUser) ? `<div class='private-item-highlight'>PRIVATE ITEM</div>` : '';

        div.innerHTML = `
          ${privateHighlight}
          <div class="market-info">
            <div class="market-info-head">
              <b>${item.name}</b>
              <img src="${item.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : item.picture}" alt="${item.name}">
            </div>
            <div class="market-result-div-info">ID: ${item.id}</div>
            <div class="market-result-div-info">Market price: ${price} <img class="market-coin" src="img/coin.png" alt="Coin"></div>
            ${item.description ? `<div class="market-description">${item.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `item-v2.html?item=${item.id}`;
        };
        resultsDiv.appendChild(div);
      });

      // Pets
      filteredPets.slice(0, 10).forEach(pet => {
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="market-info">
            <div class="market-info-head">
              <b>${pet.name}</b>
              <img src="${pet.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : pet.picture}" alt="${pet.name}">
            </div>
            <div class="market-result-div-info">ID: ${pet.id}</div>
            <div class="market-result-div-info">Market price: Varies by rarity</div>
            ${pet.description ? `<div class="market-description">${pet.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `pets.html?pet=${pet.id}`;
        };
        resultsDiv.appendChild(div);
      });

      // Minions
      filteredMinions.slice(0, 10).forEach(minion => {
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="market-info">
            <div class="market-info-head">
              <b>${minion.name}</b>
              <img src="${minion.picture === '-' ? 'assets/ui-icons/ui_star_active.png' : minion.picture}" alt="${minion.name}">
            </div>
            <div class="market-result-div-info">ID: ${String(minion.id).padStart(2, '0')}</div>
            <div class="market-result-div-info">Market price: Varies by tier</div>
            ${minion.description ? `<div class="market-description">${minion.description}</div>` : ''}
          </div>`;
        div.onclick = () => {
          window.location.href = `minions.html?minion=${String(minion.id).padStart(2, '0')}`;
        };
        resultsDiv.appendChild(div);
      });
    }

    function goToCategory(category) {
      window.location.href = `categories.html?cat=${category}`;
    }

    async function initializePage() {
        await loadProfileCard();
        await loadItems();
    }

    initializePage();
  </script>

</body>
</html>
