<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seller Access</title>
    <head>
    <meta charset="UTF-8">
    <title>Seller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/essential.css">
    <script src="js/script.js"></script>
</head>
    <style>
        :root {
            --box-font-size: 1.5rem;
            --white-color: white;
            --gold-color: gold;
            --accent-color: #007bff;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --stats-bg-color: rgba(0, 0, 0, 0.7);
            --border-color: rgba(255, 255, 255, 0.125);
            --border-color-alt: rgba(255, 255, 255, 0.3);
            --profile-bg-color: rgba(255, 255, 255, 0.49);
            --avatar-bg-color: #007bff;
            --card-bg-color: rgba(200, 200, 200, 0.65);
            --darkmode-card-bg: rgba(80, 80, 80, 0.75);
            --label-color: #ccc;
            --available-color: lime;
            --selling-bg: rgba(0, 128, 0, 0.3);
            --selling-color: #82EB53;
            --paused-bg: rgba(218, 81, 0, 0.3);
            --paused-color: #ff9b59;
            --inactive-bg: rgba(255, 0, 0, 0.3);
            --inactive-color: #ff6b6b;
            --badge-bg: #007bff;
            --text-color: #222;
            --box-size: 150px;
            --box-gap: 20px;
        }

        .darkmode {
            --white-color: white;
            --gold-color: gold;
            --accent-color: #007bff;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --stats-bg-color: rgba(0, 0, 0, 0.7);
            --border-color: rgba(255, 255, 255, 0.125);
            --border-color-alt: rgba(255, 255, 255, 0.3);
            --profile-bg-color: rgba(255, 255, 255, 0.49);
            --avatar-bg-color: #007bff;
            --card-bg-color: rgba(40, 40, 40, 0.75);
            --darkmode-card-bg: rgba(36, 36, 36, 0.4);
            --label-color: #ccc;
            --available-color: #82EB53;
            --selling-bg: rgba(0, 128, 0, 0.3);
            --selling-color: #82EB53;
            --paused-bg: rgba(218, 81, 0, 0.3);
            --paused-color: #ff9b59;
            --inactive-bg: rgba(255, 0, 0, 0.3);
            --inactive-color: #ff6b6b;
            --badge-bg: #007bff;
            --text-color: #fff;
        }

        body { 
            font-family: Arial, sans-serif; 
            margin: 2em;
            background-image: url('../Backgrounds/IMG_4500.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
    }

        #result {
            width: 100%;
            padding: 1em;
            height: 100%;
            align-items: center;
            justify-content: center;
            display: flex;
        }
        .profile {
            margin-top: 2em; 
            border: 1px solid #ccc;
            padding: 1em; 
            width: 100%; 
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .error {
            color: red;
            font-weight: bold;
            margin-top: 10px;
            border: 1px solid red;
        }
        .success {
            color: lime;
            font-weight: bold;
            margin-top: 10px;
        }
        .field { 
            margin-bottom: 10px;
        }
        .field label { 
            display: inline-block; 
            width: 100px; 
            font-weight: bold; 
        }
        .field input { 
            width: 200px; 
            padding: 3px; 
        }
        .field select { 
            width: 200px; 
            padding: 3px; 
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px;
            font-weight: bold;
        }
        .button-loading {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }
        .button-loading:hover {
            background-color: #0056b3;
        }
        .button-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .container {
            padding: 20px;
            background-color: var(--card-bg-color);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            color: var(--text-color);
            margin: 20px;
            margin-top: 100px;
            margin-bottom: 50px;
            width: 90%;
            height: auto;
            gap: 16px;
        }
        .container-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        input {
            width: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--card-bg-color);
            color: var(--text-color);
        }

        select {
            width: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--card-bg-color);
            color: var(--text-color);
        }

        @media (max-width: 600px) {
            .container {
                width: 100%;
                padding: 10px;
            }
            input, select {
                width: 100px;
            }
            #accessCodeInput {
                width: 150px;
            }
            label {
                font-size: 14px;
            }
            .field {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 10px;
            }
        }

        .rank {
            height: 30px;
            width: auto;
        }

        .successBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.3);
            z-index: 99999;
            width: 300px;
            display: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
            color: lime;
            border: 1px solid lime;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 3rem;
        }
        h2 {
            color: var(--text-color);
            text-align: center;
            font-size: 2rem;
        }

    </style>
</head>
<body class="darkmode">
    <div id="loader">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="top"></div>

    <div class="sidebar" id="sidebar"></div>
    <div class="successBox"><p id="successText"></p></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="container-container">
        <div class="container">
            <h1>Seller Profile Editor</h1>
            <h2>Enter Access Code</h2>
            <input type="text" id="accessCodeInput" placeholder="Access Code">
            <button onclick="checkAccessCode()">Submit</button>
            <div id="result"></div>
            
        </div>
    </div>
    <div id="footer"></div>
    <script>
        let allSellers = [];
        let currentAccessCode = '';
        let id = 0;

        async function checkAccessCode() {
            const [sellerRes] = await Promise.all([
                fetch('ranksellers/ranksellers.txt')
            ]);
            const sellerData = await sellerRes.text();
            allSellers = JSON.parse(sellerData);
            const code = document.getElementById('accessCodeInput').value.trim().toUpperCase();
            currentAccessCode = code;
            const seller = allSellers.find(s => s["access-code"] === code.toUpperCase());
            const resultDiv = document.getElementById('result');
            if (seller) {
                id = seller.id;
                resultDiv.innerHTML = `
                    <div class="profile">
                        <div class="field">
                            <label>Name:</label>
                            <input type="text" id="name" value="${seller.name}">
                        </div>
                        <div class="field">
                            <label>Discord:</label>
                            <input type="text" id="discord" value="${seller.discord}">
                        </div>
                        <div class="field">
                            <label>Rank:</label>
                            <select id="rank">
                                <option value="player" ${seller.rank === 'player' ? 'selected' : ''}></option>
                                <option value="gold" ${seller.rank === 'gold' ? 'selected' : ''}>Gold</option>
                                <option value="diamond" ${seller.rank === 'diamond' ? 'selected' : ''}>Diamond</option>
                                <option value="emerald" ${seller.rank === 'emerald' ? 'selected' : ''}>Emerald</option>
                                <option value="trainee" ${seller.rank === 'trainee' ? 'selected' : ''}>Trainee</option>
                                <option value="helper" ${seller.rank === 'helper' ? 'selected' : ''}>Helper</option>
                                <option value="mod" ${seller.rank === 'mod' ? 'selected' : ''}>Mod</option>
                                <option value="srmod" ${seller.rank === 'srmod' ? 'selected' : ''}>Senior Mod</option>
                                <option value="admin" ${seller.rank === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Status:</label>
                            <select id="status">
                                <option value="Selling" ${seller.status === 'Selling' ? 'selected' : ''}>Selling</option>
                                <option value="Inactive" ${seller.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="Paused" ${seller.status === 'Paused' ? 'selected' : ''}>Paused</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Timezone:</label>
                            <input type="text" id="timezone" value="${seller.timezone}">
                        </div>
                        <div class="field">
                            <label>Gems price (put N/A if you aren't selling):</label>
                            <input type="text" id="gems" value="${seller.gems}">
                        </div>
                        <div class="field">
                            <label>Gems Status:</label>
                            <select id="gemStatus">
                                <option value="Yes" ${seller.gemStatus === 'Yes' ? 'selected' : ''}>Yes</option>
                                <option value="No" ${seller.gemStatus === 'No' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Stock:</label>
                            <input type="text" id="stock" value="${seller.stock}">
                        </div>
                        <div class="field">
                            <label>Sales:</label>
                            <input type="text" id="sales" value="${seller.sales}">
                        </div>
                        <div class="field">
                            <label>Gold:</label>
                            <input type="text" id="gold" value="${seller.gold}">
                        </div>
                        <div class="field">
                            <label>Diamond:</label>
                            <input type="text" id="dia" value="${seller.dia}">
                        </div>
                        <div class="field">
                            <label>Emerald:</label>
                            <input type="text" id="em" value="${seller.em}">
                        </div>
                        <button onclick="saveChanges()" id="saveButton">Save Changes</button>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<p class="error">Access code not found. Please try again.</p>`;
            }
        }

        async function saveChanges() {
            const token = "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";
            if (!token) {
                alert('GitHub token is not working. Please contact the team to get it fixed.');
                return;
            }
            const saveButton = document.getElementById('saveButton');
            const successText = document.getElementById('successText');
            const successBox = document.querySelector('.successBox');
            successText.textContent = '';
            saveButton.disabled = true; 
            saveButton.classList.add('button-loading');
            saveButton.textContent = 'Saving...';

            try {
                const fileResponse = await fetch('https://api.github.com/repos/CraftersMC-Guides-Project/guides-code/contents/ranksellers/ranksellers.txt', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });

                if (!fileResponse.ok) {
                    const errorData = await fileResponse.text();
                    console.error('File fetch error:', errorData);
                    throw new Error(`GitHub API error: ${fileResponse.status} ${fileResponse.statusText}`);
                }

                const fileData = await fileResponse.json();
                
                // Update seller data
                const index = allSellers.findIndex(s => s["access-code"] === currentAccessCode);
                if (index === -1) {
                    throw new Error('Seller not found in array');
                }

                const updatedSeller = {
                    id: id,
                    name: document.getElementById('name').value,
                    discord: document.getElementById('discord').value,
                    rank: document.getElementById('rank').value,
                    status: document.getElementById('status').value,
                    timezone: document.getElementById('timezone').value,
                    gems: document.getElementById('gems').value.toUpperCase(),
                    gemStatus: document.getElementById('gemStatus').value,
                    stock: document.getElementById('stock').value,
                    sales: document.getElementById('sales').value,
                    gold: document.getElementById('gold').value.toUpperCase(),
                    dia: document.getElementById('dia').value.toUpperCase(),
                    em: document.getElementById('em').value.toUpperCase(),
                    "access-code": currentAccessCode.toUpperCase()
                };

                allSellers[index] = updatedSeller;
                
                const jsonString = JSON.stringify(allSellers, null, 2);
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonString);
                const content = btoa(String.fromCharCode(...data));
                
                const response = await fetch('https://api.github.com/repos/CraftersMC-Guides-Project/guides-code/contents/ranksellers/ranksellers.txt', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        message: `Update seller data for ${updatedSeller.name}`,
                        content: content,
                        sha: fileData.sha
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Update error:', errorData);
                    throw new Error(`Update failed: ${response.status} ${response.statusText}`);
                }

                successText.textContent = 'Changes saved successfully!';
                successText.classList.remove('error');
                successText.classList.add('success');
                successBox.classList.remove('error');
            } catch (error) {
                console.error('Detailed error:', error);
                successText.textContent = `Error: ${error.message}. Check console for details.`;
                successBox.classList.add('error');
                successText.classList.add('error');
                successBox.style.display = 'block';
                setTimeout(() => {
                    successBox.style.display = 'none';
                }, 3000); 
            } finally {
                saveButton.disabled = false;
                saveButton.classList.remove('button-loading');
                saveButton.textContent = 'Save Changes';
                successBox.classList.remove('error');
                successText.textContent = 'Changes saved. Please wait 20-50 seconds for the changes to take effect.';
                successText.classList.add('success');
                successBox.style.display = 'block';
                setTimeout(() => {
                    successBox.style.display = 'none';
                }, 3000); 
            }
        }
    </script>
</body>
</html>