<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seller Access</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .profile { margin-top: 2em; border: 1px solid #ccc; padding: 1em; width: 400px; }
        .error { color: red; }
        .field { margin-bottom: 10px; }
        .field label { display: inline-block; width: 100px; font-weight: bold; }
        .field input { width: 200px; padding: 3px; }
        .field select { width: 200px; padding: 3px; }
        .button-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h2>Enter Access Code</h2>
    <input type="text" id="accessCodeInput" placeholder="Access Code">
    <button onclick="checkAccessCode()">Submit</button>
    <div id="result"></div>

    <script>
        let allSellers = [];
        let currentAccessCode = '';

        async function checkAccessCode() {
            const [sellerRes] = await Promise.all([
                fetch('ranksellers/ranksellers.txt')
            ]);
            const sellerData = await sellerRes.text();
            allSellers = JSON.parse(sellerData);
            const code = document.getElementById('accessCodeInput').value.trim();
            currentAccessCode = code;
            const seller = allSellers.find(s => s["access-code"] === code.toUpperCase());
            const resultDiv = document.getElementById('result');
            if (seller) {
                resultDiv.innerHTML = `
                    <div class="profile">
                        <div class="field">
                            <label>Name:</label>
                            <input type="text" id="name" value="${seller.name}">
                        </div>
                        <div class="field">
                            <label>Discord:</label>
                            <input type="text" id="discord" value="${seller.discord}">
                        </div>
                        <div class="field">
                            <label>Rank:</label>
                            <input type="text" id="rank" value="${seller.rank}">
                        </div>
                        <div class="field">
                            <label>Status:</label>
                            <select id="status">
                                <option value="Selling" ${seller.status === 'Selling' ? 'selected' : ''}>Selling</option>
                                <option value="Inactive" ${seller.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="On Leave" ${seller.status === 'On Leave' ? 'selected' : ''}>On Leave</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Timezone:</label>
                            <input type="text" id="timezone" value="${seller.timezone}">
                        </div>
                        <div class="field">
                            <label>Gems:</label>
                            <input type="text" id="gems" value="${seller.gems}">
                        </div>
                        <div class="field">
                            <label>Stock:</label>
                            <input type="text" id="stock" value="${seller.stock}">
                        </div>
                        <div class="field">
                            <label>Sales:</label>
                            <input type="text" id="sales" value="${seller.sales}">
                        </div>
                        <div class="field">
                            <label>Gold:</label>
                            <input type="text" id="gold" value="${seller.gold}">
                        </div>
                        <div class="field">
                            <label>Diamond:</label>
                            <input type="text" id="dia" value="${seller.dia}">
                        </div>
                        <div class="field">
                            <label>Emerald:</label>
                            <input type="text" id="em" value="${seller.em}">
                        </div>
                        <button onclick="saveChanges()" id="saveButton">Save Changes</button>
                    </div>
                    <div><p id="successText"></p></div>
                `;
            } else {
                resultDiv.innerHTML = `<p class="error">Access code not found. Please try again.</p>`;
            }
        }

        async function saveChanges() {
            const token = "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";
            if (!token) {
                alert('GitHub token is not working. Please contact the team to get it fixed.');
                return;
            }
            const saveButton = document.getElementById('saveButton');
            const successText = document.getElementById('successText');
            saveButton.disabled = true; 
            saveButton.classList.add('button-loading');
            saveButton.textContent = 'Saving...';

            try {
                const fileResponse = await fetch('https://api.github.com/repos/CraftersMC-Guides-Project/guides-code/contents/ranksellers/ranksellers.txt', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });

                if (!fileResponse.ok) {
                    const errorData = await fileResponse.text();
                    console.error('File fetch error:', errorData);
                    throw new Error(`GitHub API error: ${fileResponse.status} ${fileResponse.statusText}`);
                }

                const fileData = await fileResponse.json();
                
                // Update seller data
                const index = allSellers.findIndex(s => s["access-code"] === currentAccessCode);
                if (index === -1) {
                    throw new Error('Seller not found in array');
                }

                const updatedSeller = {
                    "access-code": currentAccessCode,
                    name: document.getElementById('name').value,
                    discord: document.getElementById('discord').value,
                    rank: document.getElementById('rank').value,
                    status: document.getElementById('status').value,
                    timezone: document.getElementById('timezone').value,
                    gems: document.getElementById('gems').value,
                    stock: document.getElementById('stock').value,
                    sales: document.getElementById('sales').value,
                    gold: document.getElementById('gold').value,
                    dia: document.getElementById('dia').value,
                    em: document.getElementById('em').value
                };

                allSellers[index] = updatedSeller;
                
                const jsonString = JSON.stringify(allSellers, null, 2);
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonString);
                const content = btoa(String.fromCharCode(...data));
                
                const response = await fetch('https://api.github.com/repos/CraftersMC-Guides-Project/guides-code/contents/ranksellers/ranksellers.txt', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        message: `Update seller data for ${updatedSeller.name}`,
                        content: content,
                        sha: fileData.sha
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Update error:', errorData);
                    throw new Error(`Update failed: ${response.status} ${response.statusText}`);
                }

                successText.textContent = 'Changes saved successfully!';
            } catch (error) {
                console.error('Detailed error:', error);
                successText.textContent = `Error: ${error.message}. Check console for details.`;
            } finally {
                saveButton.disabled = false;
                saveButton.classList.remove('button-loading');
                saveButton.textContent = 'Save Changes';
            }
        }
    </script>
</body>
</html>