<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seller Access</title>
    <head>
    <meta charset="UTF-8">
    <title>Seller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="js/script.js"></script>
    <link rel="stylesheet" href="css/essential.css">
    <link rel="stylesheet" href="css/edit.css">
</head>
<body class="body">
    <div id="loader">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="top"></div>

    <div class="sidebar" id="sidebar"></div>
    <div class="successBox"><p id="successText"></p></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="gap"></div>
    <div class="container">
        <div class="container">
            <h1 class="h1">Seller Profile Editor</h1>
            <h2 class="h2">Enter Access Code</h2>
            <input class="input" type="text" id="seller-edit-accessCodeInput" placeholder="Access Code">
            <button class="button" onclick="checkAccessCode()">Submit</button>
            <div id="result"></div>
            
        </div>
    </div>
    <div id="footer"></div>
    <script>
        let allSellers = [];
        let currentAccessCode = '';
        let id = 0;

        async function checkAccessCode() {
            const [sellerRes] = await Promise.all([
                fetch('ranksellers/ranksellers.txt')
            ]);
            const sellerData = await sellerRes.text();
            allSellers = JSON.parse(sellerData);
            const code = document.getElementById('seller-edit-accessCodeInput').value.trim().toUpperCase();
            currentAccessCode = code;
            const seller = allSellers.find(s => s["access-code"] === code.toUpperCase());
            const resultDiv = document.getElementById('seller-edit-result');
            if (seller) {
                id = seller.id;
                resultDiv.innerHTML = `
                    <div class="seller-edit-profile">
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Name:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-name" value="${seller.name}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Discord:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-discord" value="${seller.discord}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Rank:</label>
                            <select class="seller-edit-select" id="seller-edit-rank">
                                <option value="player" ${seller.rank === 'player' ? 'selected' : ''}></option>
                                <option value="gold" ${seller.rank === 'gold' ? 'selected' : ''}>Gold</option>
                                <option value="diamond" ${seller.rank === 'diamond' ? 'selected' : ''}>Diamond</option>
                                <option value="emerald" ${seller.rank === 'emerald' ? 'selected' : ''}>Emerald</option>
                                <option value="trainee" ${seller.rank === 'trainee' ? 'selected' : ''}>Trainee</option>
                                <option value="helper" ${seller.rank === 'helper' ? 'selected' : ''}>Helper</option>
                                <option value="mod" ${seller.rank === 'mod' ? 'selected' : ''}>Mod</option>
                                <option value="srmod" ${seller.rank === 'srmod' ? 'selected' : ''}>Senior Mod</option>
                                <option value="admin" ${seller.rank === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Status:</label>
                            <select class="seller-edit-select" id="seller-edit-status">
                                <option value="Selling" ${seller.status === 'Selling' ? 'selected' : ''}>Selling</option>
                                <option value="Inactive" ${seller.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="Paused" ${seller.status === 'Paused' ? 'selected' : ''}>Paused</option>
                            </select>
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Timezone:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-timezone" value="${seller.timezone}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Gems price (put N/A if you aren't selling):</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-gems" value="${seller.gems}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Gems Status:</label>
                            <select class="seller-edit-select" id="seller-edit-gemStatus">
                                <option value="Yes" ${seller.gemStatus === 'Yes' ? 'selected' : ''}>Yes</option>
                                <option value="No" ${seller.gemStatus === 'No' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Stock:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-stock" value="${seller.stock}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Sales:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-sales" value="${seller.sales}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Gold:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-gold" value="${seller.gold}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Diamond:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-dia" value="${seller.dia}">
                        </div>
                        <div class="seller-edit-field">
                            <label class="seller-edit-label">Emerald:</label>
                            <input class="seller-edit-input" type="text" id="seller-edit-em" value="${seller.em}">
                        </div>
                        <button class="seller-edit-button" onclick="saveChanges()" id="seller-edit-saveButton">Save Changes</button>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<p class="seller-edit-error">Access code not found. Please try again.</p>`;
            }
        }

        async function saveChanges() {
            const token = "gg not safe";
            if (!token) {
                alert('GitHub token is not working. Please contact the team to get it fixed.');
                return;
            }
            const saveButton = document.getElementById('seller-edit-saveButton');
            const successText = document.getElementById('seller-edit-successText');
            const successBox = document.querySelector('.successBox');
            successText.textContent = '';
            saveButton.disabled = true; 
            saveButton.classList.add('button-loading');
            saveButton.textContent = 'Saving...';

            try {
                const fileResponse = await fetch('https://api.github.com/repos/CraftersMC-Guides-Project/guides-code/contents/ranksellers/ranksellers.txt', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });

                if (!fileResponse.ok) {
                    const errorData = await fileResponse.text();
                    console.error('File fetch error:', errorData);
                    throw new Error(`GitHub API error: ${fileResponse.status} ${fileResponse.statusText}`);
                }

                const fileData = await fileResponse.json();
                
                // Update seller data
                const index = allSellers.findIndex(s => s["access-code"] === currentAccessCode);
                if (index === -1) {
                    throw new Error('Seller not found in array');
                }

                const updatedSeller = {
                    id: id,
                    name: document.getElementById('seller-edit-name').value,
                    discord: document.getElementById('seller-edit-discord').value,
                    rank: document.getElementById('seller-edit-rank').value,
                    status: document.getElementById('seller-edit-status').value,
                    timezone: document.getElementById('seller-edit-timezone').value,
                    gems: document.getElementById('seller-edit-gems').value.toUpperCase(),
                    gemStatus: document.getElementById('seller-edit-gemStatus').value,
                    stock: document.getElementById('seller-edit-stock').value,
                    sales: document.getElementById('seller-edit-sales').value,
                    gold: document.getElementById('seller-edit-gold').value.toUpperCase(),
                    dia: document.getElementById('seller-edit-dia').value.toUpperCase(),
                    em: document.getElementById('seller-edit-em').value.toUpperCase(),
                    "access-code": currentAccessCode.toUpperCase()
                };

                allSellers[index] = updatedSeller;
                
                const jsonString = JSON.stringify(allSellers, null, 2);
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonString);
                const content = btoa(String.fromCharCode(...data));
                
                const response = await fetch('https://api.github.com/repos/CraftersMC-Guides-Project/guides-code/contents/ranksellers/ranksellers.txt', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        message: `Update seller data for ${updatedSeller.name}`,
                        content: content,
                        sha: fileData.sha
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Update error:', errorData);
                    throw new Error(`Update failed: ${response.status} ${response.statusText}`);
                }

                successText.textContent = 'Changes saved successfully!';
                successText.classList.remove('error');
                successText.classList.add('success');
                successBox.classList.remove('error');
            } catch (error) {
                console.error('Detailed error:', error);
                successText.textContent = `Error: ${error.message}. Check console for details.`;
                successBox.classList.add('error');
                successText.classList.add('error');
                successBox.style.display = 'block';
                setTimeout(() => {
                    successBox.style.display = 'none';
                }, 3000); 
            } finally {
                saveButton.disabled = false;
                saveButton.classList.remove('button-loading');
                saveButton.textContent = 'Save Changes';
                successBox.classList.remove('error');
                successText.textContent = 'Changes saved. Please wait 20-50 seconds for the changes to take effect.';
                successText.classList.add('success');
                successBox.style.display = 'block';
                setTimeout(() => {
                    successBox.style.display = 'none';
                }, 3000); 
            }
        }
    </script>
</body>
</html>