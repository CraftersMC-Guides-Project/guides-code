<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    .top { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    #top-right-ui-container { position: fixed; top: 80px; right: 2...lex; flex-direction: column; align-items: flex-end; gap: 10px; }
    .profile-card { display: flex; align-items: center; gap: 10p...ite; text-decoration: none; transition: background-color 0.3s; }
    .profile-card:hover { background-color: rgba(0, 0, 0, 0.8); }
    .profile-card-avatar { width: 32px; height: 32px; border-radius: 50%; }
    .profile-card-name { font-weight: 500; font-size: 14px; }
    .dev-label { color: #ff4d4d; font-weight: bold; margin-left: 5px; }
    .login-btn { background-color: #5865F2; color: white; paddin...ont-weight: 500; display: flex; align-items: center; gap: 8px; }
    .dev-btn { background-color: #313131; color: #FFFFFF; paddin...gn-items: center; gap: 8px; transition: background-color 0.2s; }
    .dev-btn:hover { background-color: #424242; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 10...; align-items: center; justify-content: center; z-index: 9998; }
    .modal-content { background: #2a2a2a; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid #444; }
    .modal-content h3 { margin-top: 0; }
    .modal-content input { width: 100%; padding: 10px; box-sizing: border-box; margin: 10px 0 16px; border: 1px solid #444; border-radius: 6px; background: #1f1f1f; color: #fff; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .modal-btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .modal-btn-save { background-color: #28a745; color: white; }
    .modal-btn-cancel { background-color: #6c757d; color: white; }
    .toggle-switch-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left:... background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20... background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(22px); }
    .toast-notification { position: fixed; bottom: -100px; left:...ght: 500; transition: bottom 0.5s ease-in-out; z-index: 10001; }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
    .private-item-highlight { border: 2px dashed #ff9800; backgr...0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px; }
    @media (max-width: 768px) { #top-right-ui-container { top: 6...card-avatar { width: 28px; height: 28px; } .profile-card-name { 
  </style>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>
  <div id="top-right-ui-container"></div>

  <div class="top">
    <button class="sidebar-toggle" onclick="toggleSidebar()">
      <span class="material-icons">menu</span>
    </button>
  </div>

  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="material-icons" id="scrollToTopBtn">north</span>

  <div class="container">
    <h1 id="itemName"></h1>
    <div id="itemDetails"></div>

    <div id="itemNavigation" style="margin-top: 16px; display:flex; gap:10px;">
      <button id="prevItemBtn" class="btn" type="button">&larr; Previous</button>
      <button id="nextItemBtn" class="btn" type="button">Next &rarr;</button>
    </div>
  </div>
  <div id="footer"></div>

  <!-- Update Price Modal -->
  <div id="price-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>Update Item Details</h3>
        <label for="marketPriceInput">Market Price:</label>
        <input type="number" id="marketPriceInput" placeholder="Enter new market price">
        <label for="npcPriceInput">NPC Trade Price:</label>
        <input type="number" id="npcPriceInput" placeholder="Enter new NPC price">
        <div class="toggle-switch-container">
            <span>Public Status:</span>
            <label class="switch"><input type="checkbox" id="publicStatusToggle"><span class="slider"></span></label>
        </div>
        <div class="modal-actions">
          <button id="cancel-price-update" class="modal-btn modal-btn-cancel">Cancel</button>
          <button id="save-price-update" class="modal-btn modal-btn-save">Save Changes</button>
        </div>
    </div>
  </div>

  <script>
    const GITHUB_REPO = "CraftersMC-Guides-Project/guides-code";
    const MARKET_FILE_PATH = "market/market.txt";
    const PRICES_FILE_PATH = "market/mprices.txt";
    const GITHUB_BRANCH = "main";
    let isDevUser = false;
    let allItems = [];

    function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift()); return ''; }

    async function loadProfileCard() {
      const storedUser = getCookie("discordUser");
      let devIds = [];
      try {
        const response = await fetch('/devs.txt');
        if (response.ok) {
          const text = await response.text();
          devIds = text.split('\n').map(i => i.trim()).filter(Boolean);
        }
      } catch (e) {}

      const profile = document.getElementById("top-right-ui-container");
      if (storedUser) {
        const user = JSON.parse(storedUser);
        const displayName = user.global_name || user.username;
        isDevUser = devIds.includes(user.id);
        profile.innerHTML = `
          <a href="/profile" class="profile-card">
            <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" class="profile-card-avatar">
            <span class="profile-card-name">${displayName}${isDevUser ? '<span class="dev-label">[DEV]</span>' : ''}</span>
          </a>`;
      } else {
        profile.innerHTML = `
          <a href="/login" class="login-btn">
            <span class="material-icons">login</span>Login
          </a>`;
      }
    }

    async function fetchAllItems() {
      try {
        const res = await fetch('market/market.txt');
        allItems = await res.json();
      } catch (e) {
        console.error("Could not fetch market.txt", e);
      }
    }

    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');
      if (itemId) {
        try {
          const [marketRes, pricesRes] = await Promise.all([fetch('market/market.txt'), fetch('market/mprices.txt')]);
          const marketData = await marketRes.text();
          const pricesData = await pricesRes.text();
          const items = JSON.parse(marketData);
          const item = items.find(item => item.id === itemId);
          if (item) {
            const isPublic = item.hasOwnProperty("public") ? item.public : true;
            if (!isPublic && !isDevUser) { document.getElementById("itemName").innerText = "Item"; document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`; document.getElementById("dev-actions-container").innerHTML = ""; return; }
            if (isDevUser) { document.getElementById("dev-actions-container").innerHTML = `<button class="dev-btn" onclick="openUpdateModal()"><span class="material-icons">edit</span>Edit Details</button>`; }
            const pricesMap = new Map(); const npcPricesMap = new Map();
            pricesData.split('\n').forEach(line => { const [id, arrayStr] = line.split(':').map(part => part.trim()); if (id && arrayStr) { try { const parsedArray = JSON.parse(arrayStr.indexOf('[') === 0 ? arrayStr : `[${arrayStr}]`); if (Array.isArray(parsedArray)) { if (parsedArray.length > 1) { pricesMap.set(id, parsedArray[1]); } if (parsedArray.length > 2) { npcPricesMap.set(id, parsedArray[2]); } } } catch (e) {} } });
            const marketPrice = pricesMap.get(item.id) ?? item.price ?? "N/A";
            const npcPrice = npcPricesMap.has(item.id) ? npcPricesMap.get(item.id) : null;
            let privateHighlight = (isDevUser && !isPublic) ? `<div class='private-item-highlight'>PRIVATE ITEM (Visible only to Devs)</div>` : '';
            document.getElementById('itemName').innerText = item.name;
            document.getElementById('itemDetails').innerHTML = `
              ${privateHighlight}
              <div class="category-item-card">
                <h2>${item.name}</h2>
                <img src="${item.picture}" alt="${item.name}" class="category-image">
                <p class="category-id">ID: ${item.id}</p>
                ${item.description ? `<p class="category-description">${item.description}</p>` : ``}
                <div class="category-rarity-display">
                  ${item.rarity ? `<img src="img/rarity/${item.rarity}.webp" class="category-rarity" alt="${item.rarity}">` : ``}
                </div>
                ${item.nature ? `<p class="category-nature">Nature: ${item.nature}</p>` : ``}
                ${item.demand ? `<p class="category-demand">Demand: ${item.demand}</p>` : ``}
                <p class="category-price"><strong>Market price:</strong> ${formatPrice(marketPrice)}</p>
                ${npcPrice !== null && npcPrice !== undefined ? `<p class="category-price"><strong>NPC Trade Price:</strong> ${formatPrice(npcPrice)}</p>` : ``}
              </div>`;
          } else {
            document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`;
          }
        } catch (error) {
          console.error('Error loading item details:', error);
          document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: Could not load item details.</h2>`;
        }
      }
    }

    function formatPrice(price) {
      if (price === "N/A" || price === null || price === undefined || price === "") return `<span>N/A</span>`;
      return `<span>${Number(price).toLocaleString()} <img src="img/coin.png"></span>`;
    }

    // Prev/Next navigation (kept exactly as-is)
    function goToPrevItem() {
      const params = new URLSearchParams(window.location.search);
      const currentId = params.get('item');
      let prevId = Number(currentId) - 1;
      if (isDevUser) {
        if (prevId > 0) { window.location.href = `item.html?item=${prevId}`; }
      } else {
        while (prevId > 0) {
          const prevItem = allItems.find(i => Number(i.id) === Number(prevId));
          if (prevItem && (prevItem.public === undefined || prevItem.public)) { window.location.href = `item.html?item=${prevId}`; return; }
          prevId--;
        }
      }
    }

    function goToNextItem() {
      const params = new URLSearchParams(window.location.search);
      const currentId = params.get('item');
      let nextId = Number(currentId) + 1;
      if (isDevUser) {
        window.location.href = `item.html?item=${nextId}`;
      } else {
        while (true) {
          const nextItem = allItems.find(i => Number(i.id) === Number(nextId));
          if (nextItem && (nextItem.public === undefined || nextItem.public)) { window.location.href = `item.html?item=${nextId}`; return; }
          nextId++;
        }
      }
    }

    // === Added to fix undefined openUpdateModal and wire modal (no other changes) ===
    function openUpdateModal(){
      var modal = document.getElementById('price-modal');
      if(modal){ modal.style.display = 'flex'; }
    }
    function closeUpdateModal(){
      var modal = document.getElementById('price-modal');
      if(modal){ modal.style.display = 'none'; }
    }
    (function(){
      var cancelBtn = document.getElementById('cancel-price-update');
      if(cancelBtn){ cancelBtn.addEventListener('click', closeUpdateModal); }
      var saveBtn = document.getElementById('save-price-update');
      if(saveBtn){ saveBtn.addEventListener('click', closeUpdateModal); }
      var overlay = document.getElementById('price-modal');
      if(overlay){ overlay.addEventListener('click', function(e){ if(e.target === overlay){ closeUpdateModal(); } }); }
    })();
    // === End fix ===

    document.getElementById("prevItemBtn").addEventListener("click", goToPrevItem);
    document.getElementById("nextItemBtn").addEventListener("click", goToNextItem);

    async function initializePage() { await loadProfileCard(); await fetchAllItems(); await loadItemDetails(); }
    initializePage();
  </script>
</body>
</html>
