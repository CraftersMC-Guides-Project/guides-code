<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Item Details</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <div id="top-right-ui-container">
    <div id="profile-card-container"></div>
  </div>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="material-icons" id="scrollToTopBtn">north</span>

  <div class="item-container">
    <div id="item-details"></div>
    <div id="dev-actions-container"></div>
  </div>

  <!-- Modal for updating price -->
  <div id="price-modal" class="modal">
    <div class="modal-content">
      <span id="close-price-modal" class="close">&times;</span>
      <h2>Update Item Details</h2>
      <label for="new-price">Market Price:</label>
      <input type="number" id="new-price" placeholder="Enter new price"><br>
      <label for="new-npc-price">NPC Price:</label>
      <input type="number" id="new-npc-price" placeholder="Enter NPC price"><br>
      <button id="save-price-update" class="btn">Save</button>
      <button id="cancel-price-update" class="btn cancel">Cancel</button>
    </div>
  </div>

  <div id="footer"></div>

  <script>
    let isDevUser = false;

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    async function loadProfileCard() {
      const storedUser = getCookie("discordUser");
      const profileContainer = document.getElementById("profile-card-container");
      let devIds = [];
      try {
        const response = await fetch('/devs.txt');
        if (response.ok) {
          const text = await response.text();
          devIds = text.split('\n').map(id => id.trim()).filter(id => id);
        }
      } catch {}
      if (storedUser) {
        const user = JSON.parse(storedUser);
        const displayName = user.global_name || user.username;
        isDevUser = devIds.includes(user.id);
        profileContainer.innerHTML = `
          <a href="/profile" class="profile-card">
            <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" class="profile-card-avatar">
            <span class="profile-card-name">${displayName}${isDevUser ? '<span class="dev-label">[DEV]</span>' : ''}</span>
          </a>`;
      } else {
        profileContainer.innerHTML = '';
      }
    }

    async function loadItemDetails() {
      const params = new URLSearchParams(window.location.search);
      const itemId = params.get("item");
      if (!itemId) return;

      try {
        const response = await fetch('market/market.txt');
        const items = await response.json();
        const item = items.find(i => String(i.id) === itemId);
        const container = document.getElementById("item-details");

        if (!item) {
          container.innerHTML = "<p>Item not found.</p>";
          return;
        }

        container.innerHTML = `
          <div class="item-card ${item.public === false ? 'private-item-highlight' : ''}">
            <h2>${item.name}</h2>
            <img src="${item.picture}" alt="${item.name}" class="item-image">
            <p>ID: ${item.id}</p>
            <p>Market price: ${item.price || 'N/A'} <img src="img/coin.png" class="coin-inline"></p>
            ${item.npc !== undefined ? `<p>NPC price: ${item.npc} <img src="img/coin.png" class="coin-inline"></p>` : ''}
            ${item.description ? `<p>${item.description}</p>` : ''}
          </div>
        `;

        // Dev-only actions
        if (isDevUser) {
          document.getElementById("dev-actions-container").innerHTML = `
            <button class="dev-btn" onclick="openUpdateModal()">
              <span class="material-icons">edit</span> Edit Details
            </button>`;
        }
      } catch (err) {
        console.error("Error loading item details", err);
      } finally {
        document.getElementById("loader").style.display = "none";
      }
    }

    // Modal functions
    function openUpdateModal() {
      document.getElementById("price-modal").style.display = "flex";
    }

    function closeUpdateModal() {
      document.getElementById("price-modal").style.display = "none";
    }

    document.getElementById("close-price-modal").addEventListener("click", closeUpdateModal);
    document.getElementById("cancel-price-update").addEventListener("click", closeUpdateModal);

    document.getElementById("save-price-update").addEventListener("click", () => {
      // Saving logic goes here
      closeUpdateModal();
      showToast("Changes saved!", "success");
    });

    function showToast(message, type) {
      const toast = document.createElement("div");
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add("show"), 100);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    window.onload = () => {
      loadProfileCard();
      loadItemDetails();
    };
  </script>
</body>
</html>
