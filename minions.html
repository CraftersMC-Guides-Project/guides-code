<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minion Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding: 0;
    }

    h1 {
      color: #d9534f;
    }

    .container {
      width: 80%;
      margin: 0 auto;
      padding: 20px;
    }

    .price-container {
      background-color: #e7e7e7;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .price {
      font-weight: bold;
      color: #5bc0de;
    }

    .attribute-container {
      margin-top: 20px;
    }

    .attribute-box {
      display: inline-block;
      width: 30%;
      background-color: #d9534f;
      padding: 10px;
      margin: 5px;
      color: white;
      text-align: center;
      border-radius: 5px;
    }

    .attribute-box span {
      display: block;
    }

    .rarity-common { background-color: #A9A9A9; }
    .rarity-uncommon { background-color: #28a745; }
    .rarity-rare { background-color: #007bff; }
    .rarity-epic { background-color: #6f42c1; }
    .rarity-legendary { background-color: #d39e00; }

    .back-link {
      margin-top: 20px;
      display: block;
      color: #007bff;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="itemDetails"></div>
    <a class="back-link" href="index.html">Back to Home</a>
  </div>

  <script>
    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const minionId = urlParams.get('minion');  // Checks for 'minion' in the query

      if (minionId) {
        try {
          const [marketRes, pricesRes, minionsRes] = await Promise.all([
            fetch('market/market.txt'),
            fetch('market/mprices.txt'),
            fetch('market/minions.txt')
          ]);

          const marketData = await marketRes.text();
          const pricesData = await pricesRes.text();
          const minionsData = await minionsRes.text();

          const items = JSON.parse(marketData);
          const minions = JSON.parse(minionsData);

          const pricesMap = new Map();
          const npcPricesMap = new Map();

          pricesData.split('\n').forEach(line => {
            const [id, arrayStr] = line.split(':').map(part => part.trim());
            if (id && arrayStr) {
              try {
                const parsedArray = JSON.parse(arrayStr);
                if (Array.isArray(parsedArray) && parsedArray.length >= 2) {
                  pricesMap.set(id, parsedArray[1]);
                  if (parsedArray.length >= 3) {
                    npcPricesMap.set(id, parsedArray[2]);
                  }
                }
              } catch (e) {
                console.warn(`Invalid JSON format in mprices.txt for ID ${id}:`, e);
              }
            }
          });

          // Check if the URL is for a minion
          const minion = minions.find(minion => minion.id === minionId);
          if (minion) {
            const itemDetailsDiv = document.getElementById('itemDetails');
            const tierPrices = Object.keys(minion.tiers).map(tier => {
              const price = minion.tiers[tier];
              return `<p class="price"><strong>Tier ${tier}: </strong>${formatPrice(price)}</p>`;
            }).join('');

            itemDetailsDiv.innerHTML = `
              <h1>${minion.name}</h1>
              ${minion.picture ? `<img src="${minion.picture}" alt="${minion.name}">` : ''}
              <p><strong>ID:</strong> ${minion.id}</p>
              <div class="price-container">
                ${tierPrices}
              </div>
              ${minion.description ? `<p><strong>Description:</strong> ${minion.description}</p>` : ''}
              <p><strong>Category:</strong> ${minion.category}</p>
              ${generateNatureBox(minion.nature)}
              ${generateDemandBox(minion.demand)}
              <div class="attribute-container">
                ${generateAttributeBox('Craftable', minion.craftable)}
                ${generateAttributeBox('Enchantable', minion.enchantable)}
                ${generateAttributeBox('Tradable', minion.tradable)}
                ${generateAttributeBox('Auctionable', minion.auctionable)}
                ${generateAttributeBox('Bazaarable', minion.bazaarable)}
                ${generateAttributeBox('Reforgable', minion.reforgable)}
              </div>
            `;

            applyRarityBackgroundColor(minion.rarity); // Even if no rarity is there, this function will do nothing.
          } else {
            document.getElementById('itemDetails').innerHTML = '<p>Minion not found.</p> <a href="index.html">Back to Home</a>';
          }
        } catch (error) {
          console.error('Error loading item details:', error);
          document.getElementById('itemDetails').innerHTML = '<p>Failed to load item details.</p> <a href="index.html">Back to Home</a>';
        }
      } else {
        document.getElementById('itemDetails').innerHTML = '<p>No minion ID specified.</p> <a href="index.html">Back to Home</a>';
      }
    }

    function formatPrice(price) {
      return price.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD'
      });
    }

    function generateAttributeBox(attribute, value) {
      return `<div class="attribute-box">${attribute}: <span>${value ? 'Yes' : 'No'}</span></div>`;
    }

    function generateNatureBox(nature) {
      return nature ? `<div><strong>Nature:</strong> ${nature}</div>` : '';
    }

    function generateDemandBox(demand) {
      return demand ? `<div><strong>Demand:</strong> ${demand}</div>` : '';
    }

    function applyRarityBackgroundColor(rarity) {
      // If no rarity is specified, skip setting the class
      if (rarity) {
        const rarityClassMap = {
          common: 'rarity-common',
          uncommon: 'rarity-uncommon',
          rare: 'rarity-rare',
          epic: 'rarity-epic',
          legendary: 'rarity-legendary'
        };
        const rarityClass = rarityClassMap[rarity] || '';
        document.querySelector('h1').classList.add(rarityClass);
      }
    }

    // Call the loadItemDetails function when the page loads
    window.onload = loadItemDetails;
  </script>
</body>
</html>
