<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pet Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="css/essential.css">
  <link rel="stylesheet" href="css/item.css">
</head>

<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="navbar"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay"></div>
  <button id="scrollToTopBtn"><span class="material-icons">north</span></button>

  <div class="item-container" id="itemDetails">
    <p>Loading pet details...</p>
  </div>

  <div id="footer"></div>

  <script>
    async function loadPetDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const petId = urlParams.get('pet');

      if (petId) {
        try {
          const [petsRes, pricesRes] = await Promise.all([
            fetch('market/pets.txt'),
            fetch('market/pets-price.txt')
          ]);

          const petsData = await petsRes.text();
          const pricesData = await pricesRes.text();

          const pets = JSON.parse(petsData);
          const pet = pets.find(p => p.id === petId);

          const pricesMap = new Map();

          pricesData.split('\n').forEach(line => {
            const [id, arrayStr] = line.split(':').map(part => part.trim());
            if (id && arrayStr) {
              try {
                const parsedArray = JSON.parse(arrayStr);
                if (Array.isArray(parsedArray) && parsedArray.length === 6) {
                  pricesMap.set(id, parsedArray);
                }
              } catch (e) {
                console.warn(`Invalid JSON in pets-price.txt for ID ${id}:`, e);
              }
            }
          });

          if (pet) {
            const petDetailsDiv = document.getElementById('itemDetails');
            const allRarities = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
            const availableRarities = (pet.rarity || []).map(r => r.toLowerCase());
            const prices = pricesMap.get(pet.id) || [pet.id, 0, 0, 0, 0, 0];
            let selectedRarity = availableRarities[0] || 'common';

            function render() {
              const rarityButtons = allRarities.map((rarity, index) => {
                const isAvailable = availableRarities.includes(rarity);
                return `
                  <button class="rarity-btn ${selectedRarity === rarity ? 'active' : ''}" 
                          data-index="${index}" 
                          ${isAvailable ? '' : 'disabled'}>
                    ${capitalize(rarity)}
                  </button>`;
              }).join('');

              petDetailsDiv.innerHTML = `
                <h1>${pet.name}</h1>
                ${pet.picture ? `<img src="${pet.picture}" alt="${pet.name}">` : ''}
                <div class="rarity-buttons">${rarityButtons}</div>
                <p><strong>ID:</strong> ${pet.id}</p>
                <p><strong>Selected Rarity:</strong> ${capitalize(selectedRarity)}</p>
                <div class="price-container">
                  <p class="price"><strong>Market Price:</strong> ${formatPrice(prices[rarityToIndex(selectedRarity) + 1])}</p>
                </div>
                ${pet.description ? `<p><strong>Description:</strong> ${pet.description}</p>` : ''}
              `;

              document.querySelectorAll('.rarity-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  selectedRarity = allRarities[parseInt(btn.dataset.index)];
                  render();
                });
              });
            }

            function rarityToIndex(r) {
              return allRarities.indexOf(r);
            }

            function capitalize(str) {
              return str.charAt(0).toUpperCase() + str.slice(1);
            }

            function formatPrice(price) {
              if (isNaN(price) || price === 0) return `<span class="price">N/A</span>`;
              return `<span class="price">${Number(price).toLocaleString()} <img src="img/coin.png" alt="Coin"></span>`;
            }

            render();
          } else {
            document.getElementById('itemDetails').innerHTML = '<p>Pet not found.</p> <a href="index.html">Back to Home</a>';
          }
        } catch (error) {
          console.error('Error loading pet details:', error);
          document.getElementById('itemDetails').innerHTML = '<p>Failed to load pet details.</p> <a href="index.html">Back to Home</a>';
        }
      } else {
        document.getElementById('itemDetails').innerHTML = '<p>No pet ID specified.</p> <a href="index.html">Back to Home</a>';
      }
    }

    loadPetDetails();
  </script>

  <script src="js/script.js"></script>

  <style>
    .rarity-buttons {
      margin: 15px 0;
    }

    .rarity-btn {
      padding: 6px 12px;
      margin: 0 5px 10px 0;
      border: none;
      border-radius: 6px;
      background-color: #444;
      color: white;
      cursor: pointer;
    }

    .rarity-btn.active {
      background-color: crimson;
    }

    .rarity-btn:disabled {
      background-color: #777;
      cursor: not-allowed;
    }
  </style>
</body>
</html>
