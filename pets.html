<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pet Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    /* Profile + Button */
    #top-right-ui-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }
    .profile-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 50px;
      color: white;
      text-decoration: none;
    }
    .profile-card-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    .profile-card-name { font-weight: 500; font-size: 14px; }
    .role-btn {
      background: #5865F2;
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .role-btn:hover { background: #4752C4; }

    /* Modal */
    .modal-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.7); display:none;
      align-items:center; justify-content:center; z-index:2000;
    }
    .modal-content {
      background:#2a2a2a; color:white;
      padding:20px; border-radius:12px;
      width:90%; max-width:420px;
      max-height:80vh; overflow-y:auto;
    }
    .modal-content h3 { margin-top:0; text-align:center; }
    .modal-content label { display:block; margin:6px 0 2px; }
    .modal-content input {
      width:100%; padding:8px;
      border-radius:6px; border:1px solid #555;
      background:#1a1a1a; color:white;
    }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .modal-btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; }
    .modal-btn-save { background:#28a745; color:white; }
    .modal-btn-cancel { background:#6c757d; color:white; }

    /* Toast */
    .toast {
      position: fixed; bottom:-100px; left:50%; transform:translateX(-50%);
      padding:12px 20px; border-radius:8px; color:white; font-weight:500;
      transition:bottom .4s; z-index:3000;
    }
    .toast.show { bottom:30px; }
    .toast.success { background:#2d8831; }
    .toast.error { background:#c62828; }
  </style>
</head>

<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <div id="top-right-ui-container">
    <div id="profile-card-container"></div>
    <div id="role-btn-container"></div>
  </div>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <button id="float">
    <span class="material-icons" id="sweepBtn" style="background:#222;border-radius:50px;">chevron_right</span>
    <span class="material-icons" id="homeBtn" onclick="homeBtn()">home</span>
    <span class="material-icons" id="ai" onclick="aiBtn()">smart_toy</span>
    <span class="material-icons" id="scrollToTopBtn">north</span>
  </button>

  <div class="pet-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn pet-filter-btn" data-nature="reset">Reset Filter</button>
  </div>

  <div class="pet-item-container" id="petDetails"><p>Loading pet details...</p></div>
  <div class="pet-nav-buttons">
    <button id="prevPetBtn" class="btn">&larr; Previous</button>
    <button id="nextPetBtn" class="btn">Next &rarr;</button>
  </div>
  <div id="footer"></div>

  <!-- Modal -->
  <div id="price-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Update Pet Prices</h3>
      <div id="price-inputs"></div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn modal-btn-save" onclick="savePrices()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const PETS_FILE = "market/pets.txt";
    const PRICES_FILE = "market/pet-prices.txt";
    let allPets = [], petPrices = [], filteredPets = [], currentPetIndex = 0, currentPetRarities = [], currentRarityIndex=0;

    function getCookie(name){
      const value=`; ${document.cookie}`;
      const parts=value.split(`; ${name}=`);
      if(parts.length===2) return decodeURIComponent(parts.pop().split(';').shift());
      return '';
    }

    async function loadProfile(){
      const container=document.getElementById("profile-card-container");
      const btnContainer=document.getElementById("role-btn-container");
      try{
        const stored=getCookie("discordUser"); if(!stored) return;
        const user=JSON.parse(stored);
        container.innerHTML=`<a href="/profile.html" class="profile-card">
          <img src="https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png" class="profile-card-avatar">
          <span class="profile-card-name">${user.global_name||user.username}</span></a>`;
        const res=await fetch(`https://discord-auth.roumakdatta.workers.dev/users/${user.id}`);
        if(!res.ok) return; const full=await res.json();
        const role=full.role?full.role.toLowerCase():"";
        if(["dev","manager","data manager"].includes(role)){
          btnContainer.innerHTML=`<button class="role-btn" onclick="openModal()"><span class="material-icons">edit</span> Change Price</button>`;
        }
      }catch(e){console.error(e);}
    }

    async function loadData(){
      const [petsRes, pricesRes]=await Promise.all([fetch(PETS_FILE), fetch(PRICES_FILE)]);
      allPets=await petsRes.json(); petPrices=await pricesRes.json();
      const url=new URLSearchParams(window.location.search);
      const petId=url.get("pet"); const nature=url.get("nature")||"all";
      filteredPets=(nature==="all"||nature==="reset")?allPets:allPets.filter(p=>p.nature&&p.nature.toUpperCase().includes(nature.toUpperCase()));
      currentPetIndex=filteredPets.findIndex(p=>p.id===petId);
      if(currentPetIndex<0&&filteredPets.length){currentPetIndex=0;window.history.replaceState({},'',`?pet=${filteredPets[0].id}&nature=${nature}`);}
      renderPet();
    }

    function renderPet(){
      const pet=filteredPets[currentPetIndex]; if(!pet){document.getElementById("petDetails").innerHTML="<p>Pet not found.</p>";return;}
      const rarity=pet.rarity[0]; currentPetRarities=pet.rarity; currentRarityIndex=0;
      document.getElementById("petDetails").innerHTML=`
        <div class="item-container">
          <h1>${pet.name}</h1>
          <img src="${pet.picture}" class="pet-item-image">
          <div class="pet-rarity-dropdown">
            <button class="pet-rarity-arrow" onclick="changeRarity(-1,'${pet.id}')"><span class="material-icons">chevron_left</span></button>
            <div id="selectedRarity"><img src="/img/rarity/${rarity}.webp" style="height:24px;"></div>
            <button class="pet-rarity-arrow" onclick="changeRarity(1,'${pet.id}')"><span class="material-icons">chevron_right</span></button>
          </div>
          <div id="petPrice"></div>
          <p><strong>ID:</strong> ${pet.id}</p>
          <p><strong>Category:</strong> ${pet.category}</p>
          <p><strong>Description:</strong> ${pet.description||'No description available'}</p>
        </div>`;
      updatePrice(pet.id,rarity);
    }

    function updatePrice(petId,rarity){
      const data=petPrices.find(p=>p.petId===petId)||{};
      const m=data[rarity.toLowerCase()]??"N/A"; const n=data["n"+rarity.toLowerCase()]??"N/A";
      document.getElementById("petPrice").innerHTML=`
        <div><strong>Market Price:</strong> ${formatPrice(m)}</div>
        <div><strong>NPC Price:</strong> ${formatPrice(n)}</div>`;
      document.getElementById("selectedRarity").innerHTML=`<img src="/img/rarity/${rarity}.webp" style="height:24px;">`;
    }
    function formatPrice(v){return(v==="N/A")?v:`${Number(v).toLocaleString()} <img src="img/coin.png">`;}
    function changeRarity(dir,petId){currentRarityIndex=(currentRarityIndex+dir+currentPetRarities.length)%currentPetRarities.length;updatePrice(petId,currentPetRarities[currentRarityIndex]);}

    function openModal(){
      const pet=filteredPets[currentPetIndex]; const price=petPrices.find(p=>p.petId===pet.id)||{};
      const rarities=["common","uncommon","rare","epic","legendary"];
      const container=document.getElementById("price-inputs"); container.innerHTML="";
      rarities.forEach(r=>{
        container.innerHTML+=`<label>${r.charAt(0).toUpperCase()+r.slice(1)} Market Price:</label><input type="number" id="${r}" value="${price[r]||''}">`;
        container.innerHTML+=`<label>${r.charAt(0).toUpperCase()+r.slice(1)} NPC Price:</label><input type="number" id="n${r}" value="${price["n"+r]||''}">`;
      });
      document.getElementById("price-modal").style.display="flex";
    }
    function closeModal(){document.getElementById("price-modal").style.display="none";}
    async function savePrices(){
      try{
        const stored=getCookie("discordUser"); if(!stored){toast("Not logged in","error");return;}
        const user=JSON.parse(stored); const pet=filteredPets[currentPetIndex]; const rarities=["common","uncommon","rare","epic","legendary"];
        const nums=[]; rarities.forEach(r=>nums.push(document.getElementById(r).value||0)); rarities.forEach(r=>nums.push(document.getElementById("n"+r).value||0));
        const url=`https://data-manager.roumakdatta.workers.dev/pets/${user.id}/${pet.id}/${nums.join("/")}`;
        const res=await fetch(url); const data=await res.json();
        if(res.ok&&(!data.success||data.success)){toast("✅ Prices updated!","success");closeModal();setTimeout(()=>location.reload(),1000);}
        else toast("❌ Error: "+(data?.message||res.status),"error");
      }catch(e){console.error(e);toast("Unexpected error","error");}
    }

    function toast(msg,type){const t=document.createElement("div");t.className=`toast ${type}`;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.classList.add("show"),100);setTimeout(()=>{t.classList.remove("show");setTimeout(()=>t.remove(),400);},3000);}

    document.getElementById("prevPetBtn").onclick=()=>{if(filteredPets.length<2)return;currentPetIndex=(currentPetIndex-1+filteredPets.length)%filteredPets.length;const n=new URLSearchParams(window.location.search).get("nature")||"all";window.location.search=`?pet=${filteredPets[currentPetIndex].id}&nature=${n}`;}
    document.getElementById("nextPetBtn").onclick=()=>{if(filteredPets.length<2)return;currentPetIndex=(currentPetIndex+1)%filteredPets.length;const n=new URLSearchParams(window.location.search).get("nature")||"all";window.location.search=`?pet=${filteredPets[currentPetIndex].id}&nature=${n}`;}
    document.querySelector('.pet-filter-btn[data-nature="reset"]').onclick=()=>{if(allPets.length)window.location.search=`?pet=${allPets[0].id}&nature=all`;}

    (async()=>{await loadProfile();await loadData();})();
  </script>
</body>
</html>
