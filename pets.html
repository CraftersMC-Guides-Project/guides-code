<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pet Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; transition: bottom 0.5s ease-in-out; z-index: 10001; }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
    .profile-card {
      position: fixed; top: 80px; right: 20px; z-index: 1001;
      display: none; align-items: center; gap: 15px;
      background: linear-gradient(135deg, rgba(40, 40, 40, 0.7), rgba(25, 25, 25, 0.8));
      backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 50px; color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15);
      min-width: 200px;
    }
    .role-action-btn {
      position: fixed; top: 148px; right: 20px;
      padding: 9px 14px; font-size: 13px; font-weight: 700;
      border-radius: 10px; background: linear-gradient(135deg, #5865F2, #4752C4);
      color: #fff; border: none; cursor: pointer; z-index: 1001;
      display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    #price-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
    }
    #price-modal .modal-content {
      background: #1e1e1e; padding: 20px; border-radius: 12px;
      width: 400px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      max-height: 90vh; overflow-y: auto;
    }
    #price-modal h2 { margin-bottom: 10px; font-size: 20px; text-align:center; }
    #price-modal h3 { margin: 15px 0 10px; font-size: 16px; border-bottom: 1px solid #444; padding-bottom: 5px; }
    .price-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .price-grid label { font-weight: 600; font-size: 14px; margin-bottom: 4px; display: block; }
    .price-grid input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #444; background:#2a2a2a; color:white; }
    #price-modal .btn-submit {
      margin-top: 15px; width: 100%; padding: 10px;
      border: none; border-radius: 8px; background: #5865F2;
      color: white; font-weight: bold; cursor: pointer;
    }
    #price-modal .btn-close {
      background: none; border: none; color: white; font-size: 20px; float: right; cursor: pointer;
    }
    .rarity-label { display:flex; align-items:center; gap:6px; }
    .rarity-label img { height:18px; }
  </style>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <!-- Profile -->
  <a href="/profile.html" class="profile-card" id="profile-card">
    <img id="user-avatar" src="https://placehold.co/110x110" alt="User Avatar" />
    <div id="user-details"><div id="user-name">Loading...</div><div id="user-tag"></div></div>
  </a>
  <div id="role-btn-container"></div>

  <!-- Modal -->
  <div id="price-modal">
    <div class="modal-content">
      <button class="btn-close" onclick="closePriceModal()">×</button>
      <h2 id="modal-pet-name">Pet Name</h2>

      <h3>Market Prices</h3>
      <div class="price-grid">
        <div><label class="rarity-label"><img src="img/rarity/common.webp"> Common</label><input type="number" id="common-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/uncommon.webp"> Uncommon</label><input type="number" id="uncommon-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/rare.webp"> Rare</label><input type="number" id="rare-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/epic.webp"> Epic</label><input type="number" id="epic-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/legendary.webp"> Legendary</label><input type="number" id="legendary-price" /></div>
      </div>

      <h3>NPC Prices</h3>
      <div class="price-grid">
        <div><label class="rarity-label"><img src="img/rarity/common.webp"> Common NPC</label><input type="number" id="ncommon-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/uncommon.webp"> Uncommon NPC</label><input type="number" id="nuncommon-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/rare.webp"> Rare NPC</label><input type="number" id="nrare-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/epic.webp"> Epic NPC</label><input type="number" id="nepic-price" /></div>
        <div><label class="rarity-label"><img src="img/rarity/legendary.webp"> Legendary NPC</label><input type="number" id="nlegendary-price" /></div>
      </div>

      <button class="btn-submit" onclick="submitPriceModal()">💾 Save Changes</button>
    </div>
  </div>

  <!-- Sidebar + Buttons -->
  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <button id="float">
    <span class="material-icons" id="sweepBtn" style="background:#222;border-radius:50px;">chevron_right</span>
    <span class="material-icons" id="homeBtn" onclick="homeBtn()">home</span>
    <span class="material-icons" id="ai" onclick="aiBtn()">smart_toy</span>
    <span class="material-icons" id="scrollToTopBtn">north</span>
  </button>

  <!-- Filters -->
  <div class="pet-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn pet-filter-btn" data-nature="reset">Reset Filter</button>
  </div>

  <!-- Pet Details -->
  <div class="pet-item-container" id="petDetails"><p>Loading pet details...</p></div>
  <div class="pet-nav-buttons">
    <button id="prevPetBtn" class="btn">&larr; Previous</button>
    <button id="nextPetBtn" class="btn">Next &rarr;</button>
  </div>
  <div id="footer"></div>

<script>
  let allPets = [], allPrices = [];

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    return '';
  }

  async function loadUserInfo() {
    const profileCard = document.getElementById('profile-card');
    const roleBtnContainer = document.getElementById('role-btn-container');
    try {
      const storedUserCookie = getCookie('discordUser');
      if (!storedUserCookie) { profileCard.style.display = 'none'; return; }
      const loggedInUser = JSON.parse(storedUserCookie);
      const userId = loggedInUser.id;
      if (!userId) { profileCard.style.display = 'none'; return; }
      const response = await fetch(`https://discord-auth.roumakdatta.workers.dev/users/${userId}`);
      if (!response.ok) { profileCard.style.display = 'none'; return; }
      const user = await response.json();
      profileCard.style.display = 'flex';
      document.getElementById('user-avatar').src = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : "https://placehold.co/110x110";
      document.getElementById('user-name').textContent = user.global_name || user.username || 'Unknown User';
      const roleColors = { dev: '#d50000', manager: '#ffc107', "data manager": '#2962ff' };
      const userRole = user.role ? user.role.toLowerCase() : '';
      if (roleColors[userRole]) {
        document.getElementById('user-tag').textContent = user.role.toUpperCase();
        document.getElementById('user-tag').style.color = roleColors[userRole];
      }
      if (["dev", "manager", "data manager"].includes(userRole)) {
        const btn = document.createElement("button");
        btn.className = "role-action-btn";
        btn.innerHTML = `<span class="material-icons">edit</span> Change Price`;
        btn.addEventListener("click", openPriceModal);
        roleBtnContainer.appendChild(btn);
      }
    } catch (err) { console.error(err); }
  }

  async function loadPetDetails() {
    const [petsRes, pricesRes] = await Promise.all([fetch("market/pets.txt"), fetch("market/pet-prices.txt")]);
    allPets = await petsRes.json();
    allPrices = await pricesRes.json();

    const urlParams = new URLSearchParams(window.location.search);
    const petId = urlParams.get("pet");
    const pet = allPets.find(p => p.id === petId);
    if (pet) {
      document.getElementById('petDetails').innerHTML = `
        <div class="item-container">
          <h1>${pet.name}</h1>
          <img src="${pet.picture}" alt="${pet.name}" class="pet-item-image">
          <p><strong>ID:</strong> ${pet.id}</p>
          <p><strong>Category:</strong> ${pet.category}</p>
          <p><strong>Description:</strong> ${pet.description || 'No description available'}</p>
        </div>`;
      document.getElementById('modal-pet-name').textContent = pet.name;
    }
  }

  function openPriceModal() {
    const urlParams = new URLSearchParams(window.location.search);
    const petId = urlParams.get('pet');
    const petPrice = allPrices.find(p => p.petId === petId) || {};
    document.getElementById('common-price').value = petPrice.common || "";
    document.getElementById('uncommon-price').value = petPrice.uncommon || "";
    document.getElementById('rare-price').value = petPrice.rare || "";
    document.getElementById('epic-price').value = petPrice.epic || "";
    document.getElementById('legendary-price').value = petPrice.legendary || "";
    document.getElementById('ncommon-price').value = petPrice.ncommon || "";
    document.getElementById('nuncommon-price').value = petPrice.nuncommon || "";
    document.getElementById('nrare-price').value = petPrice.nrare || "";
    document.getElementById('nepic-price').value = petPrice.nepic || "";
    document.getElementById('nlegendary-price').value = petPrice.nlegendary || "";
    document.getElementById('price-modal').style.display = 'flex';
  }
  function closePriceModal() { document.getElementById('price-modal').style.display = 'none'; }

  async function submitPriceModal() {
    try {
      const storedUserCookie = getCookie('discordUser');
      if (!storedUserCookie) { showToast("Not logged in", "error"); return; }
      const user = JSON.parse(storedUserCookie);
      const discordId = user.id;
      const urlParams = new URLSearchParams(window.location.search);
      const petId = urlParams.get('pet');
      if (!petId) { showToast("Pet not found", "error"); return; }

      const vals = [
        document.getElementById('common-price').value || 0,
        document.getElementById('uncommon-price').value || 0,
        document.getElementById('rare-price').value || 0,
        document.getElementById('epic-price').value || 0,
        document.getElementById('legendary-price').value || 0,
        document.getElementById('ncommon-price').value || 0,
        document.getElementById('nuncommon-price').value || 0,
        document.getElementById('nrare-price').value || 0,
        document.getElementById('nepic-price').value || 0,
        document.getElementById('nlegendary-price').value || 0
      ];

      const endpoint = `https://data-manager.roumakdatta.workers.dev/pets/${discordId}/${petId}/${vals.join("/")}`;
      const res = await fetch(endpoint);
      const data = await res.json();
      if (data.success) { showToast("✅ Pet prices updated!", "success"); closePriceModal(); }
      else { showToast("❌ Failed: " + (data.response?.message || "Unknown error"), "error"); }
    } catch (err) { console.error(err); showToast("Something went wrong", "error"); }
  }

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
  }

  async function initializePage() { await loadUserInfo(); await loadPetDetails(); }
  initializePage();
</script>
</body>
</html>
