<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pet Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes/minecraft/style.css">
  <script src="js/script.js"></script>
  <style>
    .top { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    .login-btn { background-color: #5865F2; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; transition: bottom 0.5s ease-in-out; z-index: 10001; }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
    .profile-card {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1001;
      display: none;
      align-items: center;
      gap: 15px;
      background: linear-gradient(135deg, rgba(40, 40, 40, 0.7), rgba(25, 25, 25, 0.8));
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-radius: 50px;
      color: white;
      text-decoration: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255, 255, 255, 0.15);
      min-width: 200px;
    }
    #user-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }
    #user-details { text-align: left; }
    #user-name { font-size: 18px; font-weight: 700; line-height: 1.2; }
    #user-tag { font-size: 12px; font-weight: 700; text-transform: uppercase; opacity: 0.9; margin-top: 3px; display: block; letter-spacing: 0.5px; }
    .role-action-btn {
      position: fixed;
      top: 148px;
      right: 20px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 700;
      border-radius: 10px;
      background: linear-gradient(135deg, #5865F2, #4752C4);
      color: #fff;
      border: none !important;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      white-space: nowrap;
    }
    #price-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #price-modal .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 12px;
      width: 360px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      max-height: 90vh;
      overflow-y: auto;
    }
    #price-modal h2 { margin-bottom: 15px; font-size: 20px; }
    #price-modal label { display: block; margin: 10px 0 5px; }
    #price-modal input { width: 100%; padding: 8px; border-radius: 6px; border: none; margin-bottom: 10px; }
    #price-modal .btn-submit {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #5865F2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #price-modal .btn-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      float: right;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <a href="/profile.html" class="profile-card" id="profile-card">
    <img id="user-avatar" src="https://placehold.co/110x110/dddddd/333333?text=...&font=inter" alt="User Avatar" />
    <div id="user-details">
      <div id="user-name">Loading...</div>
      <div id="user-tag"></div>
    </div>
  </a>

  <div id="role-btn-container"></div>

  <!-- Modal -->
  <div id="price-modal">
    <div class="modal-content">
      <button class="btn-close" onclick="closePriceModal()">×</button>
      <h2 id="modal-pet-name">Pet Name</h2>
      <label>Common Price</label><input type="number" id="common-price" />
      <label>Uncommon Price</label><input type="number" id="uncommon-price" />
      <label>Rare Price</label><input type="number" id="rare-price" />
      <label>Epic Price</label><input type="number" id="epic-price" />
      <label>Legendary Price</label><input type="number" id="legendary-price" />
      <hr>
      <label>Common NPC Price</label><input type="number" id="ncommon-price" />
      <label>Uncommon NPC Price</label><input type="number" id="nuncommon-price" />
      <label>Rare NPC Price</label><input type="number" id="nrare-price" />
      <label>Epic NPC Price</label><input type="number" id="nepic-price" />
      <label>Legendary NPC Price</label><input type="number" id="nlegendary-price" />
      <button class="btn-submit" onclick="submitPriceModal()">Submit</button>
    </div>
  </div>

  <div class="pet-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn pet-filter-btn" data-nature="reset">Reset Filter</button>
  </div>

  <div class="pet-item-container" id="petDetails"><p>Loading pet details...</p></div>
  <div class="pet-nav-buttons">
    <button id="prevPetBtn" class="btn" type="button">&larr; Previous</button>
    <button id="nextPetBtn" class="btn" type="button">Next &rarr;</button>
  </div>
  <div id="footer"></div>

<script>
  let allPets = [];
  let isDevUser = false;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    return '';
  }

  async function loadUserInfo() {
    const profileCard = document.getElementById('profile-card');
    const roleBtnContainer = document.getElementById('role-btn-container');
    try {
      const storedUserCookie = getCookie('discordUser');
      if (!storedUserCookie) { profileCard.style.display = 'none'; return; }
      const loggedInUser = JSON.parse(storedUserCookie);
      const userId = loggedInUser.id;
      if (!userId) { profileCard.style.display = 'none'; return; }
      const response = await fetch(`https://discord-auth.roumakdatta.workers.dev/users/${userId}`);
      if (!response.ok) { profileCard.style.display = 'none'; return; }
      const user = await response.json();
      profileCard.style.display = 'flex';
      document.getElementById('user-avatar').src = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : "https://placehold.co/110x110";
      document.getElementById('user-name').textContent = user.global_name || user.username || 'Unknown User';
      const roleColors = { dev: '#d50000', manager: '#ffc107', "data manager": '#2962ff' };
      const userRole = user.role ? user.role.toLowerCase() : '';
      if (roleColors[userRole]) {
        document.getElementById('user-tag').textContent = user.role.toUpperCase();
        document.getElementById('user-tag').style.color = roleColors[userRole];
      }
      if (["dev", "manager", "data manager"].includes(userRole)) {
        const btn = document.createElement("button");
        btn.className = "role-action-btn";
        btn.innerHTML = `<span class="material-icons">edit</span> Change Price`;
        btn.addEventListener("click", openPriceModal);
        roleBtnContainer.appendChild(btn);
      }
    } catch (err) {
      console.error('Error loading user info', err);
    }
  }

  async function loadPetDetails() {
    const res = await fetch("market/pets.txt");
    allPets = await res.json();
    const urlParams = new URLSearchParams(window.location.search);
    const petId = urlParams.get("pet");
    const pet = allPets.find(p => p.id === petId);
    if (pet) {
      document.getElementById('petDetails').innerHTML = `
        <div class="item-container">
          <h1>${pet.name}</h1>
          <img src="${pet.picture}" alt="${pet.name}" class="pet-item-image">
          <p><strong>ID:</strong> ${pet.id}</p>
          <p><strong>Category:</strong> ${pet.category}</p>
          <p><strong>Description:</strong> ${pet.description || 'No description available'}</p>
        </div>`;
      document.getElementById('modal-pet-name').textContent = pet.name;
    } else {
      document.getElementById('petDetails').innerHTML = `<h2 style="color:red;">Error: Pet not found.</h2>`;
    }
  }

  function openPriceModal() { document.getElementById('price-modal').style.display = 'flex'; }
  function closePriceModal() { document.getElementById('price-modal').style.display = 'none'; }

  async function submitPriceModal() {
    try {
      const storedUserCookie = getCookie('discordUser');
      if (!storedUserCookie) { showToast("Not logged in", "error"); return; }
      const user = JSON.parse(storedUserCookie);
      const discordId = user.id;
      const urlParams = new URLSearchParams(window.location.search);
      const petId = urlParams.get('pet');
      if (!petId) { showToast("Pet not found", "error"); return; }

      const vals = [
        document.getElementById('common-price').value || 0,
        document.getElementById('uncommon-price').value || 0,
        document.getElementById('rare-price').value || 0,
        document.getElementById('epic-price').value || 0,
        document.getElementById('legendary-price').value || 0,
        document.getElementById('ncommon-price').value || 0,
        document.getElementById('nuncommon-price').value || 0,
        document.getElementById('nrare-price').value || 0,
        document.getElementById('nepic-price').value || 0,
        document.getElementById('nlegendary-price').value || 0
      ];

      const endpoint = `https://data-manager.roumakdatta.workers.dev/pets/${discordId}/${petId}/${vals.join("/")}`;
      const res = await fetch(endpoint);
      const data = await res.json();

      if (data.success) {
        showToast("✅ Pet prices updated!", "success");
        closePriceModal();
      } else {
        showToast("❌ Failed: " + (data.response?.message || "Unknown error"), "error");
      }
    } catch (err) {
      console.error(err);
      showToast("Something went wrong", "error");
    }
  }

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
  }

  async function initializePage() {
    await loadUserInfo();
    await loadPetDetails();
  }
  initializePage();
</script>
</body>
</html>
